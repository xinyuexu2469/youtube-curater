<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的YouTube频道收藏</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #ff0000;
    --secondary-color: #282828;
    --accent-color: #ff4444;
    --bg-color: #f5f7fa;
    --card-bg: #ffffff;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --border-color: #e1e8ed;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.12);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden; /* 防止水平滚动 */
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 20px;
}

/* 宽屏优化：当屏幕宽度超过1200px时，增加最大宽度 */
@media (min-width: 1200px) {
    .container {
        max-width: 1800px;
        padding: 0 40px;
    }
}

/* 超宽屏优化：当屏幕宽度超过1600px时，进一步优化布局 */
@media (min-width: 1600px) {
    .container {
        max-width: 2000px;
        padding: 0 60px;
    }
    
    /* 已看视频页面在超宽屏下的优化布局 */
    .watched-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
    }
    
    .channel-group {
        max-width: none;
    }
    
    /* 频道编辑页面在超宽屏下的优化 */
    .modal-content {
        max-width: 90vw;
        max-height: 90vh;
    }
    
    .watched-videos {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    
    .add-video-form {
        grid-column: 1 / -1;
    }
    
    /* 频道编辑页面的视频项目也采用垂直布局 */
    .video-item {
        display: flex;
        flex-direction: column;
    }
    
    .video-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e1e8ed;
    }
    
    .video-content {
        padding: 20px;
        width: 100%;
    }
    
    .video-actions {
        padding: 16px 20px;
        border-top: 1px solid #e1e8ed;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: row;
        gap: 8px;
        flex-wrap: nowrap;
        justify-content: flex-end;
        align-items: center;
    }
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 60px 20px;
    text-align: center;
    box-shadow: var(--shadow);
}

.header-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 15px;
    letter-spacing: -1px;
}

.header-subtitle {
    font-size: 1.2rem;
    opacity: 0.95;
    font-weight: 300;
}

.controls {
    background: var(--card-bg);
    padding: 30px 20px;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
}

.search-box {
    margin-bottom: 20px;
}

#searchInput {
    width: 100%;
    padding: 15px 20px;
    font-size: 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    outline: none;
    transition: var(--transition);
    font-family: inherit;
}

#searchInput:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}

.filter-btn {
    padding: 10px 20px;
    border: 2px solid var(--border-color);
    background: white;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: var(--transition);
    font-family: inherit;
    white-space: nowrap;
}

.filter-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.filter-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
}

/* 自定义滚动条样式 */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: #f5f5f5;
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #bbb;
}

.main-content {
    padding: 40px 20px;
}

.category-section {
    margin-bottom: 60px;
}

.category-title {
    font-size: 2rem;
    margin-bottom: 25px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.category-title .star-icon {
    color: #ffd700;
    font-size: 1.5rem;
}

.channels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
}

/* 宽屏优化：增加频道卡片列数 */
@media (min-width: 1200px) {
    .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 30px;
    }
}

@media (min-width: 1600px) {
    .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 35px;
    }
}

.channel-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 25px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.channel-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.channel-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.channel-card:hover::before {
    transform: scaleX(1);
}

.channel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.channel-name {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.channel-region {
    display: inline-block;
    background: #f0f3ff;
    color: #667eea;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 10px;
}

.channel-description {
    color: var(--text-secondary);
    margin-bottom: 15px;
    line-height: 1.7;
    font-size: 0.95rem;
}

.channel-description ul {
    margin-left: 20px;
    margin-top: 8px;
}

.channel-description li {
    margin-bottom: 5px;
}

.channel-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.channel-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: white;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: var(--transition);
    font-size: 0.9rem;
}

.channel-link:hover {
    transform: translateX(3px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.rating {
    display: flex;
    gap: 3px;
}

.rating .star {
    color: #ddd;
    font-size: 1.2rem;
}

.rating .star.filled {
    color: #ffd700;
}

.rating .star.empty {
    color: #e0e0e0;
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state-text {
    font-size: 1.2rem;
}

.footer {
    background: var(--secondary-color);
    color: white;
    text-align: center;
    padding: 30px 20px;
    margin-top: 60px;
}

@media (max-width: 768px) {
    .header-title {
        font-size: 2rem;
    }
    
    .header-subtitle {
        font-size: 1rem;
    }
    
    .channels-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-buttons {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 10px;
    }
    
    .category-title {
        font-size: 1.5rem;
    }
    
    /* 移动端controls区域优化 */
    .controls {
        padding: 20px 15px;
        position: relative; /* 改为relative，避免sticky导致的问题 */
    }
    
    .main-content {
        padding: 20px 15px;
    }
    
    .search-box {
        margin-bottom: 15px;
    }
    
    #searchInput {
        padding: 12px 16px;
        font-size: 16px; /* 防止iOS缩放 */
    }
    
    .filter-btn {
        padding: 8px 16px;
        font-size: 13px;
        white-space: nowrap;
    }
    
    .main-navigation {
        margin-top: 20px;
        gap: 10px;
    }
    
    .nav-btn {
        padding: 10px 16px;
        font-size: 13px;
    }
}

/* 更小屏幕的优化 */
@media (max-width: 480px) {
    .controls {
        padding: 15px 10px;
    }
    
    .main-content {
        padding: 15px 10px;
        min-height: calc(100vh - 400px); /* 确保有足够的高度显示内容 */
    }
    
    #searchInput {
        padding: 10px 12px;
        font-size: 16px;
    }
    
    .filter-btn {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .main-navigation {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .nav-btn {
        width: 100%;
        max-width: 280px;
        padding: 12px 16px;
        font-size: 14px;
        justify-content: center;
    }
    
    .channel-card {
        padding: 20px;
    }
    
    .category-title {
        font-size: 1.3rem;
    }
    
    /* 确保页面能够正常滚动 */
    .page {
        min-height: calc(100vh - 200px);
    }
}

::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: #667eea;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.channel-card {
    animation: fadeIn 0.5s ease;
}

/* 收藏夹控制按钮 */
.favorite-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    transition: var(--transition);
    z-index: 10;
}

.favorite-btn:hover {
    transform: scale(1.2);
}

.favorite-btn.favorited {
    color: #ff6b6b;
}

.favorite-btn:not(.favorited) {
    color: #ddd;
}

/* 评分编辑功能 */
.rating-edit {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
}

.rating-edit select {
    padding: 5px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 12px;
    background: white;
}

.rating-edit button {
    padding: 5px 10px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
}

.rating-edit button:hover {
    background: #5a6fd8;
}

/* 收藏夹页面样式 */
.favorites-page {
    display: none;
}

.favorites-page.active {
    display: block;
}

.favorites-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
    color: white;
    border-radius: 15px;
}

.favorites-header h2 {
    font-size: 2rem;
    margin-bottom: 10px;
}

.favorites-stats {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .favorites-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .favorites-btn {
        width: 100%;
        max-width: 300px;
        justify-content: center;
    }
    
    .favorites-stats {
        gap: 20px;
    }
}

/* 频道编辑页面样式 */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: white;
    margin: 3% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px 30px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.6rem;
    font-weight: 600;
    letter-spacing: -0.5px;
}

.close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.close-icon {
    font-size: 1.4rem;
    font-weight: 300;
    line-height: 1;
}

.modal-body {
    padding: 30px;
    flex: 1;
    overflow-y: auto;
    max-height: calc(85vh - 120px);
}

.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.channel-info {
    margin-bottom: 24px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f3ff 100%);
    border-radius: 12px;
    border: 1px solid #e8ecf7;
}

.channel-summary {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.channel-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.channel-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
}

.channel-region {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
}

.channel-link-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.channel-link-container label {
    font-weight: 500;
    color: #5a6c7d;
    font-size: 0.9rem;
}

.channel-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    padding: 6px 10px;
    border-radius: 6px;
    background: rgba(102, 126, 234, 0.1);
    font-size: 0.9rem;
}

.channel-link:hover {
    color: #5a6fd8;
    background: rgba(102, 126, 234, 0.15);
    transform: translateX(2px);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.video-count {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.watched-videos {
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f3ff 100%);
    border-radius: 12px;
    border: 1px solid #e8ecf7;
    padding: 24px;
}

.watched-videos .section-header {
    margin-bottom: 20px;
}

.add-video-form {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    align-items: flex-end;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
}

.video-url-input,
.video-title-input,
.video-notes-input {
    padding: 12px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.3s ease;
    background: white;
}

.video-url-input:focus,
.video-title-input:focus,
.video-notes-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.video-notes-input {
    min-height: 80px;
    resize: vertical;
}

.add-video-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.add-video-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.add-video-btn:active {
    transform: translateY(0);
}

.videos-list {
    padding-right: 4px;
}

.video-item {
    margin-bottom: 12px;
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.video-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.video-header:hover {
    background-color: #f8f9fa;
}

.video-content {
    padding: 0 16px 16px 16px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.video-content.collapsed {
    max-height: 0;
    padding: 0 16px;
    opacity: 0;
}

.collapse-toggle-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    color: #6c757d;
}

.collapse-toggle-btn:hover {
    background-color: #e9ecef;
    color: #495057;
}

.collapse-toggle-btn svg {
    transition: transform 0.3s ease;
}

.collapse-toggle-btn.collapsed svg {
    transform: rotate(-90deg);
}

.video-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
    border-color: #d1d9e0;
}

.empty-videos-state {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.6;
}

.empty-text {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 8px;
    color: #5a6c7d;
}

.empty-videos-state p {
    font-size: 0.9rem;
    margin: 0;
    opacity: 0.8;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 2% auto;
        max-height: 95vh;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .add-video-form {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
    }
    
    .input-group {
        gap: 12px;
    }
    
    .add-video-btn {
        width: 100%;
        justify-content: center;
    }
    
    .video-item {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    
    .video-content {
        margin-right: 0;
        margin-bottom: 12px;
    }
    
    .video-actions {
        flex-direction: row;
        gap: 8px;
        justify-content: flex-end;
        min-width: auto;
    }
    
    .channel-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .channel-link-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .section-header h3 {
        font-size: 1.1rem;
    }
    
    .video-count {
        align-self: flex-start;
    }
}

.video-content {
    flex: 1;
    margin-right: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.video-title-container,
.video-url-container {
    margin-bottom: 8px;
}

.video-title-display {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e1e8ed;
    min-height: 20px;
}

.video-title-edit {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e1e8ed;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    font-family: inherit;
    transition: all 0.3s ease;
    background: white;
}

.video-title-edit:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.video-url-display {
    color: #667eea;
    text-decoration: none;
    font-size: 0.9rem;
    word-break: break-all;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e1e8ed;
    display: block;
    transition: border-color 0.3s ease;
}

.video-url-display:hover {
    border-color: #667eea;
    text-decoration: underline;
}

.video-url-edit {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e1e8ed;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    transition: all 0.3s ease;
    background: white;
}

.video-url-edit:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.video-notes-container {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.notes-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #5a6c7d;
}

.video-notes-display {
    width: 100%;
    min-height: 60px;
    padding: 8px 12px;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    background: #f8f9fa;
    color: #666;
    line-height: 1.5;
}

.video-notes-edit {
    width: 100%;
    min-height: 60px;
    padding: 8px 12px;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.3s ease;
    background: white;
}

.video-notes-edit:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

/* 已看视频页面布局优化 */
.watched-container {
    max-width: 100%;
}

.channel-group {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    overflow: hidden;
    transition: var(--transition);
}

.channel-group:hover {
    box-shadow: var(--shadow-hover);
}

.channel-group-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 20px;
    font-weight: 600;
    font-size: 1.1rem;
}

.channel-group-content {
    padding: 20px;
}

/* 宽屏下的视频项目布局优化 - 内容在标题下方展开 */
@media (min-width: 1200px) {
    .watched-video-item {
        display: flex;
        flex-direction: column;
    }
    
    .watched-video-header {
        padding: 16px 20px !important;
        border-bottom: 1px solid #e1e8ed;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .watched-video-content {
        padding: 20px;
        width: 100%;
    }
    
    .watched-video-actions {
        padding: 16px 20px !important;
        border-top: 1px solid #e1e8ed;
        background-color: #f8f9fa;
        display: flex !important;
        flex-direction: row !important;
        gap: 8px !important;
        flex-wrap: nowrap !important;
        justify-content: flex-end !important;
        align-items: center !important;
    }
    
    .action-buttons-group {
        display: flex !important;
        flex-direction: row !important;
        gap: 8px !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
    }
}

/* 强制全屏状态下的布局 - 最高优先级 */
@media (min-width: 1920px) {
    .watched-video-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 16px 20px !important;
        border-bottom: 1px solid #e1e8ed !important;
    }
    
    .watched-video-actions {
        display: flex !important;
        flex-direction: row !important;
        gap: 8px !important;
        flex-wrap: nowrap !important;
        justify-content: flex-end !important;
        align-items: center !important;
        padding: 16px 20px !important;
        border-top: 1px solid #e1e8ed !important;
        background-color: #f8f9fa !important;
    }
    
    .watched-video-title {
        flex: 1 !important;
        text-align: left !important;
    }
    
    .collapse-toggle-btn {
        flex-shrink: 0 !important;
        margin-left: auto !important;
    }
    
    .watched-video-actions button {
        display: inline-flex !important;
        flex-shrink: 0 !important;
    }
    
    /* 频道编辑页面 - 超宽屏优化 */
    .video-header {
        padding: 20px 30px !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .video-actions {
        padding: 20px 30px !important;
        gap: 12px !important;
    }
}

/* 基础视频项目样式 */
.watched-video-item {
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
    overflow: hidden;
}

/* 频道编辑页面 - 视频项目样式 */
.video-item {
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
}

/* 频道编辑页面 - 视频标题行布局 */
.video-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 16px;
    border-bottom: 1px solid #e1e8ed;
}

.video-title-container {
    flex: 1 !important;
    margin-right: 16px !important;
}

.video-title-display {
    font-size: 16px !important;
    font-weight: 600 !important;
    color: #333 !important;
    line-height: 1.4 !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
}

/* 频道编辑页面 - 操作按钮区域 */
.video-actions {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px !important;
    flex-wrap: nowrap !important;
    justify-content: flex-end !important;
    align-items: center !important;
    padding: 16px;
    border-top: 1px solid #e1e8ed;
    background-color: #f8f9fa;
}

.video-actions button {
    display: inline-flex !important;
    flex-shrink: 0 !important;
    padding: 6px 12px !important;
    border: none !important;
    border-radius: 6px !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    white-space: nowrap !important;
    align-items: center !important;
    gap: 4px !important;
}

/* 频道编辑页面按钮样式 - 您要求的渐变色 */
.video-actions .ai-assistant-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.video-actions .ai-assistant-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.video-actions .generate-ai-notes-btn {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.video-actions .generate-ai-notes-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.video-actions .edit-save-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.video-actions .edit-save-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.video-actions .delete-video-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.video-actions .delete-video-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* 折叠按钮样式 */
.collapse-toggle-btn {
    background: #f8f9fa;
    border: 1px solid #e1e8ed;
    color: #6c757d;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.collapse-toggle-btn:hover {
    background: #e9ecef;
    border-color: #667eea;
}

.collapse-toggle-btn.collapsed svg {
    transform: rotate(-90deg);
}

.watched-video-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.watched-video-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.watched-video-header:hover {
    background-color: #f8f9fa;
}

.watched-video-content {
    padding: 0 16px 16px 16px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.watched-video-content.collapsed {
    max-height: 0;
    padding: 0 16px;
    opacity: 0;
}

/* 基础样式中的按钮容器 - 已在上面的强制样式中定义 */

.watched-video-display {
    margin-bottom: 12px;
}

.watched-video-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.watched-video-url {
    color: #667eea;
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 8px;
    display: block;
}

.watched-video-url:hover {
    text-decoration: underline;
}

.watched-video-notes {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 8px;
}

.ai-notes-display {
    background: #f0f9ff;
    border: 1px solid #b3d9ff;
    border-radius: 6px;
    padding: 12px;
    font-size: 0.9rem;
    line-height: 1.5;
    color: #333;
}

/* 编辑模式样式 */
.watched-video-edit {
    margin-bottom: 12px;
}

.edit-field {
    margin-bottom: 12px;
}

.edit-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    color: #5a6c7d;
    margin-bottom: 4px;
}

.edit-title-input,
.edit-url-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

.edit-title-input:focus,
.edit-url-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.edit-notes-input {
    width: 100%;
    min-height: 80px;
    padding: 8px 12px;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.3s ease;
}

.edit-notes-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

/* 通用强制样式 - 确保在任何屏幕尺寸下都正确 */
.watched-video-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
}

.watched-video-title {
    flex: 1 !important;
    text-align: left !important;
    margin-right: 16px !important;
}

.collapse-toggle-btn {
    flex-shrink: 0 !important;
    margin-left: auto !important;
}

.watched-video-header:hover {
    background-color: #f8f9fa !important;
}

.watched-video-actions {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px !important;
    flex-wrap: nowrap !important;
    justify-content: flex-end !important;
    align-items: center !important;
    width: 100% !important;
}

/* 确保按钮本身也是水平排列 */
.watched-video-actions button {
    display: inline-flex !important;
    flex-shrink: 0 !important;
}

/* 折叠按钮样式 */
.collapse-toggle-btn {
    background: #f8f9fa;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.collapse-toggle-btn:hover {
    background: #e9ecef;
    border-color: #667eea;
}

.collapse-toggle-btn.collapsed svg {
    transform: rotate(-90deg);
}

.ai-assistant-btn,
.generate-ai-notes-btn,
.edit-watched-notes-btn,
.save-watched-notes-btn,
.cancel-watched-notes-btn,
.delete-watched-video-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.ai-assistant-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.ai-assistant-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.generate-ai-notes-btn {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.generate-ai-notes-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.edit-watched-notes-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.edit-watched-notes-btn:hover {
    background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
    transform: translateY(-1px);
}

.save-watched-notes-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.save-watched-notes-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
}

.cancel-watched-notes-btn {
    background: #6c757d;
    color: white;
}

.cancel-watched-notes-btn:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.delete-watched-video-btn {
    background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
    color: white;
}

.delete-watched-video-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #dc2626 100%);
    transform: translateY(-1px);
}


/* 快速建议样式 */
.quick-suggestions {
    background: #f8f9ff;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
    animation: slideDown 0.3s ease-out;
}

.quick-suggestions-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #e6f3ff;
    border-bottom: 1px solid #b3d9ff;
}

.quick-suggestions-title {
    font-size: 0.85rem;
    font-weight: 500;
    color: #1e40af;
}

.toggle-suggestions-btn {
    background: none;
    border: none;
    color: #667eea;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.toggle-suggestions-btn:hover {
    background: rgba(102, 126, 234, 0.1);
}

.quick-suggestions-content {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px 12px;
}

.quick-suggestion-btn {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 16px;
    padding: 4px 12px;
    font-size: 0.8rem;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.quick-suggestion-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
}

/* 聊天输入框样式更新 */
.chat-input {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.chat-input textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    font-size: 0.9rem;
    font-family: inherit;
    resize: vertical;
    min-height: 60px;
    max-height: 120px;
    transition: border-color 0.3s ease;
}

.chat-input textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.chat-input-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.show-suggestions-btn {
    background: #f8f9ff;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    padding: 8px;
    color: #667eea;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.show-suggestions-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.send-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 6px;
    padding: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
}

.send-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-1px);
}

/* 浮动建议按钮 */
.floating-suggestions-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 16px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    z-index: 1000;
    animation: floatIn 0.5s ease-out;
}

.floating-suggestions-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.floating-suggestions-btn:active {
    transform: translateY(0);
}

/* 动画 */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes floatIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* 响应式设计 */
@media (max-width: 768px) {
    .floating-suggestions-btn {
        bottom: 15px;
        right: 15px;
        padding: 10px 14px;
        font-size: 0.8rem;
    }
    
    .floating-suggestions-btn span {
        display: none;
    }
    
    .quick-suggestions-content {
        flex-direction: column;
    }
    
    .quick-suggestion-btn {
        width: 100%;
        text-align: center;
    }
}

.video-actions {
    display: flex;
    flex-direction: row;
    gap: 8px;
    flex-wrap: nowrap;
    justify-content: flex-end;
    align-items: center;
}

.edit-save-btn,
.delete-video-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.edit-save-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.edit-save-btn:hover {
    background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
    transform: translateY(-1px);
}

.delete-video-btn {
    background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
    color: white;
}

.delete-video-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #d63031 100%);
    transform: translateY(-1px);
}

.video-title {
    font-weight: 500;
    color: #333;
    margin-bottom: 5px;
    word-break: break-word;
}

.video-url {
    color: #667eea;
    text-decoration: none;
    font-size: 14px;
    word-break: break-all;
}

.video-url:hover {
    text-decoration: underline;
}

.video-notes {
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    font-size: 14px;
    color: #666;
    min-height: 40px;
    border: 1px solid #e1e8ed;
    resize: vertical;
    width: 100%;
    font-family: inherit;
}

.video-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.video-actions button {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.3s;
}

.edit-notes-btn {
    background: #28a745;
    color: white;
}

.edit-notes-btn:hover {
    background: #218838;
}

.delete-video-btn {
    background: #dc3545;
    color: white;
}

.delete-video-btn:hover {
    background: #c82333;
}

/* 已看视频页面样式 */
.page {
    min-height: 100vh;
    background: #f8f9fa;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    background: white;
    border-bottom: 1px solid #e1e8ed;
    margin-bottom: 30px;
}

.page-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.8rem;
}


.back-btn:hover {
    background: #5a6fd8;
}

.watched-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding: 0 30px;
    flex-wrap: wrap;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    min-width: 150px;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 14px;
}

.watched-container {
    padding: 0 30px 30px;
}

.channel-group {
    background: white;
    border-radius: 10px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.channel-group-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    font-weight: 500;
}

.channel-group-content {
    padding: 20px;
}

.watched-video-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.watched-video-content {
    flex: 1;
    margin-right: 15px;
}

.watched-video-title {
    font-weight: 500;
    color: #333;
    margin-bottom: 5px;
    word-break: break-word;
}

.watched-video-url {
    color: #667eea;
    text-decoration: none;
    font-size: 14px;
    word-break: break-all;
    display: block;
    margin-bottom: 10px;
}

.watched-video-url:hover {
    text-decoration: underline;
}

.watched-video-notes {
    color: #666;
    font-size: 14px;
    line-height: 1.5;
    background: white;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #e1e8ed;
}

.watched-video-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.watched-video-actions button {
    padding: 5px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.3s;
}

.edit-watched-notes-btn {
    background: #28a745;
    color: white;
}

.edit-watched-notes-btn:hover {
    background: #218838;
}

.delete-watched-video-btn {
    background: #dc3545;
    color: white;
}

.delete-watched-video-btn:hover {
    background: #c82333;
}

/* 编辑按钮样式 */
.edit-channel-btn {
    position: absolute;
    top: 15px;
    left: 15px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.3s;
    z-index: 5;
}

.edit-channel-btn:hover {
    background: #218838;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 2% auto;
        max-height: 90vh;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .add-video-form {
        flex-direction: column;
    }
    
    .add-video-form input {
        min-width: auto;
    }
    
    .video-item, .watched-video-item {
        flex-direction: column;
        align-items: stretch;
    }
    
    .video-actions, .watched-video-actions {
        flex-direction: row;
        justify-content: flex-end;
        margin-top: 10px;
    }
    
    .page-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .watched-stats {
        justify-content: center;
    }
    
    .watched-container {
        padding: 0 15px 30px;
    }
}

/* 可点击的频道名称样式 */
.channel-name.clickable {
    cursor: pointer;
    transition: color 0.3s ease;
}

.channel-name.clickable:hover {
    color: #667eea;
    text-decoration: underline;
}

/* 头部内容优化 */
.header-title {
    font-size: 3.5rem;
    font-weight: 700;
    margin-bottom: 20px;
    letter-spacing: -1px;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    background: linear-gradient(135deg, white 0%, rgba(255, 255, 255, 0.9) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleGlow 3s ease-in-out infinite;
    font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

@keyframes titleGlow {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.1); }
}

.header-subtitle {
    font-size: 1.4rem;
    font-weight: 500;
    opacity: 0.95;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    animation: subtitleFloat 4s ease-in-out infinite;
    font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin-bottom: 12px;
}

@keyframes subtitleFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-1px); }
}

.header-description {
    font-size: 1.1rem;
    font-weight: 400;
    opacity: 0.9;
    letter-spacing: 0.3px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin-bottom: 8px;
}

.header-tagline {
    font-size: 1rem;
    font-weight: 300;
    opacity: 0.85;
    letter-spacing: 0.2px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-style: italic;
}

/* 头部装饰背景 */
.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
    animation: headerFloat 8s ease-in-out infinite;
}

@keyframes headerFloat {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-2px) rotate(0.5deg); }
}

/* 头部整体优化 */
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 100px 0;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

/* 响应式优化 */
@media (max-width: 768px) {
    .header {
        padding: 80px 0;
    }
    
    .header-title {
        font-size: 2.8rem;
        letter-spacing: -0.5px;
    }
    
    .header-subtitle {
        font-size: 1.2rem;
    }
    
    .header-description {
        font-size: 1rem;
    }
    
    .header-tagline {
        font-size: 0.9rem;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 60px 0;
    }
    
    .header-title {
        font-size: 2.2rem;
        letter-spacing: -0.3px;
    }
    
    .header-subtitle {
        font-size: 1rem;
    }
    
    .header-description {
        font-size: 0.9rem;
    }
    
    .header-tagline {
        font-size: 0.8rem;
    }
}

/* 主要导航按键样式 */
.main-navigation {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 25px;
    flex-wrap: wrap;
}

.nav-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border: 2px solid var(--border-color);
    border-radius: 25px;
    background: white;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-family: inherit;
    white-space: nowrap;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.nav-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: var(--transition);
}

.nav-btn:hover::before {
    left: 100%;
}

.nav-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.nav-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
}

.nav-btn.active:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.btn-icon {
    font-size: 1.1rem;
    display: flex;
    align-items: center;
}

.btn-text {
    font-weight: 500;
}

/* 特定按键样式 */
.favorites-btn:hover {
    border-color: #ff6b6b;
    background: #fff5f5;
}

.favorites-btn.active {
    background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
}

.all-channels-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.watched-videos-btn:hover {
    border-color: #28a745;
    background: #f8fff8;
}

.watched-videos-btn.active {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

/* 页面切换样式 */
.page {
    display: none;
}

.page.active {
    display: block;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px 20px;
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
    border-radius: 15px;
    border: 1px solid var(--border-color);
}

.page-header h2 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    color: var(--text-primary);
    font-weight: 700;
}

.page-header p {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin: 0;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .main-navigation {
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    
    .nav-btn {
        width: 280px;
        justify-content: center;
    }
    
    .page-header h2 {
        font-size: 2rem;
    }
    
    .page-header p {
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .nav-btn {
        width: 100%;
        padding: 10px 20px;
        font-size: 13px;
    }
}

/* 学习报告页面样式 */
.report-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

.report-controls .filter-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    background: white;
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: var(--shadow);
}

.report-controls .filter-btn:hover {
    border-color: #667eea;
    background: #f8f9ff;
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.report-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: var(--shadow);
    min-height: 400px;
}

.report-placeholder {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.report-placeholder .placeholder-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.report-placeholder h3 {
    font-size: 1.8rem;
    margin-bottom: 15px;
    color: var(--text-primary);
}

.report-placeholder p {
    font-size: 1.1rem;
    margin-bottom: 25px;
    line-height: 1.6;
}

.report-placeholder ul {
    text-align: left;
    max-width: 400px;
    margin: 0 auto;
    font-size: 1rem;
    line-height: 1.8;
}

.report-placeholder li {
    margin-bottom: 8px;
    color: var(--text-secondary);
}

/* 学习报告内容样式 */
.learning-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-hover);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 1rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.knowledge-map {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
}

.knowledge-map h3 {
    font-size: 1.5rem;
    margin-bottom: 20px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.skill-categories {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.skill-category {
    background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    padding: 20px;
    transition: var(--transition);
}

.skill-category:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
}

.category-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.category-icon {
    font-size: 1.5rem;
}

.category-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
}

.category-progress {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.category-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.english-knowledge-base {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bfdbfe;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
}

.english-knowledge-base h3 {
    color: #1e40af;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.vocabulary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.vocabulary-card {
    background: white;
    border: 1px solid #bfdbfe;
    border-radius: 10px;
    padding: 15px;
    transition: var(--transition);
}

.vocabulary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.1);
}

.vocabulary-word {
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 5px;
}

.vocabulary-meaning {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.vocabulary-example {
    font-size: 0.85rem;
    color: #64748b;
    font-style: italic;
}

.review-schedule {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #f59e0b;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
}

.review-schedule h3 {
    color: #92400e;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.review-item {
    background: white;
    border: 1px solid #f59e0b;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.review-content {
    flex: 1;
}

.review-title {
    font-weight: 600;
    color: #92400e;
    margin-bottom: 5px;
}

.review-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.review-status {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.review-status.pending {
    background: #fef3c7;
    color: #92400e;
}

.review-status.completed {
    background: #d1fae5;
    color: #065f46;
}

.learning-suggestions {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border: 1px solid #10b981;
    border-radius: 15px;
    padding: 25px;
}

.learning-suggestions h3 {
    color: #065f46;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.suggestion-item {
    background: white;
    border: 1px solid #10b981;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: var(--transition);
}

.suggestion-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
}

.suggestion-title {
    font-weight: 600;
    color: #065f46;
    margin-bottom: 8px;
}

.suggestion-description {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.5;
}

/* 重复的数据管理按钮样式已删除，功能已移至页面顶部 */

/* 重复的数据管理按钮样式已删除 */

/* 通知样式 */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.notification {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* 重复的数据管理按钮样式已删除 */

/* 重复的数据管理按钮样式已删除 */

/* 📺 图标保持原色 */
.header-title .emoji {
    color: initial !important;
    -webkit-text-fill-color: initial !important;
    background: none !important;
    -webkit-background-clip: initial !important;
    background-clip: initial !important;
}

/* AI 学习助手样式 */
.ai-assistant-modal {
    max-width: 900px;
    width: 95%;
    height: 80vh;
    max-height: 700px;
}

.ai-assistant-body {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-height: calc(80vh - 120px);
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
}

.ai-context-panel {
    background: #f8f9ff;
    border: 1px solid #e1e8ed;
    border-radius: 12px;
    padding: 16px;
}

.ai-context-panel h4 {
    margin: 0 0 12px 0;
    color: var(--text-primary);
    font-size: 1rem;
}

.context-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.context-item {
    display: flex;
    gap: 8px;
    font-size: 0.9rem;
}

.context-item strong {
    color: var(--text-primary);
    min-width: 80px;
}

.context-item span {
    color: var(--text-secondary);
    flex: 1;
    word-break: break-word;
}

.ai-extract-panel {
    background: #f0f9ff;
    border: 1px solid #bfdbfe;
    border-radius: 12px;
    padding: 16px;
}

.ai-extract-panel h4 {
    margin: 0 0 12px 0;
    color: var(--text-primary);
    font-size: 1rem;
}

.extract-input-container {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

.extract-input-container input {
    flex: 1;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 10px 12px;
    font-family: inherit;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.3s ease;
}

.extract-input-container input:focus {
    border-color: #667eea;
}

.extract-btn {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
    white-space: nowrap;
}

.extract-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}

.extract-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.extract-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #fef3c7;
    border-radius: 8px;
    font-size: 0.85rem;
    color: #92400e;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: #f59e0b;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

.video-transcript {
    margin-top: 12px;
    padding: 12px;
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
}

.video-transcript h5 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.video-transcript #transcriptContent {
    color: var(--text-secondary);
    font-size: 0.85rem;
    line-height: 1.6;
    max-height: 200px;
    overflow-y: auto;
}

.ai-suggestions-panel {
    background: #fff8f0;
    border: 1px solid #f0e6d2;
    border-radius: 12px;
    padding: 16px;
}

.ai-suggestions-panel h4 {
    margin: 0 0 16px 0;
    color: var(--text-primary);
    font-size: 1rem;
}

.suggestion-categories {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.category-tabs {
    display: flex;
    gap: 4px;
    background: #fff;
    border-radius: 8px;
    padding: 4px;
    border: 1px solid #e1e8ed;
}

.category-tab {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: transparent;
    color: var(--text-secondary);
    white-space: nowrap;
}

.category-tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 500;
}

.category-tab:hover:not(.active) {
    background: #f8f9ff;
    color: var(--text-primary);
}

.suggestion-content {
    position: relative;
    min-height: 200px;
}

.suggestion-group {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.suggestion-group.active {
    display: block;
}

.group-title {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 12px;
    padding: 4px 8px;
    background: #f0f9ff;
    border-radius: 6px;
    text-align: center;
    font-style: italic;
}

.suggestion-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.suggestion-btn {
    background: #fff;
    border: 1px solid #e1e8ed;
    border-radius: 16px;
    padding: 8px 12px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-primary);
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.suggestion-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: left 0.5s ease;
}

.suggestion-btn:hover::before {
    left: 100%;
}

.suggestion-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

/* 知识学习类按钮 */
.suggestion-group[data-category="knowledge"] .suggestion-btn:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* 生活成长类按钮 */
.suggestion-group[data-category="life"] .suggestion-btn:hover {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

/* 深度思考类按钮 */
.suggestion-group[data-category="thinking"] .suggestion-btn:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

/* 英语学习类按钮 */
.suggestion-group[data-category="english"] .suggestion-btn:hover {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

/* 英语分析按钮特殊样式 */
.english-analysis-btn {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white !important;
    border: 1px solid #7c3aed !important;
    font-weight: 600;
    position: relative;
    overflow: hidden;
}

.english-analysis-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.english-analysis-btn:hover::before {
    left: 100%;
}

.english-analysis-btn:hover {
    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 响应式设计 */
@media (max-width: 768px) {
    .category-tabs {
        flex-direction: column;
        gap: 2px;
    }
    
    .category-tab {
        font-size: 0.75rem;
        padding: 6px 8px;
    }
    
    .suggestion-buttons {
        flex-direction: column;
    }
    
    .suggestion-btn {
        text-align: left;
        white-space: normal;
        padding: 10px 12px;
    }
}

.ai-chat-container {
    display: flex;
    flex-direction: column;
    background: #fff;
    border: 1px solid #e1e8ed;
    border-radius: 12px;
    overflow: visible;
}

.chat-messages {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ai-message, .user-message {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.user-message {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.ai-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.user-message .message-avatar {
    background: #f0f3ff;
    color: #667eea;
}

.message-content {
    background: #f8f9ff;
    padding: 12px 16px;
    border-radius: 16px;
    max-width: 70%;
    line-height: 1.5;
    font-size: 0.9rem;
}

.user-message .message-content {
    background: #667eea;
    color: white;
}

.message-content p {
    margin: 0 0 8px 0;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.chat-input-container {
    border-top: 1px solid #e1e8ed;
    padding: 16px;
    background: #fff;
}

.chat-input {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.chat-input textarea {
    flex: 1;
    border: 1px solid #e1e8ed;
    border-radius: 12px;
    padding: 12px;
    font-family: inherit;
    font-size: 0.9rem;
    resize: none;
    outline: none;
    transition: border-color 0.3s ease;
    min-height: 40px;
    max-height: 120px;
}

.chat-input textarea:focus {
    border-color: #667eea;
}

.send-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.send-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.ai-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.status-indicator {
    color: #28a745;
    font-size: 0.6rem;
}

.status-indicator.thinking {
    color: #ffc107;
    animation: pulse 1s infinite;
}

.status-indicator.error {
    color: #dc3545;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* 响应式设计 */
@media (max-width: 768px) {
    .ai-assistant-modal {
        width: 95%;
        height: 90vh;
        margin: 5% auto;
    }
    
    .ai-assistant-body {
        gap: 16px;
    }
    
    .suggestion-buttons {
        flex-direction: column;
    }
    
    .suggestion-btn {
        text-align: left;
        white-space: normal;
    }
    
    .message-content {
        max-width: 85%;
    }
}

/* AI 助手按钮样式 */
.ai-assistant-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
}

.ai-assistant-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.ai-assistant-btn svg {
    flex-shrink: 0;
}

/* API 设置按钮 */
.settings-btn {
    background: #f0f3ff;
    color: #667eea;
    border: none;
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.settings-btn:hover {
    background: #667eea;
    color: white;
    transform: rotate(90deg);
}

/* AI 笔记相关样式 */
.ai-notes-container {
    margin-top: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 12px;
    position: relative;
}

.ai-notes-label {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.ai-notes-display {
    color: #0f172a;
    line-height: 1.6;
    font-size: 0.9rem;
}

.ai-notes-display h3 {
    color: #0369a1;
    margin: 16px 0 8px 0;
    font-size: 1rem;
    font-weight: 600;
}

.ai-notes-display ul {
    margin: 8px 0;
    padding-left: 20px;
}

.ai-notes-display li {
    margin: 4px 0;
    color: #334155;
}

.ai-notes-display strong {
    color: #0369a1;
    font-weight: 600;
}

.ai-notes-display p {
    margin: 8px 0;
    color: #475569;
}

/* 生成笔记按钮 */
.generate-ai-notes-btn {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
}

.generate-ai-notes-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.generate-ai-notes-btn svg {
    flex-shrink: 0;
}

/* 头部数据管理按钮样式 */
.header-data-management {
    margin-top: 30px;
    text-align: center;
}

.header-data-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.header-data-btn {
    padding: 12px 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.header-data-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.header-data-btn.export-btn:hover {
    background: rgba(40, 167, 69, 0.3);
    border-color: rgba(40, 167, 69, 0.6);
}

.header-data-btn.import-btn:hover {
    background: rgba(0, 123, 255, 0.3);
    border-color: rgba(0, 123, 255, 0.6);
}

.header-data-btn.clear-btn:hover {
    background: rgba(220, 53, 69, 0.3);
    border-color: rgba(220, 53, 69, 0.6);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .header-data-buttons {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .header-data-btn {
        width: 200px;
    }
}

@media (max-width: 480px) {
    .header-data-btn {
        width: 180px;
        padding: 10px 16px;
        font-size: 0.85rem;
    }
}
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- 简单登录弹窗 -->
    <div id="loginModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    ">
        <div style="
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        ">
            <h1 style="color: #333; margin-bottom: 10px; font-size: 28px;">📺 YouTube 精选馆</h1>
            <p style="color: #666; margin-bottom: 30px; font-size: 16px;">登录以同步您的数据到所有设备</p>
            
            <!-- 登录表单 -->
            <div id="loginFormDiv" style="margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <input type="email" id="loginEmail" placeholder="邮箱" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <input type="password" id="loginPassword" placeholder="密码" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                </div>
                <button onclick="loginUser()" style="
                    width: 100%; padding: 12px; background: #667eea; color: white; 
                    border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
                    transition: background 0.3s;
                " onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">登录</button>
            </div>
            
            <!-- 注册表单 -->
            <div id="registerFormDiv" style="margin-bottom: 20px; display: none;">
                <div style="margin-bottom: 15px;">
                    <input type="email" id="registerEmail" placeholder="邮箱" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="password" id="registerPassword" placeholder="密码（至少6位）" minlength="6"
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <input type="password" id="registerPasswordConfirm" placeholder="确认密码" minlength="6"
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                </div>
                <button onclick="registerUser()" style="
                    width: 100%; padding: 12px; background: #667eea; color: white; 
                    border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
                    transition: background 0.3s;
                " onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">注册</button>
            </div>
            
            <!-- 切换按钮 -->
            <div style="margin-bottom: 20px;">
                <button id="switchToRegisterBtn" onclick="switchToRegister()" style="
                    background: none; border: none; color: #667eea; cursor: pointer; 
                    text-decoration: underline; font-size: 14px;
                ">没有账号？点击注册</button>
                <button id="switchToLoginBtn" onclick="switchToLogin()" style="
                    background: none; border: none; color: #667eea; cursor: pointer; 
                    text-decoration: underline; font-size: 14px; display: none;
                ">已有账号？点击登录</button>
            </div>
            
            <!-- Google 登录按钮 -->
            <div style="margin-bottom: 20px;">
                <button onclick="loginWithGoogle()" style="
                    width: 100%; padding: 12px; background: #4285f4; color: white; 
                    border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
                    transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
                " onmouseover="this.style.background='#3367d6'" onmouseout="this.style.background='#4285f4'">
                    <span style="font-size: 18px;">🔍</span>
                    使用 Google 登录
                </button>
            </div>
            
            <!-- 跳过登录按钮 -->
            <div style="margin-top: 20px;">
                <button onclick="skipLogin()" style="
                    width: 100%; padding: 10px; background: #6c757d; color: white; 
                    border: none; border-radius: 8px; font-size: 14px; cursor: pointer;
                    transition: background 0.3s;
                " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">🚀 跳过登录，使用本地版本</button>
            </div>
            
            <!-- 错误信息 -->
            <div id="loginError" style="
                color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; 
                padding: 10px; border-radius: 5px; margin-top: 15px; display: none;
                font-size: 14px;
            "></div>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <h1 class="header-title"><span class="emoji">📺</span> YouTube 精选馆</h1>
            <p class="header-subtitle">「Your Curated YouTube Universe」</p>
                    <p class="header-description">精选频道 · 智慧学习 · 灵感生长</p>
                    <p class="header-tagline">Learn smarter. Watch deeper. Explore further.</p>
                    <div class="header-data-management">
                    <div class="header-data-buttons">
                        <button id="exportBtn" class="header-data-btn export-btn">📤 导出数据</button>
                        <button id="importBtn" class="header-data-btn import-btn">📥 导入数据</button>
                        <button id="clearDataBtn" class="header-data-btn clear-btn">🗑️ 清除数据</button>
                    </div>
                </div>
                
                <!-- 用户信息区域 - 始终显示 -->
                <div id="userInfo" class="user-info" style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; text-align: center; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="userAvatar" style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);">👤</div>
                            <div>
                                <div id="userEmail" style="color: white; font-weight: 600; font-size: 16px; margin-bottom: 4px;">游客模式</div>
                                <div id="syncStatus" style="color: rgba(255, 255, 255, 0.8); font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                    <span id="syncIndicator" style="width: 8px; height: 8px; background: #ffc107; border-radius: 50%; display: inline-block;"></span>
                                    <span id="syncText">本地模式</span>
                                </div>
                                <div id="lastSyncTime" style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-top: 2px;"></div>
                            </div>
                        </div>
                        <div id="userActions" style="display: flex; gap: 12px;">
                            <!-- 登录状态按钮 -->
                            <button id="switchAccountBtn" onclick="switchAccount()" style="display: none; padding: 10px 18px; background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 25px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">🔄 切换账号</button>
                            <button id="logoutBtn" onclick="logoutUser()" style="display: none; padding: 10px 18px; background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 25px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">🚪 退出登录</button>
                            
                            <!-- 游客模式按钮 -->
                            <button id="loginBtn" onclick="showLoginModal()" style="padding: 10px 18px; background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 25px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">🔐 登录</button>
                            
                            <!-- 测试同步按钮（仅登录后显示） -->
                            <button id="testSyncBtn" onclick="testFirebaseSync()" style="display: none; padding: 10px 18px; background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 25px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">🧪 测试同步</button>
                            
                            <!-- 退出预览模式按钮（仅预览模式显示） -->
                            <button id="exitPreviewBtn" onclick="exitPreviewMode()" style="display: none; padding: 10px 18px; background: rgba(255, 152, 0, 0.8); color: white; border: 1px solid rgba(255, 152, 0, 0.5); border-radius: 25px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; font-weight: 500;" onmouseover="this.style.background='rgba(255, 152, 0, 0.9)'" onmouseout="this.style.background='rgba(255, 152, 0, 0.8)'">🔄 退出预览</button>
                        </div>
                    </div>
                </div>
        </div>

    </header>

    <!-- 账号切换弹窗 -->
    <div id="switchAccountModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); z-index: 100001; align-items: center; justify-content: center;">
        <div style="background: #fff; width: 92%; max-width: 480px; border-radius: 14px; padding: 22px 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.25);">
            <h3 style="margin: 0 0 16px; color: #222; text-align: center; font-size: 20px; font-weight: 600;">🔄 切换账号</h3>
            <p style="margin: 0 0 20px; color: #555; font-size: 14px; text-align: center;">选择要切换到的账号</p>
            
            <!-- 最近登录的账号列表 -->
            <div id="recentAccountsList" style="margin-bottom: 20px;">
                <!-- 动态生成最近账号 -->
            </div>
            
            <!-- 其他登录选项 -->
            <div style="border-top: 1px solid #eee; padding-top: 16px;">
                <button onclick="showLoginModal(); hideSwitchAccountModal();" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 10px; transition: background 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
                    📧 使用邮箱登录
                </button>
                <button onclick="loginWithGoogle(); hideSwitchAccountModal();" style="width: 100%; padding: 12px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 10px; transition: background 0.3s;" onmouseover="this.style.background='#3367d6'" onmouseout="this.style.background='#4285f4'">
                    🔍 使用 Google 登录
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 16px;">
                <button onclick="hideSwitchAccountModal()" style="padding: 8px 16px; background: transparent; border: 1px solid #ddd; color: #666; border-radius: 20px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">取消</button>
            </div>
        </div>
    </div>

    <!-- 数据同步选择弹窗 -->
    <div id="mergeChoiceModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100001; align-items: center; justify-content: center;">
        <div style="background: #fff; width: 90%; max-width: 500px; max-height: 85vh; border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            <div style="padding: 24px 24px 0; flex-shrink: 0;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 8px;">🔄</div>
                <h3 style="margin: 0 0 8px; color: #333; font-size: 20px; font-weight: 600;">数据同步选择</h3>
                <p style="margin: 0; color: #666; font-size: 14px;">检测到本地数据，请选择同步方式</p>
            </div>
            
            <div id="mergeChoiceSummary" style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #555; line-height: 1.5;"></div>
            </div>
            
            <!-- 可滚动的内容区域 -->
            <div class="custom-scrollbar" style="flex: 1; overflow-y: auto; padding: 0 24px; scrollbar-width: thin; scrollbar-color: #ddd #f5f5f5;">
                <div style="display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px;">
                <button onclick="chooseMergeStrategy('merge')" style="padding: 18px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; cursor: pointer; text-align: left; font-size: 15px; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.3)'">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 24px; margin-top: 2px;">📤</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 16px;">📤 上传本地数据（推荐）</div>
                            <div style="font-size: 13px; opacity: 0.95; line-height: 1.5; margin-bottom: 8px;">将本地的收藏、评分、已看视频上传到云端</div>
                            <div style="font-size: 12px; opacity: 0.85; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; line-height: 1.6;">
                                <div><strong>效果：</strong></div>
                                <div>✅ 本地数据保留不变</div>
                                <div>✅ 云端数据更新为本地版本</div>
                                <div>✅ 其他设备登录可看到这些数据</div>
                            </div>
                        </div>
                    </div>
                </button>
                
                <button onclick="chooseMergeStrategy('cloud')" style="padding: 18px; background: #fff; color: #333; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; text-align: left; font-size: 15px; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.borderColor='#2196F3'; this.style.backgroundColor='#f3f9ff'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.backgroundColor='#fff'">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 24px; margin-top: 2px;">📥</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 16px; color: #333;">📥 下载云端数据</div>
                            <div style="font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 8px;">用云端数据替换本地数据，恢复云端版本</div>
                            <div style="font-size: 12px; color: #555; background: #f5f5f5; padding: 8px; border-radius: 6px; line-height: 1.6;">
                                <div><strong>效果：</strong></div>
                                <div>⚠️ 本地数据被覆盖（会丢失）</div>
                                <div>✅ 云端数据下载到本地</div>
                                <div>✅ 恢复到云端保存的版本</div>
                            </div>
                        </div>
                    </div>
                </button>
                
                <button onclick="chooseMergeStrategy('preview')" style="padding: 18px; background: #fff; color: #333; border: 2px solid #e0e0e0; border-radius: 12px; cursor: pointer; text-align: left; font-size: 15px; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.borderColor='#9C27B0'; this.style.backgroundColor='#faf5ff'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.backgroundColor='#fff'">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 24px; margin-top: 2px;">👁️</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 6px; font-size: 16px; color: #333;">👁️ 预览云端数据</div>
                            <div style="font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 8px;">显示云端内容，可以编辑并同步到云端</div>
                            <div style="font-size: 12px; color: #555; background: #f5f5f5; padding: 8px; border-radius: 6px; line-height: 1.6;">
                                <div><strong>效果：</strong></div>
                                <div>✅ 本地数据会被安全备份</div>
                                <div>✅ 界面显示云端数据内容</div>
                                <div>✅ 新的编辑会同步到云端</div>
                                <div>✅ 点击"退出预览"可恢复本地数据</div>
                            </div>
                        </div>
                    </div>
                </button>
                </div>
            </div>
            
            <!-- 底部按钮区域 -->
            <div style="padding: 20px 24px 24px; border-top: 1px solid #eee; flex-shrink: 0; background: #fff;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label style="font-size: 13px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <input id="rememberMergeChoice" type="checkbox" style="margin: 0;">
                        记住我的选择
                    </label>
                    <button onclick="hideMergeChoiceModal()" style="padding: 8px 16px; background: transparent; border: 1px solid #ddd; color: #666; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">取消</button>
                </div>
            </div>
        </div>
    </div>
    <div class="controls">
        <div class="container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 搜索频道名称或简介...">
            </div>
            <div class="filter-buttons" id="filterButtons">
            </div>
            
            <!-- 主要导航按键 -->
            <div class="main-navigation">
                <button id="favoritesBtn" class="nav-btn favorites-btn">
                    <span class="btn-icon">❤️</span>
                    <span class="btn-text">我的收藏夹(<span id="favoritesCount">0</span>)</span>
                </button>
                <button id="allChannelsBtn" class="nav-btn all-channels-btn active">
                    <span class="btn-icon">📁</span>
                    <span class="btn-text">全部频道</span>
                </button>
                <button id="watchedVideosBtn" class="nav-btn watched-videos-btn">
                    <span class="btn-icon">📺</span>
                    <span class="btn-text">已看视频(<span id="watchedCount">0</span>)</span>
                </button>
                <button id="learningReportBtn" class="nav-btn learning-report-btn">
                    <span class="btn-icon">📊</span>
                    <span class="btn-text">学习报告</span>
                </button>
            </div>
        </div>
    </div>
    <main class="main-content">
        <div class="container">
            <!-- 全部频道页面（默认） -->
            <div id="allChannelsPage" class="page active">
                <div id="channelsContainer"></div>
            </div>
            
            <!-- 收藏夹页面 -->
            <div id="favoritesPage" class="page">
                <div class="page-header">
                    <h2>❤️ 我的收藏夹</h2>
                    <p>您收藏的精选频道</p>
                </div>
                <div id="favoritesContainer"></div>
                <div id="favoritesEmpty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">💔</div>
                    <div class="empty-state-text">还没有收藏任何频道</div>
                    <p>点击频道卡片右上角的❤️来收藏喜欢的频道</p>
                </div>
            </div>
            
                <!-- 观后感编辑模态框（用于已看页面和频道编辑内的单条观后感快速编辑） -->
            <!-- 已看视频页面 -->
            <div id="watchedVideosPage" class="page">
                <div class="page-header">
                    <h2>📺 已看视频</h2>
                    <p>您的观看记录和学习笔记</p>
                </div>
                <div id="watchedVideosContainer"></div>
                <div id="watchedVideosEmpty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">📝</div>
                    <div class="empty-state-text">还没有观看记录</div>
                    <p>点击频道名称进入编辑页面，添加您观看过的视频</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 频道编辑页面 -->
    <div id="channelEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editChannelName">频道详情</h2>
                <button class="close-btn" id="closeEditModal">
                    <span class="close-icon">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="channel-info">
                    <div class="channel-summary">
                        <div class="channel-title">
                            <span id="editChannelNameDisplay" class="channel-name"></span>
                            <span id="editChannelRegion" class="channel-region"></span>
                        </div>
                        <div class="channel-link-container">
                            <label>访问链接：</label>
                            <a id="editChannelLink" href="#" target="_blank" class="channel-link">
                                <span id="channelUrlDisplay"></span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15,3 21,3 21,9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="watched-videos">
                    <div class="section-header">
                        <h3>📝 已看视频</h3>
                        <span class="video-count" id="videoCountDisplay">0 个视频</span>
                    </div>
                    <div class="add-video-form">
                        <div class="input-group">
                            <input type="url" id="videoUrlInput" placeholder="输入视频链接..." class="video-url-input">
                            <input type="text" id="videoTitleInput" placeholder="视频标题（可选）" class="video-title-input">
                            <textarea id="videoNotesInput" placeholder="观后感（可选）..." class="video-notes-input"></textarea>
                        </div>
                        <button id="addVideoBtn" class="add-video-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            添加视频
                        </button>
                    </div>
                    <div id="watchedVideosList" class="videos-list">
                        <!-- 视频列表将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 视频编辑模态：用于编辑视频的标题、链接与观后感（替代内嵌编辑） -->
    <div id="videoEditModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑视频信息</h2>
                <button class="close-btn" id="closeVideoModal">
                    <span class="close-icon">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="display:flex; flex-direction:column; gap:12px;">
                    <label>视频链接</label>
                    <input id="videoModalUrl" type="url" style="padding:10px; border-radius:8px; border:1px solid var(--border-color); font-family:inherit;">
                    <label>视频标题（可选）</label>
                    <input id="videoModalTitle" type="text" style="padding:10px; border-radius:8px; border:1px solid var(--border-color); font-family:inherit;">
                    <label>观后感（支持换行）</label>
                    <textarea id="videoModalNotes" rows="10" style="padding:12px; border-radius:8px; border:1px solid var(--border-color); font-family:inherit; resize:vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display:flex; gap:8px; justify-content:flex-end; padding:16px;">
                <button id="cancelVideoBtn" class="filter-btn" style="background:#f5f6f8; color:var(--text-primary);">取消</button>
                <button id="saveVideoBtn" class="filter-btn" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">保存</button>
            </div>
        </div>
    </div>

    <!-- AI API 配置模态框 -->
    <div id="apiConfigModal" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>⚙️ AI API 配置</h2>
                <button class="close-btn" id="closeApiConfig">
                    <span class="close-icon">×</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- AI 提供商选择 -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">🤖 AI 提供商：</label>
                    <select id="aiProvider" style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: inherit; font-size: 1rem;">
                        <option value="gemini">🎁 Google Gemini（推荐 - 完全免费）</option>
                        <option value="groq">⚡ Groq（免费 - 超快速度）</option>
                        <option value="openai">💰 OpenAI（付费）</option>
                    </select>
                </div>

                <!-- Gemini 配置 -->
                <div id="geminiConfig" class="provider-config">
                    <div style="margin-bottom: 16px; padding: 12px; background: #d1fae5; border-radius: 8px; font-size: 0.9rem;">
                        <p style="margin: 0 0 8px 0;"><strong>✅ 完全免费！Google Gemini API</strong></p>
                        <p style="margin: 0; font-size: 0.85rem;">每分钟 15 次请求，每天 1500 次请求，无需信用卡</p>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
                        <p style="margin: 0 0 8px 0;"><strong>🔑 如何获取免费 API Key：</strong></p>
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>访问 <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #0ea5e9;">Google AI Studio</a></li>
                            <li>使用 Google 账号登录</li>
                            <li>点击 "Get API Key" 或 "创建 API 密钥"</li>
                            <li>复制 API Key 并粘贴到下方</li>
                        </ol>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Gemini API Key：</label>
                        <input type="password" id="geminiApiKey" placeholder="AIza..." style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">模型：</label>
                        <select id="geminiModel" style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: inherit;">
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash（推荐 - 快速免费）</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro（高质量免费）</option>
                        </select>
                    </div>
                </div>

                <!-- Groq 配置 -->
                <div id="groqConfig" class="provider-config" style="display: none;">
                    <div style="margin-bottom: 16px; padding: 12px; background: #d1fae5; border-radius: 8px; font-size: 0.9rem;">
                        <p style="margin: 0 0 8px 0;"><strong>✅ 完全免费！Groq 超快 AI</strong></p>
                        <p style="margin: 0; font-size: 0.85rem;">响应速度极快，免费额度充足</p>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
                        <p style="margin: 0 0 8px 0;"><strong>🔑 如何获取免费 API Key：</strong></p>
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>访问 <a href="https://console.groq.com/keys" target="_blank" style="color: #0ea5e9;">Groq Console</a></li>
                            <li>注册账号（支持 Google 登录）</li>
                            <li>点击 "Create API Key"</li>
                            <li>复制 API Key 并粘贴到下方</li>
                        </ol>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Groq API Key：</label>
                        <input type="password" id="groqApiKey" placeholder="gsk_..." style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">模型：</label>
                        <select id="groqModel" style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: inherit;">
                            <option value="llama-3.1-70b-versatile">Llama 3.1 70B（推荐 - 强大全能）</option>
                            <option value="llama-3.1-8b-instant">Llama 3.1 8B（快速响应）</option>
                            <option value="mixtral-8x7b-32768">Mixtral 8x7B（长文本）</option>
                        </select>
                    </div>
                </div>

                <!-- OpenAI 配置 -->
                <div id="openaiConfig" class="provider-config" style="display: none;">
                    <div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; font-size: 0.9rem;">
                        <p style="margin: 0 0 8px 0;"><strong>💰 OpenAI（付费服务）</strong></p>
                        <p style="margin: 0; font-size: 0.85rem;">需要付费，但如果您已有 API Key 可以使用</p>
                    </div>
                    <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 0.9rem;">
                        <p style="margin: 0 0 8px 0;"><strong>🔑 如何获取 API Key：</strong></p>
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>访问 <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #0ea5e9;">OpenAI API Keys</a></li>
                            <li>登录或注册账号</li>
                            <li>点击 "Create new secret key"</li>
                            <li>复制 API Key 并粘贴到下方</li>
                        </ol>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">OpenAI API Key：</label>
                        <input type="password" id="openaiApiKey" placeholder="sk-..." style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">模型：</label>
                        <select id="openaiModel" style="width: 100%; padding: 10px; border: 1px solid #e1e8ed; border-radius: 8px; font-family: inherit;">
                            <option value="gpt-4o">GPT-4o（推荐，最新最快）</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo（高质量）</option>
                            <option value="gpt-4">GPT-4（经典版本）</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo（经济实惠）</option>
                        </select>
                    </div>
                    <div style="padding: 12px; background: #fee2e2; border-radius: 8px; font-size: 0.85rem;">
                        <p style="margin: 0;"><strong>⚠️ 注意：</strong>使用 OpenAI API 会产生费用，请确保账户有足够余额。GPT-4 约 $0.03/1K tokens，GPT-3.5 约 $0.002/1K tokens。</p>
                    </div>
                </div>

                <p style="margin: 16px 0 0 0; font-size: 0.85rem; color: #64748b;">
                    💡 API Key 只保存在浏览器本地，不会上传到任何服务器
                </p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end; padding: 16px;">
                <button id="clearApiKey" class="filter-btn" style="background: #fee2e2; color: #991b1b;">清除</button>
                <button id="saveApiKey" class="filter-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">保存</button>
            </div>
        </div>
    </div>

    <!-- AI 学习助手模态框 -->
    <div id="aiAssistantModal" class="modal" style="display: none;">
        <div class="modal-content ai-assistant-modal">
            <div class="modal-header">
                <h2>🤖 AI 学习助手</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="settings-btn" id="openApiSettings" title="API 设置">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m0-12a9 9 0 0 1 9 9m-9-9a9 9 0 0 0-9 9m18 0a9 9 0 0 1-9 9m9-9h-6m-6 0H1m11 9a9 9 0 0 1-9-9"></path>
                        </svg>
                    </button>
                    <button class="close-btn" id="closeAIAssistant">
                        <span class="close-icon">×</span>
                    </button>
                </div>
            </div>
            <div class="modal-body ai-assistant-body">
                <div class="ai-context-panel">
                    <h4>📚 当前学习内容</h4>
                    <div id="aiContextInfo" class="context-info">
                        <div class="context-item">
                            <strong>频道：</strong><span id="aiChannelName">-</span>
                        </div>
                        <div class="context-item">
                            <strong>视频：</strong><span id="aiVideoTitle">-</span>
                        </div>
                        <div class="context-item">
                            <strong>你的观后感：</strong><span id="aiUserNotes">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="ai-extract-panel">
                    <h4>🎬 智能视频分析</h4>
                    <div class="extract-input-container">
                        <input type="url" id="youtubeUrlInput" placeholder="粘贴 YouTube 视频链接，AI 将自动提取内容并生成笔记..." />
                        <button id="extractVideoBtn" class="extract-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            提取内容
                        </button>
                    </div>
                    <div id="extractStatus" class="extract-status" style="display: none;">
                        <span class="status-dot"></span>
                        <span class="status-message">正在提取视频内容...</span>
                    </div>
                    <div id="videoTranscript" class="video-transcript" style="display: none;">
                        <h5>📝 视频内容摘要</h5>
                        <div id="transcriptContent"></div>
                    </div>
                </div>
                
                <div class="ai-suggestions-panel">
                    <h4>💡 智能问题建议</h4>
                    <div class="suggestion-categories">
                        <div class="category-tabs">
                            <button class="category-tab active" data-category="knowledge">📚 知识学习</button>
                            <button class="category-tab" data-category="life">🌱 生活成长</button>
                            <button class="category-tab" data-category="thinking">🧠 深度思考</button>
                            <button class="category-tab" data-category="english">🇺🇸 英语学习</button>
                        </div>
                        
                        <div class="suggestion-content">
                            <!-- 知识学习类问题 -->
                            <div class="suggestion-group active" data-category="knowledge">
                                <div class="group-title">基于布鲁姆分类法 & 费曼学习法</div>
                                <div class="suggestion-buttons">
                                    <button class="suggestion-btn" data-question="这个视频的核心观点是什么？用简单的话解释给我听">核心观点（理解）</button>
                                    <button class="suggestion-btn" data-question="如何将视频中的知识应用到我的实际生活和学习中？">实践应用（应用）</button>
                                    <button class="suggestion-btn" data-question="分析这个视频与其他学习内容的联系，构建知识网络">知识关联（分析）</button>
                                    <button class="suggestion-btn" data-question="基于这个视频，制定一个具体的学习计划和行动步骤">学习计划（综合）</button>
                                    <button class="suggestion-btn" data-question="推荐更多相关的学习资源和进阶内容">拓展资源（评价）</button>
                                </div>
                            </div>
                            
                            <!-- 生活成长类问题 -->
                            <div class="suggestion-group" data-category="life">
                                <div class="group-title">基于积极心理学 & 成长型思维</div>
                                <div class="suggestion-buttons">
                                    <button class="suggestion-btn" data-question="这个视频给我的生活态度带来了什么启发？">心态启发</button>
                                    <button class="suggestion-btn" data-question="我如何将视频中的价值观融入我的日常生活中？">价值观实践</button>
                                    <button class="suggestion-btn" data-question="这个视频如何帮助我做出更好的决策？">决策优化</button>
                                    <button class="suggestion-btn" data-question="视频中提到的哪些方法可以改善我的情感状态？">情感管理</button>
                                    <button class="suggestion-btn" data-question="基于这个视频，我可以设定哪些个人成长目标？">成长目标</button>
                                </div>
                            </div>
                            
                            <!-- 深度思考类问题 -->
                            <div class="suggestion-group" data-category="thinking">
                                <div class="group-title">基于苏格拉底式提问 & 批判性思维</div>
                                <div class="suggestion-buttons">
                                    <button class="suggestion-btn" data-question="我对视频中的观点有什么不同的看法？为什么？">批判思考</button>
                                    <button class="suggestion-btn" data-question="这个视频让我重新思考了什么人生问题？">反思启发</button>
                                    <button class="suggestion-btn" data-question="如果我要向朋友推荐这个视频，我会怎么说？">内化表达</button>
                                    <button class="suggestion-btn" data-question="视频中的观点与我之前的认知有什么冲突？如何调和？">认知整合</button>
                                    <button class="suggestion-btn" data-question="基于这个视频，我想进一步探索哪些相关的哲学或心理学问题？">深度探索</button>
                                </div>
                            </div>
                            
                            <!-- 英语学习类问题 -->
                            <div class="suggestion-group" data-category="english">
                                <div class="group-title">基于二语习得理论 & 交际教学法</div>
                                <div class="suggestion-buttons">
                                    <button class="suggestion-btn" data-question="这个视频中出现了哪些值得学习的英语词汇？请解释其用法和搭配">词汇学习</button>
                                    <button class="suggestion-btn" data-question="视频中的语法结构有什么特点？能给我举一些类似的例句吗？">语法分析</button>
                                    <button class="suggestion-btn" data-question="视频中使用了哪些地道的英语表达？如何在实际对话中运用？">地道表达</button>
                                    <button class="suggestion-btn" data-question="请帮我总结视频中的句式模式，并教我如何模仿造句">句式模仿</button>
                                    <button class="suggestion-btn" data-question="基于这个视频，给我设计一些英语口语练习和写作练习">语言练习</button>
                                    <button class="suggestion-btn" data-question="视频中的发音、语调有什么特点？如何提高我的英语发音？">发音指导</button>
                                    <button class="suggestion-btn english-analysis-btn" data-question="请全面分析这个视频的英语学习价值，包括词汇、语法、表达和发音等方面">全面英语分析</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="ai-chat-container">
                    <div class="chat-messages" id="aiChatMessages">
                        <div class="ai-message">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <p>你好！我是你的 AI 学习助手。</p>
                                <p><strong>智能功能：</strong></p>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li>📝 自动提取 YouTube 视频内容和字幕</li>
                                    <li>🤖 基于视频内容生成学习笔记（使用 GPT-4）</li>
                                    <li>💬 智能问答，帮助你深度理解内容</li>
                                    <li>📊 提供个性化学习建议</li>
                                    <li>🇺🇸 <strong>英语学习分析</strong>：词汇、语法、表达、发音</li>
                                </ul>
                                <p style="margin-top: 12px;">点击"提取内容"按钮开始分析视频，或直接问我问题！</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <!-- 快速建议按钮 -->
                        <div class="quick-suggestions" id="quickSuggestions" style="display: none;">
                            <div class="quick-suggestions-header">
                                <span class="quick-suggestions-title">💡 快速建议</span>
                                <button class="toggle-suggestions-btn" onclick="toggleQuickSuggestions()" title="收起建议">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <div class="quick-suggestions-content">
                                <button class="quick-suggestion-btn" onclick="insertSuggestion('这个视频的核心观点是什么？用简单的话解释给我听')">核心观点</button>
                                <button class="quick-suggestion-btn" onclick="insertSuggestion('如何将视频中的知识应用到我的实际生活和学习中？')">实践应用</button>
                                <button class="quick-suggestion-btn" onclick="insertSuggestion('这个视频给我的生活态度带来了什么启发？')">心态启发</button>
                                <button class="quick-suggestion-btn" onclick="insertSuggestion('我对视频中的观点有什么不同的看法？为什么？')">批判思考</button>
                                <button class="quick-suggestion-btn" onclick="insertSuggestion('这个视频中出现了哪些值得学习的英语词汇？请解释其用法和搭配')">词汇学习</button>
                            </div>
                        </div>
                        
                        <div class="chat-input">
                            <textarea id="aiChatInput" placeholder="问我关于这个视频的任何问题..." rows="2"></textarea>
                            <div class="chat-input-actions">
                                <button class="show-suggestions-btn" onclick="toggleQuickSuggestions()" title="显示建议">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </button>
                                <button id="sendAIMessage" class="send-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="ai-status" id="aiStatus">
                            <span class="status-indicator">●</span>
                            <span class="status-text">AI 助手就绪</span>
                        </div>
                    </div>
                    
                    <!-- 浮动建议按钮 -->
                    <div class="floating-suggestions-btn" id="floatingSuggestionsBtn" onclick="scrollToSuggestions()" title="查看所有建议">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span>建议</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 学习报告页面 -->
    <div id="learningReportPage" class="page" style="display: none;">
        <div class="page-header">
            <h2>📊 学习报告</h2>
            <div class="report-controls">
                <button class="filter-btn" id="generateReportBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    生成报告
                </button>
                <button class="filter-btn" id="exportReportBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    导出报告
                </button>
            </div>
        </div>
        <div class="report-content" id="reportContent">
            <div class="report-placeholder">
                <div class="placeholder-icon">📊</div>
                <h3>学习报告</h3>
                <p>点击"生成报告"按钮，AI 将分析你的观看历史并生成个人学习报告</p>
                <ul>
                    <li>📈 学习进度统计</li>
                    <li>🗺️ 知识地图可视化</li>
                    <li>🎯 技能聚合分析</li>
                    <li>📚 学习建议和规划</li>
                    <li>🇺🇸 英语学习追踪</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 已看视频页面 -->
    <div id="watchedVideosPage" class="page" style="display: none;">
        <div class="page-header">
            <h2>📝 已看视频</h2>
        </div>
        <div class="watched-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalWatchedVideos">0</div>
                <div class="stat-label">总观看数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalChannelsWatched">0</div>
                <div class="stat-label">涉及频道</div>
            </div>
        </div>
        <div id="watchedVideosContainer" class="watched-container">
            <!-- 已看视频列表将在这里动态生成 -->
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>用 ❤️ 制作 | 持续更新中</p>
        </div>
    </footer>
    <script>
// 频道数据 - 按照新的分类逻辑重新组织
const channelsData = [
    // Part 1: 成长力
    {
        category: "高效学习（星标）",
        starred: true,
        channels: [
            {
                name: "Emma Chamberlain",
                region: "美国",
                description: "最治愈的 Podcast 闺蜜——油管粉丝超 1190万+。她的 Podcast 像闺蜜茶话会，话题真实、轻松又有思考。常聊生活琐事与人生态度，语速自然，是练英语听力的宝藏。油管主频道以 vlog 与旅行视频为主，足迹遍布威尼斯、阿姆斯特丹、哥本哈根等地。",
                link: "https://www.youtube.com/@emmachamberlain",
                rating: 4
            },
            {
                name: "Ali Abdaal",
                region: "英国",
                description: "剑桥医学院毕业学霸，现为全职内容创作者（粉丝 569万+）。内容涵盖：高效学习、理财、写作、创业与生产力。代表课程：Skillshare《Productivity Masterclass》。另设频道 https://www.youtube.com/@DeepDiveWithAliAbdaal，每周访谈各界成功人士。",
                link: "https://www.youtube.com/@aliabdaal",
                rating: 5
            },
            {
                name: "Sydney Serena",
                region: "美国",
                description: "甜美系vlogger（粉丝 299万+）。内容涵盖生活vlog、收纳整理、心理健康与阅读。英语发音自然清晰，是轻松磨耳朵的好素材。",
                link: "https://www.youtube.com/@sydneyserena",
                rating: 4
            },
            {
                name: "Elizabeth Filips",
                region: "英国",
                description: "伦敦国王学院医学生、画家、作家，Ali 团队成员。探讨极简主义、容貌焦虑、自我成长。风格温柔理性，逻辑极强。",
                link: "https://www.youtube.com/@ElizabethFilips",
                rating: 5
            },
            {
                name: "Sienna Santer",
                region: "美国",
                description: "哈佛毕业的学习类博主。分享大学生活、学习方法与时间管理技巧。",
                link: "https://www.youtube.com/@siennasanter",
                rating: 5
            },
            {
                name: "Holly Gabrielle",
                region: "英国",
                description: "剑桥生物系第一名毕业。主讲主动复习法、高效笔记与学习规划。",
                link: "https://www.youtube.com/@HollyGabrielle",
                rating: 5
            },
            {
                name: "Ruby Granger",
                region: "英国",
                description: "英伦学习风代表。牛津研究生，内容涵盖学习技巧、书单、vlog。",
                link: "https://www.youtube.com/@RubyGranger8",
                rating: 5
            },
            {
                name: "PaigeY",
                region: "英国",
                description: "剑桥大学学霸。学习高效但不焦虑，居家学习vlog极具参考性。",
                link: "https://www.youtube.com/@PaigeY",
                rating: 4
            },
            
        ]
    },
    {
        category: "高效学习（其他推荐）",
        starred: false,
        channels: [
            {
                name: "UnJaded Jade",
                region: "德国/英国",
                description: "德国留学生，以积极向上的vlog记录独立生活。风格明快有活力，展示理想主义青年的欧洲留学日常。",
                link: "https://www.youtube.com/@UnJadedJade",
                rating: 5
            },
            
            {
                name: "Thomas Frank",
                region: "美国",
                description: "效率与自我管理领域的权威。粉丝 241万+，是 Notion 官方合作博主。系统讲解 时间管理、笔记方法、学习策略、效率App使用。视频逻辑极强、表达自然，是学生与职场人必追频道。",
                link: "https://www.youtube.com/@Thomasfrank",
                rating: 5
            },
            {
                name: "Tiago Forte",
                region: "美国",
                description: "知识管理与效率大师，第二大脑（Building a Second Brain）理念创始人。教你如何构建数字笔记系统（Notion、Obsidian、Evernote等）。通过 PARA 模型（Projects / Areas / Resources / Archives）重塑学习与思维方式。对研究者、学生、设计师特别有帮助。",
                link: "https://www.youtube.com/@TiagoForte",
                rating: 5
            },
            
            
            {
                name: "Hanna Vanharanta",
                region: "香港/芬兰",
                description: "多文化背景大学生，分享跨国学习与生活体验。内容涵盖宿舍布置、学习日常、朋友互动等，气质自然温柔。英语发音清晰，非常适合听力模仿与口语积累。",
                link: "https://www.youtube.com/@HannaVanharanta",
                rating: 4
            },
            {
                name: "Matt D'Avella",
                region: "美国",
                description: "极简主义与高效生活倡导者。Netflix 纪录片《Minimalism》导演之一。分享习惯养成、心理健康、极简思维等内容。名言：If it won't matter in 5 years, don't spend more than 5 minutes worrying about it.",
                link: "https://www.youtube.com/@mattdavella",
                rating: 5
            },
            {
                name: "Kharma Medic",
                region: "加拿大",
                description: "医学生、YouTuber 与 Ali Abdaal 的好友。分享真实的医生日常、学习计划与医学备考。讲解细腻、语气温暖，是医学生与理科生的学习榜样。",
                link: "https://www.youtube.com/@KharmaMedic",
                rating: 5
            },
            
        ]
    },
    {
        category: "英语学习",
        starred: false,
        channels: [
            {
                name: "Veronika's Language Diaries",
                region: "捷克",
                description: "以科学方法教授英语与多语言学习的大神级博主。她用亲身经历证明——只要方法得当，任何人都能流利掌握一门语言。",
                link: "https://www.youtube.com/@veronikas.languagediaries",
                rating: 5
            },
            {
                name: "English Speaking Success (Keith)",
                region: "英国",
                description: "前雅思考官，以幽默风趣的风格教授英语口语与写作技巧。内容涵盖雅思备考、idioms与日常口语，直播课程互动性极强。",
                link: "https://www.youtube.com/@EnglishSpeakingSuccess",
                rating: 4
            },
            {
                name: "English Fluency Journey",
                region: "美国",
                description: "以 Speak with Me 栏目著称，设计对话场景提升语感。适合希望培养英语思维与真实口语交流感的学习者。",
                link: "https://www.youtube.com/@EnglishFluencyJourney",
                rating: 5
            },
            {
                name: "Speak English With Tiffany",
                region: "美国",
                description: "风格亲切实用，帮助学习者掌握真正被使用的英语表达。视频内容涵盖生活对话、语法讲解与口语提升技巧。",
                link: "https://www.youtube.com/%40SpeakEnglishWithTiffani?utm_source=chatgpt.com",
                rating: 5
            },
            {
                name: "Chen Lily",
                region: "台湾/加拿大",
                description: "语言教育硕士，用双语字幕讲述英语学习与海外生活。每期 vlog 高亮重点词汇、自然表达，非常适合精听与模仿。",
                link: "https://www.youtube.com/@ChenLily",
                rating: 5
            }
        ]
    },
    {
        category: "职场成长",
        starred: false,
        channels: [
            {
                name: "Lillian Chiu",
                region: "中国/美国",
                description: "纽约 Spotify 商业分析师，分享科技职场成长与生活管理。表达清晰自然，帮助亚洲观众了解真实的海外职场文化。",
                link: "https://www.youtube.com/@LillianChiu101",
                rating: 5
            },
            {
                name: "Matt Huang",
                region: "中国/美国",
                description: "前 BCG 咨询顾问、现 Google 战略部门成员。专注求职、面试与故事表达技巧，内容极具实操性。",
                link: "https://www.youtube.com/@matthuang21",
                rating: 5
            },
            {
                name: "Leila Hormozi",
                region: "美国",
                description: "创业者、效率达人，以干脆利落的无废话风格著称。分享决策力、执行力与创业思维，是 Hustle Culture 的代表人物。",
                link: "https://www.youtube.com/@leilahormozi",
                rating: 5
            }
        ]
    },
    
    // Part 2: 文化碰撞
    {
    category: "亚裔生活",
        starred: false,
        channels: [
            {
                name: "Yoora Jung",
                region: "韩国",
                description: "主修神经科学的韩国美女学霸，以 vlog、学习与旅行为主。语速适中、口音自然，是练听力与激励学习的宝藏频道。",
                link: "https://www.youtube.com/@yoorajung",
                rating: 5
            },
            {
                name: "daiz",
                region: "加拿大/韩裔",
                description: "Pinterest girl 风格代表。加拿大韩裔大学生，内容涵盖学习、美妆与生活 vlog。画面治愈、节奏舒适、语速适中，是英语学习与生活美学兼得的频道。",
                link: "https://www.youtube.com/@daisychoiii",
                rating: 4
            },
            {
                name: "Saranghoe (Tracy)",
                region: "加拿大/韩裔",
                description: "加拿大韩裔大学生。内容自然真实，美妆与生活分享并重，兼具轻松氛围与生活美感。",
                link: "https://www.youtube.com/@tracysohn",
                rating: 5
            },
            {
                name: "Michelle Choi",
                region: "美国/韩裔",
                description: "YouTube 治愈系代表人物。内容涵盖生活vlog、独居思考、心理成长与都市孤独感。她的Living Alone Diaries系列被誉为最温柔的自我疗愈频道。声音平静、语速适中，极适合睡前或晨间收听。",
                link: "https://www.youtube.com/@michellechoii",
                rating: 5
            },
            {
                name: "mishujo",
                region: "韩国",
                description: "医学生，也是 Yoora 的忠实粉丝与好友，视频风格温暖积极。记录医学生的平凡日常与自我成长，非常真实。",
                link: "https://www.youtube.com/@mishujo",
                rating: 4
            },
            {
                name: "sallykim7",
                region: "美国/韩裔",
                description: "在美国四大会计师事务所工作，分享职场与生活平衡。画面风格高级、节奏平和，适合培养盲听能力。",
                link: "https://www.youtube.com/@sallykim7",
                rating: 4
            },
            {
                name: "Yoon Kai",
                region: "韩国",
                description: "计算机系博主，风格极简冷淡。视频构图精致、叙述自律。是极简主义与理性美的完美结合。",
                link: "https://www.youtube.com/@yoonkai",
                rating: 5
            },
            {
                name: "Mikayla Mags",
                region: "美国/菲律宾裔",
                description: "充满活力与正能量的创作者。她的视频节奏舒适自然，融合学习、生活方式与成长故事。",
                link: "https://www.youtube.com/@mikaylamags",
                rating: 5
            },
            {
                name: "Jusuf",
                region: "瑞士/菲律宾裔",
                description: "温柔沉静的学习博主，画面审美极高。Gap 3 年后重返校园，以淡然叙述展现自律与生命韧性。",
                link: "https://www.youtube.com/@Jusufreinhard",
                rating: 5
            }
            ,
            {
                name: "Caitlin Lam",
                region: "纽约/亚裔",
                description: "纽约艺术与生活方式创作者，分享搬到纽约、哈佛日常、艺术创作记录等。风格温柔干净，是文艺青年学习vlog的代表。",
                link: "https://www.youtube.com/%40caitshouse?utm_source=chatgpt.com",
                rating: 5
            },
            {
                name: "Nicole Laeno",
                region: "加州/菲律宾-越南裔",
                description: "高中生学习生活代表。内容包括学校vlog、考试准备、舞蹈日常与朋友互动。语言自然真实，是沉浸式英语听力的理想素材。",
                link: "https://www.youtube.com/@nicolelaeno",
                rating: 4
            },
            {
                name: "Mmiakim",
                region: "北美/韩裔",
                description: "韩裔神经科学专业学霸。视频节奏平静，画面干净整洁，专注学习与思考的真实状态。她代表了一种慢而稳的自律，极适合喜欢沉浸学习氛围的观众。",
                link: "https://www.youtube.com/@mmiakim",
                rating: 5
            },
            {
                name: "Jedcal",
                region: "洛杉矶/亚裔",
                description: "范德堡大学毕业，现居洛杉矶。以大学生活、健身与自我成长为主线，风格清爽自然。他的视频节奏舒缓、口音清晰，是沉浸式听力与生活灵感的完美结合。推荐主题：《A Day in My Life at Vanderbilt》《My Morning Routine for Productivity》。",
                link: "https://www.youtube.com/@jedcal",
                rating: 4
            },
            {
                name: "Jasmine Le",
                region: "加州/越南裔",
                description: "在美留学生，风格温柔真诚。内容涵盖校园、时尚與生活感悟。她的视频节奏温和，常带有轻音乐与日记口吻，适合放松学习之余觀看。",
                link: "https://www.youtube.com/@jasminele",
                rating: 4
            }
            
        ]
    },
    {
        category: "海外华人生活",
        starred: false,
        channels: [
            {
                name: "Fred Liu",
                region: "中国/西雅图",
                description: "来自西雅图，目前就读于 西北大学（Northwestern University）。以 大学生活 vlog、幽默短剧、Q&A 为主，内容自然真实、节奏明快。吐字清晰，发音标准，语气轻松幽默，是提升英语听力与口语表达的绝佳素材。以独特的温柔理性 + 轻喜剧式剪辑风格走红，深受北美留学生与Z世代观众喜爱。",
                link: "https://www.youtube.com/%40Freddielooo?utm_source=chatgpt.com",
                rating: 4
            },
            {
                name: "Annie Fang",
                region: "中国/美国",
                description: "在美国私立高中就读的中国女生，美丽、自信、充满生活热情。主打 Intuitive Eating（直觉饮食），帮助观众摆脱身材与容貌焦虑。她的视频充满美食与温柔能量——边看边吃饭，都会变得更香！",
                link: "https://www.youtube.com/@anniefang5531",
                rating: 4
            },
            {
                name: "Breanna Quan",
                region: "中国/加拿大",
                description: "学习型vlogger，逻辑清晰、表达自然。通过talk形式探讨成长与自律。",
                link: "https://www.youtube.com/@breannaquan",
                rating: 5
            },
            {
                name: "itsyuyan",
                region: "中国/纽约",
                description: "以美式辣妹风穿搭走红，兼具时尚与真实生活感。Room Tour 视频信息量极高，适合学习生活类英文表达。",
                link: "https://www.youtube.com/@itsyuyan",
                rating: 5
            },
            {
                name: "Via Li",
                region: "中国/加拿大",
                description: "以真诚与自省著称的创作者。视频主题包括：没有朋友怎么办、如何变得更自信、如何走出情绪低谷。她的表达细腻真挚，常用第一人称讲述自己在人际与成长中的真实挣扎与转变。她代表了一种安静的力量，鼓励观众与自己和解。",
                link: "https://www.youtube.com/@ivyylii",
                rating: 4
            },
            {
                name: "Oh Emma",
                region: "中国/加拿大",
                description: "定居加拿大多伦多的华人生活方式博主，以 vlog、美妆与日常穿搭走红。因分享真实生活态度与轻松幽默的表达风格受到观众喜爱。曾凭吃螺蛳粉视频爆红，后合作多家国际品牌，逐渐转型为成熟独立女性代表。频道内容涵盖家庭、职场、旅行与自我成长，展现温柔又有力量的女性形象。",
                link: "https://www.youtube.com/@ohemma007",
                rating: 5
            },
            {
                name: "ReginaKnowsss",
                region: "中国/加拿大",
                description: "多伦多华人博主，Oh Emma 的好友，两人常合作拍摄 vlog 或互相關注互動。她的视频内容以生活记录、穿搭分享、独居女性的成长心境为主。表达细腻、语气温柔、充满故事感，像是在深夜与你推心置腹地聊天。她分享成熟女性的理性、温柔与独立，是北美华人圈中極具气质的代表。",
                link: "https://www.youtube.com/@reginaknows9443",
                rating: 5
            },
            {
                name: "Savislook",
                region: "中国",
                description: "北美时期成名的時尚博主，現已回國發展。穿搭與家居審美極高，近期懷上雙胞胎。",
                link: "https://www.youtube.com/@savislook",
                rating: 5
            },
            {
                name: "VickySoupsss",
                region: "中国/加州",
                description: "海外华人代表博主，与丈夫涤纶定居美国。记录幸福婚姻、家庭生活与育儿日常。",
                link: "https://www.youtube.com/@vickysoupsss",
                rating: 5
            },
            {
                name: "Hola! Fiona",
                region: "中国/德国",
                description: "来自上海，现居德国的生活方式博主，以温柔语气与真实日常打动观众。从留学到结婚、生子，她的视频记录了自己在德国的生活点滴——学德语、做饭、旅行、带娃。她与丈夫鋼鐵侠感情穩定，互動自然，是溫柔而獨立的代表。內容輕鬆治愈，節奏舒缓，展現了異國生活中認真的小確幸。",
                link: "https://www.youtube.com/@holafiona5882",
                rating: 5
            },
            {
                name: "Rainie Tian",
                region: "中国/加拿大",
                description: "早期起号的美妆vlogger，性格陽光開朗。婚后依然坚持更新，分享生活點滴。",
                link: "https://www.youtube.com/@rainietian",
                rating: 5
            },
            {
                name: "Miwivon",
                region: "中国/英国",
                description: "伦敦留学时期出圈，以慵懒自然风格著称。现已创业并创立个人品牌，边工作边看世界。",
                link: "https://www.youtube.com/@miwivon",
                rating: 5
            },
            {
                name: "Meng Mao",
                region: "中国/法国",
                description: "四川女孩旅法時尚博主，常出入欧洲時尚圈。擅長混搭設計師品牌，時尚品味極高。",
                link: "https://www.youtube.com/results?search_query=Meng+Mao",
                rating: 5
            },
            {
                name: "Krysti Naaa",
                region: "中国/美国",
                description: "定居美国的华人博主，以 美妆、穿搭、生活 vlog 闻名。视频风格温柔真实，常分享与丈夫（昵称腾哥）的日常点滴，两人互动自然甜蜜。画面质感高级，色调温暖，内容涵盖居家生活、旅行记录与情侣互动。近年随家庭回国定居杭州，依旧保持积极更新与细腻生活分享。",
                link: "https://www.youtube.com/@KrystiNaaa",
                rating: 5
            },
            {
                name: "Annbition",
                region: "中国/欧洲",
                description: "审美与创业并重的生活方式博主，创立个人品牌 安的玫瑰庄园，主打玫瑰香氛洗护系列。视频融合 香氛、美妆、家庭与旅行，风格温柔细腻，展现她将生活过成艺术的方式。她以理性与浪漫并存的气质，诠释了独立女性的优雅与创造力。",
                link: "https://www.youtube.com/@annbition7558",
                rating: 5
            },
            {
                name: "Renasteps (刘虞佳)",
                region: "中国/韩国",
                description: "生活在韩国的华人博主，婚后与韩籍丈夫育有两子。从焦虑到松弛，她以真实、温柔而坚韧的叙述记录自我成长与家庭生活。视频风格治愈细腻，倡导女性独立、自我爱与内心平衡，传递松弛而有力量的生活态度。",
                link: "https://www.youtube.com/@renasteps",
                rating: 5
            },
            {
                name: "Hilary Chen",
                region: "中国/美国",
                description: "哈佛大学毕业生，央视主持人史小诺之女。以自律健康的生活方式闻名，频道内容涵盖学习、健身、饮食与日常vlog。她的视频节奏清爽自然，展现知性优雅又踏实努力的成长轨迹。",
                link: "https://www.youtube.com/@HilaryChen",
                rating: 5
            },
            {
                name: "Della Qin",
                region: "中国/美国",
                description: "Hilary Chen 的闺蜜，拥有美高 + 美本教育背景。大学时期以恋爱日常与校园生活 vlog 走红，视频风格轻松自然，展现青春与浪漫。回国后更新频率减少，但依旧保持温柔真诚的表达。",
                link: "https://www.youtube.com/@DellaQin",
                rating: 5
            },
            {
                name: "Anny Shi",
                region: "中国/美国",
                description: "出身音乐世家，毕业于伯克利音乐学院（Berklee College of Music）。回国后继续攻读清华大学硕士学位，兼顾学业与艺术创作。现已结婚怀孕，视频记录她多彩的人生旅程与温柔坚定的成长。",
                link: "https://www.youtube.com/@AnnyShi",
                rating: 5
            },
            {
                name: "胖丁 Wenning",
                region: "中国/加拿大",
                description: "以与小学同桌重逢并结婚的甜蜜故事走红，分享真实又温馨的生活日常。她的视频充满温度与生活感，记录爱情、家庭与自我成长的点滴。是努力又幸运的代表，用笑容和故事治愈无数观众。",
                link: "https://www.youtube.com/@wenning5677",
                rating: 5
            },
            {
                name: "Phiphiwearswhat",
                region: "中国/美国",
                description: "自由松弛的生活方式博主，以穿搭、美学与日常 vlog 记录独立女性的生活状态。内容涵盖旅行、婚姻、家庭与自我成长，展现如何优雅经营生活的温柔哲学。视频色调柔和、节奏舒缓，兼具视觉美感与内心平衡感。",
                link: "https://www.youtube.com/@Phiphiwearswhat",
                rating: 5
            },
            {
                name: "Nuria Ma",
                region: "中国/伦敦",
                description: "现居伦敦大学生，以时尚与日常 vlog 闻名。代表作：《Shopping Alone in London》《Attending the British Fashion Awards》。",
                link: "https://www.youtube.com/%40Nuriamaa?utm_source=chatgpt.com",
                rating: 5
            }
        ]
    },
    {
        category: "英音学习",
        starred: false,
        channels: [
            {
                name: "Dr Izzy Sealey（凯琦）",
                region: "英国",
                description: "剑桥大学医学生，兼具智慧与温柔气质。内容涵盖英音发音技巧、语言学习与成长vlog。她的视频像一场知性晨读，让人获得平静与力量。",
                link: "https://www.youtube.com/@IzzySealey",
                rating: 5
            },
            {
                name: "Zeliha Akpinar",
                region: "英国",
                description: "英国医学生博主，以高效自律著称——凌晨四点起床、八点睡觉。内容包含学习经验、vlog与成长心态，节奏舒缓治愈。看她的视频仿佛回到无忧的大学岁月。",
                link: "https://www.youtube.com/@zelihaakpinar",
                rating: 5
            },
            {
                name: "Zoella",
                region: "英国",
                description: "英国最具影响力的美妆与生活方式博主之一。分享化妆、日常vlog与恋爱生活，是英伦甜妹代表。她的语音清晰自然，是学习英音的好素材。",
                link: "https://www.youtube.com/user/morezoella",
                rating: 5
            },
            {
                name: "Ellen Miller",
                region: "英国",
                description: "小众书评与生活vlogger，擅长讲述故事与思考感受。以阅读vlog和文学表达著称，语言优美且富有感染力。适合喜欢文学、想提升表达力的观众。",
                link: "https://www.youtube.com/@ellenalicemiller",
                rating: 5
            },
            {
                name: "emmaxolouise",
                region: "英国",
                description: "发音纯正、语调柔和的英音学习类博主。视频内容涵盖学习日常、生活vlog与英语练习。适合英音爱好者练听力与模仿发音。",
                link: "https://www.youtube.com/@emmaxolouise",
                rating: 5
            }
        ]
    },
    
    // Part 3: 生活探索
    {
        category: "治愈系生活",
        starred: false,
        channels: [
            {
                name: "ur mom ashley",
                region: "美国/韩裔",
                description: "Ashley是一位来自纽约的韩裔美籍生活方式博主。她以明朗幽默的性格、轻松自然的vlog和贴近生活的分享而深受喜爱。她的内容涵盖日常生活、穿搭、美妆、健身与旅行，展现出阳光、自信、真实的纽约女孩魅力。",
                link: "https://www.youtube.com/@urmomashley",
                rating: 5
            },
            {
                name: "Kelly Wakasa",
                region: "美国",
                description: "Kelly是一位来自纽约的创作者，以roommate series（室友系列）广受欢迎。他的视频风格轻松有趣，擅长捕捉朋友间的真实互动与温暖瞬间。内容涵盖vlog、人生思考、挑战与城市探索，常与Elliot和Ashley一同出镜，形成了充满青春气息的纽约室友组合。",
                link: "https://www.youtube.com/@KellyWakasa",
                rating: 4
            },
            {
                name: "Elliot Choy",
                region: "美国/韩裔",
                description: "Elliot是一位韩裔美籍博主，以高质量的城市生活vlog著称。他的镜头语言成熟细腻，擅长记录生活节奏、思考与自我成长的片段。与Kelly和Ashley共同拍摄的室友系列宛如现实版《老友记》，展现了纽约年轻人真实的社交与生活方式。",
                link: "https://www.youtube.com/@ElliotChoy",
                rating: 4
            },
            {
                name: "Natalie Lynn",
                region: "美国",
                description: "20 岁天才导演型 vlog 创作者，以电影级画面与叙事闻名。代表作：《I Just Turned 20 And I Feel Alive》《I Left Everything To Live In A Van》。",
                link: "https://www.youtube.com/@nataliexlynn",
                rating: 5
            },
            {
                name: "Leah's Fieldnotes",
                region: "加拿大/华裔",
                description: "气质温柔的慢生活博主，内容包括农场生活、情绪袒露与素食料理。视频舒缓治愈，是许多人心灵放松的首选。",
                link: "https://www.youtube.com/@leahsfieldnotes",
                rating: 5
            },
            {
                name: "craziejulia",
                region: "美国/日本",
                description: "从南加大学生到旅居日本的冒险vlogger。视频展示生活有无限可能的精神。",
                link: "https://www.youtube.com/%40craziejulia3833?utm_source=chatgpt.com",
                rating: 5
            }
        ]
    },
    {
        category: "情感与成长",
        starred: false,
        channels: [
            {
                name: "Lana Blakely",
                region: "瑞典",
                description: "一位来自瑞典的哲思系 YouTuber，以温柔细腻的叙述和深度思考闻名。她的视频常探讨 孤独、友谊、自我成长、情感关系与哲学思考 等主题，搭配极简柔光画面与宁静音乐，氛围感极强。Lana用平静而真诚的语气分享对生活与自我认知的反思，像一位陪你夜谈的朋友，让人看完总能获得力量与宁静。",
                link: "https://www.youtube.com/@lanablakely",
                rating: 4
            },
            {
                name: "Matthew Hussey",
                region: "英国",
                description: "情感与心理成长导师，亦是 Ali Abdaal 的好友。内容涵盖人际关系、自我价值与内核稳定，理性拆解情绪价值与如何在关系中做自己。语气坚定、逻辑清晰，是理解情绪与提升沟通力的绝佳导师。",
                link: "https://www.youtube.com/@thematthewhussey",
                rating: 4
            },
            {
                name: "Malama Life",
                region: "美国/韩裔",
                description: "韩国裔博主，主打极简主义与慢生活。内容包含断舍离、生活哲学与心理疗愈，画面宁静唯美。",
                link: "https://www.youtube.com/@malamalife",
                rating: 5
            },
            {
                name: "Rowena Tsai",
                region: "",
                description: "温柔理性、像一位陪伴你成长的朋友。视频聚焦心理健康、自我关怀与人生规划。",
                link: "https://www.youtube.com/@rowena",
                rating: 5
            },
            {
                name: "Katia Nikolajew",
                region: "",
                description: "声音治愈、节奏舒缓，分享自我修复与情绪疗愈的真实旅程。",
                link: "https://www.youtube.com/@KatiaNikolajew",
                rating: 4
            },
            {
                name: "Linh Truong",
                region: "",
                description: "风格清新自然，内容聚焦极简主义、环保生活与自我平衡。",
                link: "https://www.youtube.com/@withlovelinh",
                rating: 4
            },
            {
                name: "Alyssa Lenore",
                region: "",
                description: "镜头感极强的生活方式博主，记录理性又优雅的都市日常。",
                link: "https://www.youtube.com/@alyssa.lenore",
                rating: 5
            },
            {
                name: "Jasmine Lipska",
                region: "",
                description: "探索灵性疗愈、自我接纳与爱的力量，用温柔能量陪伴观众成长。",
                link: "https://www.youtube.com/@jasminelipska",
                rating: 5
            },
            {
                name: "Tiffany Ferg",
                region: "",
                description: "以深度分析视频Internet Analysis系列著称，探讨社会、文化与成长。",
                link: "https://www.youtube.com/@tiffanyferg",
                rating: 4
            },
            {
                name: "MuchelleB",
                region: "",
                description: "Notion女孩代表！内容涵盖时间管理、目标设定、效率提升技巧。",
                link: "https://www.youtube.com/@muchelleb",
                rating: 5
            },
            {
                name: "Moya Mawhinney",
                region: "",
                description: "来自北爱尔兰的vlogger，用诗意影像记录安静思考与日常温柔。",
                link: "https://www.youtube.com/@moyamawhinney",
                rating: 5
            },
            {
                name: "Natalie Barbu",
                region: "",
                description: "诚实分享个人成长、创业心路与情绪变化，像朋友间的真心夜聊。",
                link: "https://www.youtube.com/@NatalieBarbu",
                rating: 5
            },
            {
                name: "Lavendaire",
                region: "",
                description: "美籍华人博主、成长类代表人物，传递积极能量与自我觉察的力量。",
                link: "https://www.youtube.com/@lavendaire",
                rating: 5
            }
        ]
    },
    {
        category: "娱乐",
        starred: false,
        channels: [
            {
                name: "Avenue X",
                region: "中国",
                description: "用流利英语讲中国影视剧评论的频道。内容包含剧情分析、表演点评与文化视角，让英语学习与追剧两不误。",
                link: "https://www.youtube.com/@AvenueX123",
                rating: 4
            },
            {
                name: "Hailey Rhode Bieber",
                region: "美国",
                description: "主持热门访谈系列《Who's in My Bathroom?》。邀请 Kendall Jenner、Kim Kardashian 等明星畅聊生活与真心话，节目轻松有趣，融合聊天、美食与娱乐。",
                link: "https://www.youtube.com/@HaileyRhodeBieber",
                rating: 5
            }
        ]
    },
    {
        category: "生活方式",
        starred: false,
        channels: [
            {
                name: "Kate Brock",
                region: "加拿大",
                description: "来自加拿大的高中生活方式博主，视频充满自然光与柔和滤镜。记录学习日常、校园生活、穿搭与自我成长，被称为宝藏少女。",
                link: "https://www.youtube.com/%40katebrock_?utm_source=chatgpt.com",
                rating: 5
            },
            // Caitlin Lam 已移至 亚裔生活
            {
                name: "Kaiti Yoo",
                region: "美国",
                description: "兼具学霸与时尚感，以快节奏、高剪辑展现酷女孩成长。主题涵盖穿搭、效率、自我提升与商业思维，极具启发性。",
                link: "https://www.youtube.com/@KaitiYoo",
                rating: 4
            },
            {
                name: "bestdressed",
                region: "美国",
                description: "复古美学与创意改造代表，曾因旧衣改造系列爆红。语速偏快、风格独特、叙事幽默，被誉为旧衣改造女王。",
                link: "https://www.youtube.com/@bestdressed",
                rating: 4
            },
            {
                name: "HJ Evelyn",
                region: "美国/韩裔",
                description: "韩裔美籍vlogger，以家庭搞笑vlog著称。轻松有趣、笑点密集，是快乐学英语的理想选择。",
                link: "https://www.youtube.com/%40hjevelynha?utm_source=chatgpt.com",
                rating: 4
            },
            {
                name: "Mai Pham",
                region: "加拿大/越裔",
                description: "越裔加拿大YouTuber，年轻有为、语速超快。内容涵盖旅行、美妆与成长故事，节奏明快、极具活力。",
                link: "https://www.youtube.com/@maiphammy",
                rating: 4
            }
        ]
    },
    {
        category: "健身与自律",
        starred: false,
        channels: [
            {
                name: "Pick Up Limes",
                region: "荷兰/印度裔",
                description: "荷兰印度裔营养师，分享 vegan 素食、心理健康与极简生活。声音温柔、画面治愈，被誉为生活美学与温柔哲学结合体。",
                link: "https://www.youtube.com/@PickUpLimes",
                rating: 5
            },
            {
                name: "Sanne Vloet",
                region: "荷兰",
                description: "前维密模特，从极端节食转向健康强壮之美。频道融合健身、高蛋白食谱与wellness理念，画面清新。",
                link: "https://www.youtube.com/@SanneVloet",
                rating: 5
            },
            {
                name: "LenaLifts",
                region: "英国",
                description: "倡导力量美与自信成长的女性健身博主。拒绝白幼瘦审美，分享训练计划与饮食建议。",
                link: "https://www.youtube.com/@lenalifts",
                rating: 5
            },
            {
                name: "The Fitness Marshall",
                region: "美国",
                description: "最欢乐的健身频道之一，边跳舞边搞笑！推荐：《Seven Rings》《How You Like That》《Teenage Dream》。",
                link: "https://www.youtube.com/@TheFitnessMarshall",
                rating: 4
            }
        ]
    },
    {
        category: "时尚与美妆",
        starred: false,
        channels: [
            {
                name: "Tam Kaur",
                region: "英国/印度裔",
                description: "印度裔英国博主，聚焦女性自信与思维转变。内容涵盖Lucky Girl Syndrome、自我价值提升等。",
                link: "https://www.youtube.com/@TamKaur",
                rating: 5
            },
            {
                name: "Lydia Tomlinson",
                region: "英国",
                description: "英伦优雅风时尚博主，擅长简约气质穿搭。视频节奏快但表达自然，是职场穿搭学习范本。",
                link: "https://www.youtube.com/%40LydiaJaneTomlinson",
                rating: 4
            },
            {
                name: "Sincerely, Sarah",
                region: "美国",
                description: "美妆博主，以自然美音分享淡颜欧美妆。语言地道，适合模仿发音和学习化妆术语。",
                link: "https://www.youtube.com/%40SarahC?utm_source=chatgpt.com",
                rating: 5
            },
            {
                name: "Ellie Thumann",
                region: "美国",
                description: "模特兼vlogger，主要分享旅行与时尚生活。语速适中，适合作为听力素材。",
                link: "https://www.youtube.com/@EllieThumannn",
                rating: 4
            }
        ]
    },
    
    // Part 4: 创造力
    {
        category: "阅读与思考",
        starred: false,
        channels: [
            {
                name: "Jack Edwards",
                region: "英国",
                description: "英国顶流Booktuber，以文艺幽默的方式推荐新旧文学作品。内容涵盖小说、诗歌、散文与冷门佳作，被誉为书香界的酷男孩。视频节奏轻松，审美极高。",
                link: "https://www.youtube.com/results?search_query=Jack+Edwards",
                rating: 5
            },
            {
                name: "The Book Leo",
                region: "荷兰",
                description: "荷兰创作者，视频色调温暖，善用图表讨论流行书vs深度阅读。她以逻辑清晰的表达与治愈氛围著称，常探讨书圈文化与阅读趋势。语速慢、发音清晰，听力素材极佳。",
                link: "https://www.youtube.com/@TheBookLeo",
                rating: 5
            },
            {
                name: "Robin Waldun",
                region: "爱尔兰",
                description: "哲学与思辨类代表博主。内容探讨如 Why We Can't Enjoy Anything Anymore、The Modern Obsession with Meaning 等议题。视频风格深邃理性却不艰涩，如同一场深夜的哲学讲座。结合文学、存在主义与现代心理学，极适合热爱思考与写作的观众。",
                link: "https://www.youtube.com/@RCWaldun",
                rating: 5
            },
            {
                name: "A Clockwork Reader",
                region: "",
                description: "以 Dark Academia 风格与情感共鸣著称。她的书评细腻真挚，尤其是对《Babel》的读后感让人泪目。视频兼具文学深度与心理疗愈感。",
                link: "https://www.youtube.com/@AClockworkReader",
                rating: 4
            },
            {
                name: "Jen Campbell",
                region: "英国",
                description: "英国作家与编辑，分享即将出版的新书与文学评论。内容涉猎广泛——小说、诗歌、童书、绘本、非虚构。表达专业温柔，是了解出版界动态的绝佳选择。",
                link: "https://www.youtube.com/%40jenvcampbell?utm_source=chatgpt.com",
                rating: 4
            },
            {
                name: "CarolynMarieReads",
                region: "",
                description: "插画师兼文学爱好者，喜欢童书与文学小说。视频温柔舒缓，兼具艺术与人文气质。书单丰富，适合想培养阅读仪式感的观众。",
                link: "https://www.youtube.com/@CarolynMarieReads",
                rating: 4
            },
            {
                name: "The Poptimist",
                region: "",
                description: "宝藏大叔级书评人，以反流量焦虑的态度推荐冷门好书。他用词考究，观点深刻，常发掘 Goodreads 上被低估的文学作品。视频节奏平稳，极具启发性。",
                link: "https://www.youtube.com/@ThePoptimist",
                rating: 4
            },
            {
                name: "Benjamin McEvoy",
                region: "英国",
                description: "英国学术派读书博主，专攻名著精读与阅读方法。倡导慢读主义，如《追忆似水年华》每日10页计划。语言深刻，是提升阅读耐心与理解力的最佳伙伴。",
                link: "https://www.youtube.com/@BenjaminMcEvoy",
                rating: 4
            },
            {
                name: "Throne of Pages",
                region: "",
                description: "真实可爱的书评博主，常做月度阅读总结与Notion模板分享。口语清晰自然，适合边学英语边听她讲读书。视频风格轻松、真实、有生活感。",
                link: "https://www.youtube.com/@Throneofpages",
                rating: 4
            },
            {
                name: "e m m i e (@emmiereads)",
                region: "",
                description: "英语文学系学生，分享读书vlog与安静专注的学习日常。风格温柔内敛，被称为《正常人》女主现实版。内容包括阅读计划、经典书籍盘点与学习灵感。",
                link: "https://www.youtube.com/@emmiereads",
                rating: 5
            },
            {
                name: "Christy Anne Jones",
                region: "",
                description: "澳大利亚作家兼插画师，记录写作与读书生活。系列包括尝试名作家写作习惯和写小说计划。氛围平静、极适合study with me或写作陪伴。",
                link: "https://www.youtube.com/@ChristyAnneJones",
                rating: 4
            },
            {
                name: "JustAli",
                region: "",
                description: "轻文艺风Booktuber，频道包含书单推荐、购书分享与阅读日常。她以真诚自然的语气介绍自己热爱的书籍，让阅读更轻盈。适合初学者或想重拾阅读乐趣的人。",
                link: "https://www.youtube.com/c/JustAli?utm_source=chatgpt.com",
                rating: 5
            },
            {
                name: "John Fish",
                region: "",
                description: "哈佛计算机科学毕业生，现居加州。分享学习方法、心流理论与阅读心得。他倡导用阅读改变思维模式，是高智思考系博主代表。",
                link: "https://www.youtube.com/@thejohnfish",
                rating: 4
            },
            {
                name: "Haley Pham Vlogs",
                region: "",
                description: "主打流行书测评与畅销书讨论，内容轻松有趣。虽偏向流量文学，但能快速掌握当下阅读热点。适合想了解当年最火书籍的观众。",
                link: "https://www.youtube.com/@haleyphamvlogs",
                rating: 4
            },
            {
                name: "Productivity Game",
                region: "",
                description: "用动画10分钟总结经典书籍，如《深度工作》《原子习惯》。节奏明快、信息密度高，是碎片时间学习的神器。适合希望高效吸收知识的读者。",
                link: "https://www.youtube.com/@ProductivityGame",
                rating: 5
            }
        ]
    },
    {
        category: "创意设计",
        starred: false,
        channels: [
            {
                name: "The Futur",
                region: "",
                description: "一个涵盖 设计思维、平面设计、品牌建设 等内容的学习平台。兼具创新与逻辑，被誉为设计师的宝藏频道。邀请世界顶级设计师分享创作心得与品牌经验。UI / UX 课程体系完整，从零到一极具实用性。",
                link: "https://www.youtube.com/@thefutur",
                rating: 4
            },
            {
                name: "Great Art Explained",
                region: "",
                description: "艺术史入门频道，每集仅 15 分钟，聚焦一件经典艺术作品。内容简洁精炼，适合初学者快速了解艺术史背景与作品内涵。",
                link: "https://www.youtube.com/@GreatArtExplained",
                rating: 5
            },
            {
                name: "Curious Muse",
                region: "",
                description: "专注于 艺术、设计与创意灵感 的频道。轻松分享艺术史故事、创意案例与设计灵感。看完总能激发新的想法与创作冲动。",
                link: "https://www.youtube.com/@CuriousMuse",
                rating: 5
            },
            {
                name: "Mackenzie Child",
                region: "",
                description: "一位真诚的产品设计师，分享实际项目的完整过程。从灵感 → 草图 → UI 实现，教学风格温暖细致。内容实用性强，适合想系统学习产品与网页设计的初学者。",
                link: "https://www.youtube.com/@mackenziechild",
                rating: 5
            },
            {
                name: "Gal Shir",
                region: "",
                description: "以充满生命力与想象力的插画风格闻名。教授使用 iPad 创作高质量插画的技巧。内容兼具 色彩美感与绘画技法，非常激发创造力。",
                link: "https://www.youtube.com/@galshir",
                rating: 4
            },
            {
                name: "Fernando Nunes",
                region: "",
                description: "实力派插画艺术家，教程循序渐进、实操性强。从草图构思到 AI 上色都有详尽讲解。特别适合学习动物插画与自然主题创作的设计新手。",
                link: "https://www.youtube.com/@FernandoNunesIllustrator",
                rating: 4
            },
            {
                name: "Adobe Photoshop（官方）",
                region: "",
                description: "Adobe 官方出品，内容专业且高效。分享 PS 的最新功能与创意技巧。包含大量 提升设计效率的快捷操作与隐藏功能。",
                link: "https://www.youtube.com/@photoshop",
                rating: 4
            }
        ]
    },
    {
        category: "美术手工",
        starred: false,
        channels: [
            {
                name: "Katie Moody",
                region: "",
                description: "画材分享达人，热衷测试彩铅、马克笔、水彩、速写本等。她的试色+开箱+速写本翻翻看系列是灵感与治愈的结合。非常适合刚入坑插画的艺术新手。",
                link: "https://www.youtube.com/@KatieMoody",
                rating: 5
            },
            {
                name: "Sandi Hester",
                region: "",
                description: "她的创作空间总是充满凌乱美——颜料四溅却灵感无限。Sandi在镜头前轻松地谈艺术理念，尝试各种实验性画法。她的速写本、色彩、与生活感都极具感染力。",
                link: "https://www.youtube.com/@sandihester",
                rating: 4
            },
            {
                name: "Kriksis",
                region: "",
                description: "森系插画师，视频充满自然灵气与童趣。她分享画材、艺术书籍、旅游写生与创作灵感。作品多以动植物为主，像一部森林绘本。",
                link: "https://www.youtube.com/@kriksis",
                rating: 4
            },
            {
                name: "Sophie McPike",
                region: "",
                description: "以每月绘画挑战闻名的艺术博主。主题常围绕女孩、花朵与自然，风格鲜艳温柔。她的挑战系列能极大激发创作欲望。",
                link: "https://www.youtube.com/@sophiemcpike",
                rating: 4
            },
            {
                name: "Flaming Garden（Olga Lychkova）",
                region: "",
                description: "以水彩、水粉、彩铅等混合媒介创作植物主题作品。她的视频仿佛与你并肩作画，温柔细语中满是灵感。画风童话感十足，治愈力极强。",
                link: "https://www.youtube.com/@FlamingGardenArt",
                rating: 4
            },
            {
                name: "Leigh Ellexson",
                region: "",
                description: "梦中工作室的拥有者——宽敞、明亮、充满艺术气息。她的视频融合商业设计、插画与生活方式分享。对想建立艺术事业线的观众特别有启发。",
                link: "https://www.youtube.com/@leighellexson",
                rating: 4
            },
            {
                name: "paloma the peach",
                region: "",
                description: "风格可爱梦幻，设计贴纸、地毯、明信片等艺术商品。视频详细展示从灵感、草图到产品成品的全过程。是一位真正把艺术变成生活的独立创作者。",
                link: "https://www.youtube.com/@palomathepeach",
                rating: 4
            },
            {
                name: "Uncomfy（Tammy）",
                region: "",
                description: "超干货艺术创业博主，分享个人品牌打造全过程。视频涵盖粘土艺术制作、产品开发与经营技巧。是创意与商业并重的灵感频道。",
                link: "https://www.youtube.com/@tammydinh",
                rating: 4
            }
        ]
    },
    {
        category: "音乐",
        starred: false,
        channels: [
            {
                name: "Its Amanda!",
                region: "",
                description: "外形气质兼具的钢琴 vlogger，琴技惊艳、vlog 氛围清新。常录制即兴演奏与练琴日常，穿插学习与生活片段。看她的视频总会重燃练琴欲望！",
                link: "https://www.youtube.com/@itsamandalo",
                rating: 4
            },
            {
                name: "我是江老师",
                region: "",
                description: "以高难度钢琴挑战闻名（如「10分钟练《钟》」系列）。幽默风格结合扎实功底，让古典练习不再枯燥。内容兼具娱乐性与音乐深度。",
                link: "https://www.youtube.com/@iamteacherchiang",
                rating: 4
            },
            {
                name: "NiceChord 好和弦",
                region: "",
                description: "虽然已停更，但他的乐理合集是华语区的经典教材。用简明语言讲解复杂乐理，让人真正听懂音乐。强烈推荐《钢琴的踏板》《调式听辨》等经典视频。",
                link: "https://www.youtube.com/@nicechordwiwi",
                rating: 4
            },
            {
                name: "Shijun Wang",
                region: "",
                description: "朱莉娅学院毕业、现任美国韦伯州立大学钢琴系副教授。讲解肖邦、李斯特等古典作品，堪比免费大师课。讲解清晰、示范细腻，是专业琴人必追频道。",
                link: "https://www.youtube.com/@ShijunWangPianoChannel",
                rating: 4
            },
            {
                name: "Tiffany Poon",
                region: "",
                description: "香港钢琴家，留学美国并取得硕士学位。她记录练琴过程、音乐会幕后与钢琴挑选等日常。视频极具职业音乐人视角，启发性强。",
                link: "https://www.youtube.com/@TiffanyPoonpianist",
                rating: 4
            }
        ]
    },
    {
        category: "科技数码",
        starred: false,
        channels: [
            {
                name: "Marques Brownlee (MKBHD)",
                region: "美国",
                description: "全球顶级科技博主之一，被誉为 美国版何同学，拥有 1810 万+ 订阅者。专业评测苹果、安卓、笔电、耳机、汽车等最新数码产品。内容涵盖产品测评、行业趋势与科技理念，深度与趣味兼具。曾采访包括巴拉克·奥巴马（Barack Obama）在内的多位世界知名人物。",
                link: "https://www.youtube.com/@MKBHD",
                rating: 4
            }
        ]
    },
    {
        category: "综合科普",
        starred: false,
        channels: [
            {
                name: "Skillshare（官方频道）",
                region: "",
                description: "一个致力于激发创造力与终身学习的在线学习社区。内容涵盖 设计、插画、摄影、视频剪辑、创意思维、效率提升、自由职业技能 等领域。频道展示平台精选课程的精华片段与讲师访谈，让观众提前感受课程氛围。主讲人包括行业专家、艺术家与创意工作者，内容实用且启发性强。视频风格轻快简洁，非常适合短时间学习与激发灵感。",
                link: "https://www.youtube.com/user/Skillshare?utm_source=chatgpt.com",
                rating: 5
            },
            {
                name: "CrashCourse",
                region: "",
                description: "提供多学科知识视频，涵盖 历史、文学、生物、经济、心理学、计算机 等主题。非常适合 自学 AP 课程 或希望拓展知识面的同学。许多高中生、大学生都用它来备考或补充课堂知识。",
                link: "https://www.youtube.com/user/crashcourse",
                rating: 5
            },
            {
                name: "TED-Ed",
                region: "",
                description: "TED 的教育延伸项目，拥有高质量动画与解说。主题广泛：从 茶的历史、猫的行为、经济衰退、睡眠不足 到哲学思考。可视化效果出色，同时是极好的 英语听力与口译练习素材。",
                link: "https://www.youtube.com/user/TEDEducation",
                rating: 4
            },
            {
                name: "The School of Life",
                region: "",
                description: "致力于帮助人们过上更平静、有韧性、有智慧的生活。内容涵盖心理学、哲学、情感、文学与人际关系，以简短动画形式呈现。讲述柏拉图、尼采、荣格等思想家的理念，是提升思维深度与表达力的绝佳资源。",
                link: "https://www.youtube.com/@theschooloflifetv",
                rating: 5
            },
            {
                name: "Overthink Podcast",
                region: "",
                description: "以哲学与心理为核心主题的播客，由两位哲学博士主持。探讨 思维、情感、社会议题与自我认知。适合希望深入理解哲学思考方式、同时提升英语表达的听众。",
                link: "https://www.youtube.com/@OverthinkPodcastPhilosophy",
                rating: 5
            },
            {
                name: "Kurzgesagt – In a Nutshell",
                region: "德国",
                description: "以精美动画讲解复杂的 科学、宇宙、生物与哲学 概念。每支视频都像一堂视觉盛宴式的知识课，让人上瘾式学习。粉丝：23.1M",
                link: "https://www.youtube.com/@kurzgesagt",
                rating: 5
            },
            {
                name: "Veritasium",
                region: "美国",
                description: "最知名的科普频道之一，以深入浅出的方式探讨科学原理与人类认知。主持人 Derek Muller 的讲解幽默而有逻辑，启发观众重新思考世界。粉丝：16.5M",
                link: "https://www.youtube.com/@veritasium",
                rating: 4
            },
            {
                name: "Numberphile",
                region: "",
                description: "数学爱好者的天堂！由多位知名数学家主持。深入浅出地讲解有趣的数学话题与公式背后的故事。内容原汁原味、逻辑清晰，适合中高级学习者。",
                link: "https://www.youtube.com/user/numberphile",
                rating: 4
            },
            {
                name: "3Blue1Brown",
                region: "",
                description: "将数学与艺术完美结合的频道，以极具美感的动画讲解复杂数学概念。用视觉化和创新方式让抽象问题变得直观易懂。非常适合视觉型学习者与数学爱好者。",
                link: "https://www.youtube.com/@3blue1brown",
                rating: 4
            },
            {
                name: "WIRED",
                region: "",
                description: "科技与未来趋势媒体，简介是 WIRED is where tomorrow is realized. 推荐系列：Five Levels —— 专业人士用五个难度层次解释硬核概念（如量子计算、AI、重力）。Autocomplete Interview —— 名人搜索问答系列，嘉宾包括 Andrew Garfield、Jennifer Aniston、Joe Biden 等。",
                link: "https://www.youtube.com/@WIRED",
                rating: 4
            },
            {
                name: "Tim Ferriss",
                region: "美国",
                description: "作家、投资人与播客主持人，被誉为自我优化教父。频道涵盖 科技投资、生活方式设计与高效思维。粉丝：1.5M",
                link: "https://www.youtube.com/@timferriss",
                rating: 4
            },
            {
                name: "Tiff In Tech",
                region: "加拿大",
                description: "前IBM工程师、AI科技内容创作者。频道聚焦 人工智能、编程与职业成长，是女性科技从业者的代表声音。粉丝：385K",
                link: "https://www.youtube.com/@tiffintech",
                rating: 5
            },
            {
                name: "Nobody & The Computer",
                region: "英国",
                description: "探索 人工智能与音乐创作 的边界。内容融合科技、艺术与实验精神，展示AI如何重新定义创造力。粉丝：51.2K",
                link: "https://www.youtube.com/@nobodyandthecomputer",
                rating: 5
            }
        ]
    },
    {
        category: "英文绘本",
        starred: false,
        channels: [
            {
                name: "Storyline Online",
                region: "美国",
                description: "由 SAG-AFTRA Foundation 打造、曾获艾美奖提名。邀请著名演员如 Melanie Lynskey、Kyra Sedgwick 等朗读绘本。画面精致、互动性强、题材多样，是孩子英语启蒙的绝佳选择。",
                link: "https://www.youtube.com/@StorylineOnline",
                rating: 5
            },
            {
                name: "KidTimeStoryTime",
                region: "美国",
                description: "原创儿童朗读频道，风格幽默生动、表演感十足。内容丰富、适合低龄儿童，也能帮助家长学习绘本讲读技巧。超过千部视频，深受全球家庭欢迎。",
                link: "https://www.youtube.com/@KidTimeStoryTime",
                rating: 4
            },
            {
                name: "HarperKids",
                region: "美国",
                description: "由 HarperCollins 出版社运营的官方绘本频道。包含多种系列作品，有原作者或插画师亲自朗读。适合各年龄层儿童，兼具文学性与趣味性。",
                link: "https://www.youtube.com/@HarperKids",
                rating: 4
            },
            {
                name: "Bri Reads",
                region: "美国",
                description: "由国际学前教师 Bri 创立，融合唱歌、表演与阅读教学。以生动的表情和语调吸引孩子注意力。适合希望提升孩子阅读兴趣与表达力的家庭。",
                link: "https://www.youtube.com/@BriReads",
                rating: 4
            },
            {
                name: "Vooks",
                region: "美国",
                description: "高质量动画绘本频道，集视觉与听觉学习于一体。故事节奏舒缓、色彩温柔，适合家庭共读或课堂使用。被誉为数字绘本图书馆的代表。",
                link: "https://www.youtube.com/@VooksStorybooks",
                rating: 4
            },
            {
                name: "Brightly Storytime",
                region: "美国",
                description: "由 Ms. Linda 主持，语音温柔、发音标准。故事题材多元、富含文化性，帮助孩子拓展视野。每个故事后常附提问，激发孩子思考。",
                link: "https://www.youtube.com/BrightlyStorytime",
                rating: 5
            },
            {
                name: "Storytime with Ryan     } Craig",
                region: "美国",
                description: "由两位主持人 Ryan 与 Craig 共同运营。风格活泼幽默，注重互动与即兴反应。适合喜欢表演式阅读的孩子。",
                link: "https://www.youtube.com/@StorytimewithRyanandCraig",
                rating: 4
            },
            {
                name: "StoryTime at Awnies House",
                region: "美国",
                description: "由 Awnie 主持的高人气绘本朗读频道。注重儿童文学传播与阅读兴趣培养。声音温暖自然，是亲子睡前阅读首选。",
                link: "https://www.youtube.com/@AwniesHouse",
                rating: 5
            },
            {
                name: "Cool School",
                region: "美国",
                description: "拥有超过 1600 个视频的大型儿童教育频道。结合动画与故事讲述，在娱乐中融入学习内容。适合 3–10 岁儿童的综合成长型频道。",
                link: "https://www.youtube.com/@CoolSchool",
                rating: 4
            },
            {
                name: "StoryTime PlayTime – Childrens Books Read Aloud",
                region: "美国",
                description: "精选优质儿童绘本，内容互动性强。鼓励孩子思考、提问与复述，提升语言表达能力。更新频率稳定，适合家庭共读。",
                link: "https://www.youtube.com/@StoryTimePlayTime",
                rating: 5
            },
            {
                name: "bookboxinc",
                region: "国际",
                description: "国际化儿童阅读频道，推出 AniBooks 动画故事书系列。提供多语言朗读（英语、西语、印地语等），适合语言启蒙。动画简洁、节奏舒适，适合幼儿观看。",
                link: "https://www.youtube.com/@bookboxinc",
                rating: 4
            },
            {
                name: "Reading is",
                region: "美国",
                description: "以快乐阅读为主题的绘本朗读频道。语速温和、内容轻松，适合幼儿睡前磨耳与语言启蒙。帮助孩子在放松的氛围中爱上英语。",
                link: "https://www.youtube.com/@Readingis",
                rating: 5
            }
        ]
    },
    {
        category: "理财",
        starred: false,
        channels: [
            {
                name: "The Financial Diet",
                region: "美国",
                description: "重新思考金钱与文化之间的关系，提供女性视角的理财思维。内容涵盖储蓄、消费观、工作生活平衡与财务安全感。语速清晰、逻辑性强，适合理财入门者。",
                link: "https://www.youtube.com/@TheFinancialDiet",
                rating: 4
            },
            {
                name: "Nischa",
                region: "英国",
                description: "专注个人理财、自我成长与商业策略。讲解简洁直接，注重思维转变与长期财富规划。风格冷静理性，适合想建立稳健财务体系的观众。",
                link: "https://www.youtube.com/@Nischa",
                rating: 4
            },
            {
                name: "Rose Han",
                region: "美国",
                description: "前华尔街交易员，以交易逻辑与风险管理著称。分享投资理财、期权交易与财富自由规划。讲解专业又通俗，是深入了解金融世界的好入口。",
                link: "https://www.youtube.com/@itsrosehan",
                rating: 4
            },
            {
                name: "Vanessa Lau",
                region: "美国",
                description: "前企业顾问转型为内容创业者。主张少做事、多赚钱的高效创业理念。分享自媒体运营与时间管理策略，适合想打造个人品牌的人群。",
                link: "https://www.youtube.com/@VanessaLau",
                rating: 4
            },
            {
                name: "Your Rich BFF（Vivian Tu）",
                region: "美国",
                description: "前华尔街分析师，以幽默实用的方式讲解理财与投资。内容涵盖房地产、谈薪技巧与个人财务管理。被称为理财届闺蜜，让理财学习轻松有趣。",
                link: "https://www.youtube.com/@YourRichBFF",
                rating: 4
            },
            {
                name: "I Will Teach You To Be Rich（Ramit Sethi）",
                region: "美国",
                description: "畅销书《我教你变有钱》的作者。专注心理理财与生活设计，帮助观众改善消费结构与财务决策。内容实用且极具执行性。",
                link: "https://www.youtube.com/@RamitSethi",
                rating: 4
            },
            {
                name: "Jensen Tung",
                region: "加拿大",
                description: "加拿大企业家与创意博主。分享创业经验、被动收入与品牌经营策略。风格真实、节奏明快，是年轻创业者的灵感来源。",
                link: "https://www.youtube.com/@JensenTung",
                rating: 4
            },
            {
                name: "Deya",
                region: "美国",
                description: "自由职业与数字创业领域的指导型博主。专注时间管理、客户沟通与数字业务系统化运营。适合希望远程工作或建立线上副业的人群。",
                link: "https://www.youtube.com/@MyNameIsDeya",
                rating: 4
            },
            {
                name: "jayhoovy",
                region: "美国",
                description: "前高盛投行分析师与斯坦福 MBA。结合金融教育与个人成长内容。从年轻视角讲述如何让专业变成财富。",
                link: "https://www.youtube.com/@jayhoovy",
                rating: 4
            }
        ]
    }
];

// 根据用户要求批量设置评分：名单中的频道设为 5 星，其他设为 4 星
(function applyUserRatings() {
    // 用户提供的需要设为 5 星的频道名单（尽量使用原始名字或关键子串）
    const fiveStarNames = [
        // 高效学习（星标）
        'Ali Abdaal', 'Elizabeth Filips', 'Sienna Santer', 'Holly Gabrielle', 'Ruby Granger',
        // 高效学习（其他推荐）
        'UnJaded Jade', 'Thomas Frank', 'Tiago Forte', 'Breanna Quan', 'Mmiakim', "Matt D'Avella", 'Kharma Medic',
        // 英语学习
        "Veronika's Language Diaries", 'English Fluency Journey', 'Speak English With Tiffany', 'Chen Lily',
        // 职场成长
        'Lillian Chiu', 'Matt Huang', 'Leila Hormozi',
    // 亚裔生活
        'Yoora Jung', 'Saranghoe', 'Tracy', 'Michelle Choi', 'Yoon Kai', 'Mikayla Mags', 'Jusuf',
        // 海外华人生活
        'Breanna Quan', 'itsyuyan', 'Oh Emma', 'ReginaKnowsss', 'Savislook', 'VickySoupsss', 'Hola! Fiona', 'Rainie Tian', 'Miwivon', 'Meng Mao', 'Krysti Naaa', 'Annbition', 'Renasteps', 'Hilary Chen', 'Della Qin', 'Anny Shi', '胖丁 Wenning', 'Phiphiwearswhat', 'Nuria Ma',
        // 英音学习
        'Dr Izzy Sealey', 'Zeliha Akpinar', 'Zoella', 'Ellen Miller', 'emmaxolouise',
        // 治愈系生活
        'ur mom ashley', 'Natalie Lynn', "Leah's Fieldnotes", 'craziejulia',
        // 情感与成长
        'Malama Life', 'Rowena Tsai', 'Alyssa Lenore', 'Jasmine Lipska', 'MuchelleB', 'Moya Mawhinney', 'Natalie Barbu', 'Lavendaire',
        // 娱乐
        'Hailey Rhode Bieber',
        // 生活方式
        'Kate Brock', 'Caitlin Lam',
        // 健身与自律
        'Pick Up Limes', 'Sanne Vloet', 'LenaLifts',
        // 时尚与美妆
        'Tam Kaur', 'Sincerely, Sarah',
        // 阅读与思考
        'Jack Edwards', 'Robin Waldun', 'e m m i e', 'JustAli', 'Productivity Game',
        // 创意设计
        'Great Art Explained', 'Curious Muse', 'Mackenzie Child',
        // 美术手工
        'Katie Moody',
        // 综合科普
        'Skillshare', 'CrashCourse', 'The School of Life', 'Overthink Podcast', 'Kurzgesagt', 'Tiff In Tech', 'Nobody & The Computer',
        // 英文绘本
        'Storyline Online', 'Brightly Storytime', 'StoryTime PlayTime', 'Reading is'
    ];

    // 规范化匹配（去除空白、标点并转小写），支持宽松包含匹配，兼容中英文名和符号差异
    const normalize = s => (s || '').toString().toLowerCase().replace(/[^\p{L}\p{N}\u4e00-\u9fff]+/gu, '');
    const normalizedFive = fiveStarNames.map(normalize).filter(Boolean);

    channelsData.forEach(category => {
        category.channels.forEach(channel => {
            const nameNorm = normalize(channel.name);
            const isFive = normalizedFive.some(fn => fn && (nameNorm.includes(fn) || fn.includes(nameNorm)));
            channel.rating = isFive ? 5 : 4;
        });
    });
})();

// 收藏夹功能
// 全局变量 - 不在这里从localStorage加载，统一在loadAllData()中加载
let favorites = [];
let currentView = 'all'; // 'all' 或 'favorites' 或 'watched'
let watchedVideos = {}; // 存储格式：{channelName: [{url, title, notes, date}]}
let currentEditingChannel = null;
// 当前正在通过模态编辑的上下文（用于观后感编辑）
let notesEditingContext = null;
// 视频编辑模态上下文
let videoEditContext = null;

// 页面切换功能
function switchPage(pageId) {
    // 隐藏所有页面
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // 移除所有导航按键的active状态
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // 显示目标页面
    document.getElementById(pageId).classList.add('active');
    
    // 激活对应的导航按键
    const activeBtnMap = {
        'allChannelsPage': 'allChannelsBtn',
        'favoritesPage': 'favoritesBtn',
        'watchedVideosPage': 'watchedVideosBtn',
        'learningReportPage': 'learningReportBtn'
    };
    
    if (activeBtnMap[pageId]) {
        document.getElementById(activeBtnMap[pageId]).classList.add('active');
    }
}

function showAllChannels() {
    currentView = 'all';
    switchPage('allChannelsPage');
    renderChannels(channelsData);
}

function showFavorites() {
    currentView = 'favorites';
    switchPage('favoritesPage');
    renderFavoritesPage();
}

function showWatchedVideos() {
    currentView = 'watched';
    switchPage('watchedVideosPage');
    renderWatchedVideosPage();
}

// 渲染频道卡片
function renderChannels(data, searchTerm = '') {
    const container = document.getElementById('channelsContainer');
    container.innerHTML = '';

    let hasResults = false;

    // 规范化搜索词，防止传入非字符串或含前后空白导致匹配失败
    searchTerm = (searchTerm || '').toString().trim();

    data.forEach(categoryData => {
        const filteredChannels = categoryData.channels.filter(channel => {
            if (!searchTerm) return true;
            const term = searchTerm.toLowerCase();
            return (channel.name || '').toLowerCase().includes(term) ||
                   ((channel.description || '').toLowerCase().includes(term)) ||
                   ((channel.region || '').toLowerCase().includes(term));
        });

        if (filteredChannels.length > 0) {
            hasResults = true;
            const section = document.createElement('div');
            section.className = 'category-section';
            section.dataset.category = categoryData.category;

            const title = document.createElement('h2');
            title.className = 'category-title';
            if (categoryData.starred) {
                title.innerHTML = `<span class="star-icon">⭐</span>${categoryData.category}`;
            } else {
                title.textContent = categoryData.category;
            }

            // 按评分降序排序（高分在前）
            filteredChannels.sort((a, b) => (b.rating || 0) - (a.rating || 0));

            const grid = document.createElement('div');
            grid.className = 'channels-grid';

            filteredChannels.forEach(channel => {
                const card = createChannelCard(channel);
                grid.appendChild(card);
            });

            section.appendChild(title);
            section.appendChild(grid);
            container.appendChild(section);
        }
    });

    if (!hasResults) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🔍</div>
                <div class="empty-state-text">没有找到匹配的频道</div>
            </div>
        `;
    }
}

// 创建频道卡片
function createChannelCard(channel) {
    const card = document.createElement('div');
    card.className = 'channel-card';
    card.style.position = 'relative';

    const ratingStars = generateRating(channel.rating);
    const isFavorited = favorites.includes(channel.name);
    const watchedCount = watchedVideos[channel.name] ? watchedVideos[channel.name].length : 0;

    card.innerHTML = `
        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-channel="${channel.name}">
            ${isFavorited ? '❤️' : '🤍'}
        </button>
        <div class="channel-header">
            <div>
                <h3 class="channel-name clickable" data-channel="${channel.name}">${channel.name}</h3>
                ${channel.region ? `<span class="channel-region">${channel.region}</span>` : ''}
                ${watchedCount > 0 ? `<span class="watched-badge">已看 ${watchedCount} 个视频</span>` : ''}
            </div>
        </div>
        <div class="channel-description">${channel.description}</div>
        <div class="channel-footer">
            <a href="${channel.link}" target="_blank" class="channel-link">
                访问频道 →
            </a>
            <div class="rating-section">
                <div class="rating">${ratingStars}</div>
                <div class="rating-edit">
                    <select class="rating-select" data-channel="${channel.name}">
                        <option value="0" ${channel.rating === 0 ? 'selected' : ''}>未评分</option>
                        <option value="1" ${channel.rating === 1 ? 'selected' : ''}>1星</option>
                        <option value="2" ${channel.rating === 2 ? 'selected' : ''}>2星</option>
                        <option value="3" ${channel.rating === 3 ? 'selected' : ''}>3星</option>
                        <option value="4" ${channel.rating === 4 ? 'selected' : ''}>4星</option>
                        <option value="5" ${channel.rating === 5 ? 'selected' : ''}>5星</option>
                    </select>
                    <button class="update-rating-btn" data-channel="${channel.name}">更新</button>
                </div>
            </div>
        </div>
    `;

    return card;
}

// 生成星级评分
function generateRating(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<span class="star filled">★</span>';
        } else {
            stars += '<span class="star empty">★</span>';
        }
    }
    return stars;
}

// 创建筛选按钮
function createFilterButtons() {
    const filterContainer = document.getElementById('filterButtons');
    const categories = [...new Set(channelsData.map(c => c.category))];

    categories.forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = category;
        btn.dataset.category = category;

        btn.addEventListener('click', () => {
            // 如果当前在已看视频页面，先切换到主内容
            if (currentView === 'watched') {
                document.querySelector('.main-content').style.display = 'block';
                document.getElementById('watchedVideosPage').style.display = 'none';
                currentView = 'all';
            }

            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const filtered = channelsData.filter(c => c.category === category);
            renderChannels(filtered);
        });

        filterContainer.appendChild(btn);
    });
}

// 收藏功能
function toggleFavorite(channelName) {
    const index = favorites.indexOf(channelName);
    if (index > -1) {
        favorites.splice(index, 1);
    } else {
        favorites.push(channelName);
    }
    localStorage.setItem('youtubeFavorites', JSON.stringify(favorites));
    updateFavoritesCount();
    
    // 更新所有相同频道的收藏按钮状态
    document.querySelectorAll(`[data-channel="${channelName}"]`).forEach(btn => {
        if (btn.classList.contains('favorite-btn')) {
            btn.classList.toggle('favorited');
            btn.textContent = btn.classList.contains('favorited') ? '❤️' : '🤍';
        }
    });
    
    // 如果当前在收藏夹页面，重新渲染
    if (currentView === 'favorites') {
        renderFavoritesPage();
    }
}

// 更新收藏夹计数
function updateFavoritesCount() {
    const countElement = document.getElementById('favoritesCount');
    if (countElement) {
        countElement.textContent = favorites.length;
    }
}

// 渲染收藏夹页面
function renderFavoritesPage() {
    const container = document.getElementById('favoritesContainer');
    const emptyState = document.getElementById('favoritesEmpty');
    
    if (favorites.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // 找到收藏的频道
    const favoriteChannels = [];
    channelsData.forEach(category => {
        category.channels.forEach(channel => {
            if (favorites.includes(channel.name)) {
                favoriteChannels.push({...channel, category: category.category});
            }
        });
    });
    
    // 按分类分组显示
    const categoriesMap = {};
    favoriteChannels.forEach(channel => {
        if (!categoriesMap[channel.category]) {
            categoriesMap[channel.category] = [];
        }
        categoriesMap[channel.category].push(channel);
    });
    
    container.innerHTML = '';
    
    Object.keys(categoriesMap).forEach(category => {
        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        
        const categoryTitle = document.createElement('h3');
        categoryTitle.className = 'category-title';
        categoryTitle.innerHTML = `${category} <span class="star-icon">⭐</span>`;
        categorySection.appendChild(categoryTitle);
        
        // 在显示前按 rating 降序排序
        categoriesMap[category].sort((a, b) => (b.rating || 0) - (a.rating || 0));

        const channelsGrid = document.createElement('div');
        channelsGrid.className = 'channels-grid';
        
        categoriesMap[category].forEach(channel => {
            const card = createChannelCard(channel);
            channelsGrid.appendChild(card);
        });
        
        categorySection.appendChild(channelsGrid);
        container.appendChild(categorySection);
    });
}

// 更新已看视频计数
function updateWatchedCount() {
    const countElement = document.getElementById('watchedCount');
    if (countElement) {
        const totalVideos = Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0);
        countElement.textContent = totalVideos;
    }
}

// 这些函数已经被上面的新函数替代，删除重复定义

// 渲染已看视频页面
function renderWatchedVideosPage() {
    const container = document.getElementById('watchedVideosContainer');
    const emptyState = document.getElementById('watchedVideosEmpty');
    
    let totalVideos = 0;
    let totalChannels = 0;
    
    // 计算总数
    Object.values(watchedVideos).forEach(videos => {
        if (videos.length > 0) {
            totalVideos += videos.length;
            totalChannels++;
        }
    });
    
    if (totalVideos === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    container.innerHTML = '';
    
    // 将有已看视频的频道构造成数组，包含 rating，用于按 rating 排序后渲染
    const watchedChannelList = Object.keys(watchedVideos).map(channelName => {
        return {
            name: channelName,
            videos: watchedVideos[channelName] || [],
            rating: (function() {
                // 尝试从 channelsData 中找到对应频道的 rating
                for (const category of channelsData) {
                    for (const ch of category.channels) {
                        if (ch.name === channelName) return ch.rating || 0;
                    }
                }
                return 0;
            })()
        };
    }).filter(c => c.videos.length > 0);

    // 按 rating 降序
    watchedChannelList.sort((a, b) => (b.rating || 0) - (a.rating || 0));

    watchedChannelList.forEach(({name: channelName, videos}) => {
        const channelGroup = document.createElement('div');
        channelGroup.className = 'channel-group';

        channelGroup.innerHTML = `
            <div class="channel-group-header">
                ${channelName} (${videos.length} 个视频)
            </div>
            <div class="channel-group-content">
                ${videos.map(video => `
                    <div class="watched-video-item" data-url="${video.url}">
                        <div class="watched-video-header">
                            <div class="watched-video-title">${video.title || '无标题'}</div>
                            <button class="collapse-toggle-btn" data-url="${video.url}" title="折叠/展开详细信息">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                        </div>
                        <div class="watched-video-content" data-url="${video.url}">
                            <a href="${video.url}" target="_blank" class="watched-video-url">${video.url}</a>
                            <div class="watched-video-notes">${video.notes || '暂无观后感'}</div>
                            ${video.aiNotes ? `<div class="ai-notes-display">${video.aiNotes}</div>` : ''}
                        </div>
                        <div class="watched-video-actions">
                            <button class="ai-assistant-btn" data-channel="${channelName}" data-url="${video.url}" data-title="${video.title || ''}" data-notes="${video.notes || ''}" title="AI 学习助手">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    <path d="M13 8H7"></path>
                                    <path d="M17 12H7"></path>
                                </svg>
                                AI 助手
                            </button>
                            ${!video.aiNotesGenerated ? `
                            <button class="generate-ai-notes-btn" data-channel="${channelName}" data-url="${video.url}" title="生成 AI 学习笔记">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14,2 14,8 20,8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10,9 9,9 8,9"></polyline>
                                </svg>
                                生成笔记
                            </button>
                            ` : ''}
                            <button class="edit-watched-notes-btn" data-channel="${channelName}" data-url="${video.url}" data-title="${video.title || ''}" data-notes="${video.notes || ''}" title="编辑视频信息">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                编辑
                            </button>
                            <button class="delete-watched-video-btn" data-channel="${channelName}" data-url="${video.url}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                </svg>
                                删除
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        container.appendChild(channelGroup);
    });
}


// 更新评分
function updateRating(channelName, newRating) {
    channelsData.forEach(category => {
        category.channels.forEach(channel => {
            if (channel.name === channelName) {
                channel.rating = parseInt(newRating);
            }
        });
    });
    
    // 重新渲染当前视图
    if (currentView === 'favorites') {
        showFavorites();
    } else if (currentView === 'watched') {
        renderWatchedVideosPage();
    } else {
        renderChannels(channelsData);
    }
}

// 打开频道编辑页面
function openChannelEdit(channelName) {
    const channel = findChannelByName(channelName);
    if (!channel) return;
    
    currentEditingChannel = channelName;
    
    document.getElementById('editChannelName').textContent = channelName;
    document.getElementById('editChannelNameDisplay').textContent = channelName;
    document.getElementById('editChannelRegion').textContent = channel.region || '未知';
    document.getElementById('editChannelLink').href = channel.link;
    document.getElementById('channelUrlDisplay').textContent = channel.link;
    
    renderWatchedVideosList();
    document.getElementById('channelEditModal').style.display = 'block';
}

// 关闭频道编辑页面
function closeChannelEdit() {
    // 检查是否有未保存的内容
    const urlInput = document.getElementById('videoUrlInput');
    const titleInput = document.getElementById('videoTitleInput');
    const notesInput = document.getElementById('videoNotesInput');
    
    if (urlInput.value.trim() || titleInput.value.trim() || notesInput.value.trim()) {
        if (confirm('您有未保存的视频内容，确定要关闭吗？')) {
            // 清空输入框
            urlInput.value = '';
            titleInput.value = '';
            notesInput.value = '';
            document.getElementById('channelEditModal').style.display = 'none';
            currentEditingChannel = null;
        }
    } else {
        document.getElementById('channelEditModal').style.display = 'none';
        currentEditingChannel = null;
    }
}

// 渲染已看视频列表
function renderWatchedVideosList() {
    const container = document.getElementById('watchedVideosList');
    const videos = watchedVideos[currentEditingChannel] || [];
    const videoCountDisplay = document.getElementById('videoCountDisplay');
    
    // 更新视频计数显示
    if (videoCountDisplay) {
        videoCountDisplay.textContent = `${videos.length} 个视频`;
    }
    
    if (videos.length === 0) {
        container.innerHTML = `
            <div class="empty-videos-state">
                <div class="empty-icon">📺</div>
                <div class="empty-text">还没有添加视频</div>
                <p>在下方输入视频链接开始记录</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = videos.map(video => `
        <div class="video-item" data-url="${video.url}">
            <div class="video-header">
                <div class="video-title-container">
                    <div class="video-title-display">${video.title || '无标题'}</div>
                    <input type="text" class="video-title-edit" data-channel="${currentEditingChannel}" data-url="${video.url}" placeholder="视频标题（可选）" style="display: none;" value="${video.title || ''}">
                </div>
                <button class="collapse-toggle-btn" data-url="${video.url}" title="折叠/展开详细信息">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                </button>
            </div>
            <div class="video-content" data-url="${video.url}">
                <div class="video-url-container">
                    <a href="${video.url}" target="_blank" class="video-url-display">${video.url}</a>
                    <input type="url" class="video-url-edit" data-channel="${currentEditingChannel}" data-url="${video.url}" placeholder="输入视频链接..." style="display: none;" value="${video.url}">
                </div>
                <div class="video-notes-container">
                    <label class="notes-label">观后感：</label>
                    <div class="video-notes-display">${video.notes || '暂无观后感'}</div>
                    <textarea class="video-notes-edit" data-channel="${currentEditingChannel}" data-url="${video.url}" placeholder="添加观后感（可选）..." style="display: none;">${video.notes || ''}</textarea>
                </div>
                ${video.aiNotes ? `
                <div class="ai-notes-container">
                    <label class="ai-notes-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            <path d="M13 8H7"></path>
                            <path d="M17 12H7"></path>
                        </svg>
                        AI 学习笔记：
                    </label>
                    <div class="ai-notes-display">${video.aiNotes}</div>
                </div>
                ` : ''}
            </div>
            <div class="video-actions">
                <button class="ai-assistant-btn" data-channel="${currentEditingChannel}" data-url="${video.url}" data-title="${video.title || ''}" data-notes="${video.notes || ''}" title="AI 学习助手">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        <path d="M13 8H7"></path>
                        <path d="M17 12H7"></path>
                    </svg>
                    AI 助手
                </button>
                ${!video.aiNotesGenerated ? `
                <button class="generate-ai-notes-btn" data-channel="${currentEditingChannel}" data-url="${video.url}" title="生成 AI 学习笔记">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                    生成笔记
                </button>
                ` : ''}
                <button class="edit-save-btn" data-channel="${currentEditingChannel}" data-url="${video.url}" data-editing="false">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    编辑
                </button>
                <button class="delete-video-btn" data-channel="${currentEditingChannel}" data-url="${video.url}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                    </svg>
                    删除
                </button>
            </div>
        </div>
    `).join('');
}

// 添加视频
async function addVideo() {
    console.log('🔵 开始添加视频...');
    const urlInput = document.getElementById('videoUrlInput');
    const titleInput = document.getElementById('videoTitleInput');
    const notesInput = document.getElementById('videoNotesInput');
    
    const url = urlInput.value.trim();
    const title = titleInput.value.trim();
    const notes = notesInput.value.trim();
    
    console.log('📝 输入的视频信息:', { url, title, notes, currentEditingChannel });
    
    if (!url) {
        alert('请输入视频链接');
        return;
    }
    
    if (!currentEditingChannel) {
        alert('请先选择频道');
        console.error('❌ currentEditingChannel 为空');
        return;
    }
    
    if (!watchedVideos[currentEditingChannel]) {
        watchedVideos[currentEditingChannel] = [];
        console.log(`📁 为频道 "${currentEditingChannel}" 创建新的视频数组`);
    }
    
    // 检查是否已存在
    const exists = watchedVideos[currentEditingChannel].some(video => video.url === url);
    if (exists) {
        alert('该视频已存在');
        return;
    }
    
    // 创建视频对象
    const videoData = {
        url: url,
        title: title,
        notes: notes,
        date: new Date().toISOString(),
        aiNotes: null, // 初始化为 null
        aiNotesGenerated: false // 标记是否已生成 AI 笔记
    };
    
    console.log('📦 创建的视频对象:', videoData);
    
    // 显示 AI 笔记生成状态
    showAINotesGenerationStatus();
    
    // 尝试自动生成 AI 笔记
    try {
        const aiNotes = await generateVideoAINotes(videoData);
        if (aiNotes) {
            videoData.aiNotes = aiNotes;
            videoData.aiNotesGenerated = true;
            showAINotesGeneratedNotification();
        }
    } catch (error) {
        console.error('AI 笔记生成失败:', error);
        // 即使 AI 笔记生成失败，仍然保存视频
    }
    
    watchedVideos[currentEditingChannel].push(videoData);
    console.log(`📂 视频已添加到数组，当前频道有 ${watchedVideos[currentEditingChannel].length} 个视频`);
    console.log('💾 当前 watchedVideos 对象:', JSON.stringify(watchedVideos, null, 2));
    
    // 立即保存所有数据到localStorage
    console.log('💾 调用 saveAllData()...');
    saveAllData();
    
    // 验证保存
    const savedData = localStorage.getItem('youtubeChannelsData');
    const savedWatchedVideos = localStorage.getItem('watchedVideos');
    console.log('✅ localStorage 中的数据:');
    console.log('  - youtubeChannelsData:', savedData ? '存在' : '不存在');
    console.log('  - watchedVideos:', savedWatchedVideos ? '存在' : '不存在');
    if (savedWatchedVideos) {
        const parsedWatchedVideos = JSON.parse(savedWatchedVideos);
        console.log('  - 解析后的 watchedVideos:', parsedWatchedVideos);
    }
    
    urlInput.value = '';
    titleInput.value = '';
    notesInput.value = '';
    renderWatchedVideosList();
    updateWatchedCount();
    
    // 更新频道卡片中的已看视频数量
    updateChannelCards();
    
    console.log(`✅ 视频 "${title || '无标题'}" 已添加到频道 "${currentEditingChannel}" 并保存到浏览器`);
    
    alert(`✅ 视频已成功添加！\n\n标题: ${title || '无标题'}\n链接: ${url}\n\n请刷新页面查看数据是否保存成功。`);
}

// 更新频道卡片
function updateChannelCards() {
    if (currentView === 'favorites') {
        showFavorites();
    } else if (currentView === 'watched') {
        renderWatchedVideosPage();
    } else {
        renderChannels(channelsData);
    }
}

// 删除视频
function deleteVideo(channelName, url) {
    if (confirm('确定要删除这个视频吗？')) {
        if (watchedVideos[channelName]) {
            watchedVideos[channelName] = watchedVideos[channelName].filter(video => video.url !== url);
            if (watchedVideos[channelName].length === 0) {
                delete watchedVideos[channelName];
            }
            
            // 立即保存所有数据到localStorage
            saveAllData();
            
            if (currentEditingChannel === channelName) {
                renderWatchedVideosList();
            }
            updateWatchedCount();
            updateChannelCards();
            
            console.log(`✅ 视频已从频道 "${channelName}" 删除并保存到浏览器`);
        }
    }
}

// 更新视频观后感
function updateVideoNotes(channelName, url, notes) {
    if (watchedVideos[channelName]) {
        const video = watchedVideos[channelName].find(v => v.url === url);
        if (video) {
            video.notes = notes;
            localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
            saveAllData();
            
            // 如果当前在已看视频页面，重新渲染
            if (currentView === 'watched') {
                renderWatchedVideosPage();
            }
        }
    }
}

// 更新视频数据（标题、URL、观后感）
function updateVideoData(channelName, oldUrl, newTitle, newUrl, newNotes) {
    if (watchedVideos[channelName]) {
        const videoIndex = watchedVideos[channelName].findIndex(v => v.url === oldUrl);
        if (videoIndex !== -1) {
            // 更新视频数据
            watchedVideos[channelName][videoIndex] = {
                url: newUrl,
                title: newTitle,
                notes: newNotes,
                date: watchedVideos[channelName][videoIndex].date || new Date().toISOString()
            };
            
            localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
            saveAllData();
            
            if (currentEditingChannel === channelName) {
                renderWatchedVideosList();
            }
            updateWatchedCount();
            updateChannelCards();
        }
    }
}

// 查找频道
function findChannelByName(name) {
    for (const category of channelsData) {
        for (const channel of category.channels) {
            if (channel.name === name) {
                return channel;
            }
        }
    }
    return null;
}

// 搜索功能
document.getElementById('searchInput').addEventListener('input', (e) => {
    const searchTerm = (e.target.value || '').toString().trim();
    const activeCategory = document.querySelector('.filter-btn.active')?.dataset.category;

    let dataToSearch = channelsData;
    if (activeCategory && activeCategory !== 'all') {
        dataToSearch = channelsData.filter(c => c.category === activeCategory);
    }

    renderChannels(dataToSearch, searchTerm);
});

// 事件监听器
document.addEventListener('click', (e) => {
    // 收藏按钮
    if (e.target.classList.contains('favorite-btn')) {
        const channelName = e.target.dataset.channel;
        toggleFavorite(channelName);
    }
    
    // 更新评分按钮
    if (e.target.classList.contains('update-rating-btn')) {
        const channelName = e.target.dataset.channel;
        const select = document.querySelector(`select[data-channel="${channelName}"]`);
        const newRating = select.value;
        updateRating(channelName, newRating);
    }
    
    // 点击频道名称编辑
    if (e.target.classList.contains('channel-name') && e.target.classList.contains('clickable')) {
        const channelName = e.target.dataset.channel;
        openChannelEdit(channelName);
    }
    
    // 关闭编辑页面
    if (e.target.id === 'closeEditModal' || e.target.classList.contains('close-icon')) {
        closeChannelEdit();
    }
    
    // 添加视频按钮
    if (e.target.id === 'addVideoBtn') {
        addVideo();
    }
    
    // 编辑/保存按钮（改为模态编辑视频信息）
    if (e.target.classList.contains('edit-save-btn')) {
        const channelName = e.target.dataset.channel;
        const url = e.target.dataset.url;
        const video = (watchedVideos[channelName] || []).find(v => v.url === url) || { title: '', notes: '' };

        // 设置上下文并填充模态
        videoEditContext = { channelName, oldUrl: url };
        document.getElementById('videoModalUrl').value = url;
        document.getElementById('videoModalTitle').value = video.title || '';
        document.getElementById('videoModalNotes').value = video.notes || '';
        document.getElementById('videoEditModal').style.display = 'block';
    }
    
    // 删除视频按钮
    if (e.target.classList.contains('delete-video-btn')) {
        const channelName = e.target.dataset.channel;
        const url = e.target.dataset.url;
        deleteVideo(channelName, url);
    }
    
    // 删除已看视频页面中的视频
    if (e.target.classList.contains('delete-watched-video-btn')) {
        const channelName = e.target.dataset.channel;
        const url = e.target.dataset.url;
        deleteVideo(channelName, url);
        renderWatchedVideosPage();
    }
});

// 收藏夹按钮事件

// 点击模态框外部关闭
document.getElementById('channelEditModal').addEventListener('click', (e) => {
    if (e.target.id === 'channelEditModal') {
        closeChannelEdit();
    }
});


// 视频编辑模态事件
document.getElementById('closeVideoModal').addEventListener('click', () => {
    document.getElementById('videoEditModal').style.display = 'none';
    videoEditContext = null;
    window.currentEditingVideo = null;
});
document.getElementById('cancelVideoBtn').addEventListener('click', () => {
    document.getElementById('videoEditModal').style.display = 'none';
    videoEditContext = null;
    window.currentEditingVideo = null;
});
document.getElementById('saveVideoBtn').addEventListener('click', () => {
    const btn = document.getElementById('saveVideoBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '保存中...';

    const newUrl = document.getElementById('videoModalUrl').value.trim();
    const newTitle = document.getElementById('videoModalTitle').value.trim();
    const newNotes = document.getElementById('videoModalNotes').value;

    if (!newUrl) {
        alert('视频链接不能为空');
        btn.disabled = false;
        btn.textContent = originalText;
        return;
    }

    setTimeout(() => {
        // 检查是从频道编辑页面还是已看视频页面来的编辑
        if (videoEditContext) {
            // 频道编辑页面的编辑
            updateVideoData(videoEditContext.channelName, videoEditContext.oldUrl, newTitle, newUrl, newNotes);
        } else if (window.currentEditingVideo) {
            // 已看视频页面的编辑
            const editingVideo = window.currentEditingVideo;
            updateVideoData(editingVideo.channelName, editingVideo.originalUrl, newTitle, newUrl, newNotes);
        }
        
        btn.textContent = '已保存 ✓';

        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = originalText;
            document.getElementById('videoEditModal').style.display = 'none';
            videoEditContext = null;
            window.currentEditingVideo = null;

            // 重新渲染当前视图
            if (currentView === 'watched') {
                renderWatchedVideosPage();
            } else if (currentView === 'favorites') {
                showFavorites();
            } else {
                renderChannels(channelsData);
            }
        }, 700);
    }, 300);
});

// 点击模态外部区域时关闭 videoEditModal
document.getElementById('videoEditModal').addEventListener('click', (e) => {
    if (e.target.id === 'videoEditModal') {
        document.getElementById('videoEditModal').style.display = 'none';
        videoEditContext = null;
        window.currentEditingVideo = null;
    }
});

// 主初始化 - 整合所有初始化逻辑
document.addEventListener('DOMContentLoaded', () => {
    // 第一步：加载所有保存的数据
    loadAllData();
    
    // 第二步：初始化UI
    createFilterButtons();
    updateFavoritesCount();
    updateWatchedCount();
    
    // 第三步：清理可能残留的 AI 笔记生成状态
    clearAINotesGenerationStatus();
    
    // 第四步：设置键盘快捷键
    setupKeyboardShortcuts();
    
    // 第五步：设置默认状态
    showAllChannels();
    
    // 第六步：添加导航按键事件监听器
    document.getElementById('favoritesBtn').addEventListener('click', showFavorites);
    document.getElementById('allChannelsBtn').addEventListener('click', showAllChannels);
    document.getElementById('watchedVideosBtn').addEventListener('click', showWatchedVideos);
    
    // 第七步：添加数据管理按键事件监听器
    document.getElementById('exportBtn').addEventListener('click', exportData);
    document.getElementById('importBtn').addEventListener('click', importData);
    document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
    
    // 第八步：添加学习报告按钮事件监听器
    const learningReportBtn = document.getElementById('learningReportBtn');
    if (learningReportBtn) {
        learningReportBtn.addEventListener('click', () => switchPage('learningReportPage'));
    }
    
    const generateReportBtn = document.getElementById('generateReportBtn');
    if (generateReportBtn) {
        generateReportBtn.addEventListener('click', generateLearningReport);
    }
    
    const exportReportBtn = document.getElementById('exportReportBtn');
    if (exportReportBtn) {
        exportReportBtn.addEventListener('click', exportLearningReport);
    }
    
    console.log('✅ 应用初始化完成');
});

// 数据管理功能
// 完善的数据保存函数 - 确保所有数据实时保存
function saveAllData() {
    try {
        const data = {
            favorites: favorites,
            watchedVideos: watchedVideos,
            ratings: getRatings(),
            aiConfig: getAIConfig(), // 新增：AI配置数据
            timestamp: new Date().toISOString(),
            version: '1.1' // 更新版本号
        };
        
        // 保存到localStorage
        localStorage.setItem('youtubeChannelsData', JSON.stringify(data));
        
        // 同时保存各个独立的数据项，确保兼容性
        localStorage.setItem('youtubeFavorites', JSON.stringify(favorites));
        localStorage.setItem('watchedVideos', JSON.stringify(watchedVideos));
        localStorage.setItem('youtubeRatings', JSON.stringify(data.ratings));
        localStorage.setItem('aiConfig', JSON.stringify(data.aiConfig));
        
        console.log('✅ 所有数据已保存到浏览器');
    } catch (error) {
        console.error('❌ 数据保存失败:', error);
    }
}

// 获取AI配置数据
function getAIConfig() {
    return {
        provider: aiConfig.provider || 'gemini',
        openai: {
            apiKey: aiConfig.openai.apiKey || '',
            model: aiConfig.openai.model || 'gpt-4o'
        },
        gemini: {
            apiKey: aiConfig.gemini.apiKey || '',
            model: aiConfig.gemini.model || 'gemini-1.5-flash'
        },
        groq: {
            apiKey: aiConfig.groq.apiKey || '',
            model: aiConfig.groq.model || 'llama-3.1-70b-versatile'
        }
    };
}

// 加载AI配置数据
function loadAIConfig() {
    try {
        const savedConfig = localStorage.getItem('aiConfig');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            if (config.provider) aiConfig.provider = config.provider;
            if (config.openai) {
                aiConfig.openai.apiKey = config.openai.apiKey || '';
                aiConfig.openai.model = config.openai.model || 'gpt-4o';
            }
            if (config.gemini) {
                aiConfig.gemini.apiKey = config.gemini.apiKey || '';
                aiConfig.gemini.model = config.gemini.model || 'gemini-1.5-flash';
            }
            if (config.groq) {
                aiConfig.groq.apiKey = config.groq.apiKey || '';
                aiConfig.groq.model = config.groq.model || 'llama-3.1-70b-versatile';
            }
        }
    } catch (error) {
        console.error('AI配置加载失败:', error);
    }
}

function loadAllData() {
    try {
        console.log('🔄 开始加载数据...');
        
        // 加载主要数据
        const savedData = localStorage.getItem('youtubeChannelsData');
        if (savedData) {
            const data = JSON.parse(savedData);
            console.log('📦 从统一数据中加载:', {
                hasRatings: !!data.ratings,
                hasFavorites: !!data.favorites,
                hasWatchedVideos: !!data.watchedVideos,
                hasAIConfig: !!data.aiConfig
            });
            
            // 恢复评分数据
            if (data.ratings) {
                data.ratings.forEach(rating => {
                    channelsData.forEach(category => {
                        category.channels.forEach(channel => {
                            if (channel.name === rating.name) {
                                channel.rating = rating.rating;
                            }
                        });
                    });
                });
                console.log(`✅ 已恢复 ${data.ratings.length} 个频道评分`);
            }
            
            // 恢复收藏夹数据
            if (data.favorites) {
                favorites = data.favorites;
                console.log(`✅ 已恢复 ${favorites.length} 个收藏频道`);
            }
            
            // 恢复已看视频数据
            if (data.watchedVideos) {
                watchedVideos = data.watchedVideos;
                const totalVideos = Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0);
                console.log(`✅ 已恢复 ${Object.keys(watchedVideos).length} 个频道的 ${totalVideos} 个已看视频`);
            }
            
            // 恢复AI配置数据
            if (data.aiConfig) {
                if (data.aiConfig.provider) aiConfig.provider = data.aiConfig.provider;
                if (data.aiConfig.openai) {
                    aiConfig.openai.apiKey = data.aiConfig.openai.apiKey || '';
                    aiConfig.openai.model = data.aiConfig.openai.model || 'gpt-4o';
                }
                if (data.aiConfig.gemini) {
                    aiConfig.gemini.apiKey = data.aiConfig.gemini.apiKey || '';
                    aiConfig.gemini.model = data.aiConfig.gemini.model || 'gemini-1.5-flash';
                }
                if (data.aiConfig.groq) {
                    aiConfig.groq.apiKey = data.aiConfig.groq.apiKey || '';
                    aiConfig.groq.model = data.aiConfig.groq.model || 'llama-3.1-70b-versatile';
                }
                console.log(`✅ 已恢复AI配置 (提供商: ${aiConfig.provider})`);
            }
        } else {
            console.log('📦 未找到统一数据，尝试从独立存储加载...');
            
            // 兼容性：从独立存储中加载数据（如果主数据不存在）
            // 加载收藏夹
            const savedFavorites = localStorage.getItem('youtubeFavorites');
            if (savedFavorites) {
                favorites = JSON.parse(savedFavorites);
                console.log(`✅ 从独立存储恢复 ${favorites.length} 个收藏频道`);
            }
            
            // 加载已看视频
            const savedWatchedVideos = localStorage.getItem('watchedVideos');
            if (savedWatchedVideos) {
                watchedVideos = JSON.parse(savedWatchedVideos);
                const totalVideos = Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0);
                console.log(`✅ 从独立存储恢复 ${Object.keys(watchedVideos).length} 个频道的 ${totalVideos} 个已看视频`);
            }
            
            // 加载评分
            const savedRatings = localStorage.getItem('youtubeRatings');
            if (savedRatings) {
                const ratings = JSON.parse(savedRatings);
                ratings.forEach(rating => {
                    channelsData.forEach(category => {
                        category.channels.forEach(channel => {
                            if (channel.name === rating.name) {
                                channel.rating = rating.rating;
                            }
                        });
                    });
                });
                console.log(`✅ 从独立存储恢复 ${ratings.length} 个频道评分`);
            }
            
            // 加载AI配置
            loadAIConfig();
        }
        
        console.log('✅ 所有数据已从浏览器恢复完成');
        console.log('📊 当前数据状态:', {
            favorites: favorites.length,
            watchedChannels: Object.keys(watchedVideos).length,
            totalWatchedVideos: Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0)
        });
    } catch (error) {
        console.error('❌ 数据恢复失败:', error);
    }
}

function getFavorites() {
    const favorites = localStorage.getItem('youtubeFavorites');
    return favorites ? JSON.parse(favorites) : [];
}

function getWatchedVideos() {
    const watchedVideos = localStorage.getItem('watchedVideos');
    return watchedVideos ? JSON.parse(watchedVideos) : {};
}

function getRatings() {
    const ratings = [];
    channelsData.forEach(category => {
        category.channels.forEach(channel => {
            ratings.push({
                name: channel.name,
                rating: channel.rating
            });
        });
    });
    return ratings;
}

function exportData() {
    try {
        const data = {
            favorites: favorites,
            watchedVideos: watchedVideos,
            ratings: getRatings(),
            aiConfig: getAIConfig(), // 新增：AI配置数据
            timestamp: new Date().toISOString(),
            version: '1.1', // 更新版本号
            channelsDataVersion: 'v1' // 可用于未来兼容性检查
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `youtube-channels-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('✅ 数据导出成功！包含所有频道评分、收藏夹、已看视频和AI配置数据。');
    } catch (error) {
        console.error('导出失败:', error);
        alert('❌ 数据导出失败！');
    }
}

// 将导入的数据迁移/规范化为当前版本所需的结构
function migrateImportedData(data) {
    if (!data || typeof data !== 'object') return data;

    const migrated = Object.assign({}, data);

    // favorites: 允许多种格式 -> 规范为数组
    if (!Array.isArray(migrated.favorites)) {
        if (migrated.favorites && typeof migrated.favorites === 'object') {
            // 可能是 {name: true} 的形式
            migrated.favorites = Object.keys(migrated.favorites).filter(k => migrated.favorites[k]);
        } else {
            migrated.favorites = [];
        }
    }

    // watchedVideos: 期望为 {channelName: [{...}, ...]}，兼容旧版数组或其他格式
    if (!migrated.watchedVideos || typeof migrated.watchedVideos !== 'object' || Array.isArray(migrated.watchedVideos)) {
        // 如果是数组，尝试按照可能的旧结构转换
        if (Array.isArray(migrated.watchedVideos)) {
            const map = {};
            migrated.watchedVideos.forEach(item => {
                // 旧格式可能包含 channel 字段
                const channel = item.channel || item.channelName || 'unknown';
                if (!map[channel]) map[channel] = [];
                map[channel].push({ url: item.url || item.link || '', title: item.title || '', notes: item.notes || '', date: item.date || new Date().toISOString() });
            });
            migrated.watchedVideos = map;
        } else {
            migrated.watchedVideos = {};
        }
    }

    // ratings: 期望为 [{name, rating}]，兼容 {name:rating} 的 map
    if (migrated.ratings && !Array.isArray(migrated.ratings) && typeof migrated.ratings === 'object') {
        const arr = [];
        Object.keys(migrated.ratings).forEach(name => {
            arr.push({ name, rating: migrated.ratings[name] });
        });
        migrated.ratings = arr;
    }

    // 确保存在 ratings 字段
    if (!Array.isArray(migrated.ratings)) migrated.ratings = [];

    // 如果没有 version，可以设置为旧版本标记
    if (!migrated.version) migrated.version = 'legacy';

    return migrated;
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let data = JSON.parse(e.target.result);
                // 先迁移/规范化数据以提高兼容性
                data = migrateImportedData(data);

                // 基本格式校验
                if (!data || typeof data !== 'object') throw new Error('导入数据不是对象');
                if (!Array.isArray(data.ratings)) throw new Error('ratings 应为数组');
                if (typeof data.watchedVideos !== 'object' || data.watchedVideos === null) throw new Error('watchedVideos 格式不正确');
                if (!Array.isArray(data.favorites)) data.favorites = Array.isArray(data.favorites) ? data.favorites : [];

                if (confirm('确定要导入数据吗？这将覆盖当前所有本地数据（收藏/已看/评分）！')) {
                    // 导入 ratings 并记录未匹配的项
                    const unmatchedRatings = [];
                    data.ratings.forEach(rating => {
                        let matched = false;
                        channelsData.forEach(category => {
                            category.channels.forEach(channel => {
                                if (channel.name === rating.name) {
                                    channel.rating = rating.rating;
                                    matched = true;
                                }
                            });
                        });
                        if (!matched) unmatchedRatings.push(rating.name);
                    });

                    // 写入 localStorage
                    try {
                        localStorage.setItem('youtubeFavorites', JSON.stringify(data.favorites));
                        localStorage.setItem('watchedVideos', JSON.stringify(data.watchedVideos));
                    } catch (err) {
                        console.warn('写入 localStorage 失败：', err);
                        alert('导入失败：无法写入本地存储');
                        return;
                    }

                    // 更新全局变量
                    favorites = data.favorites;
                    watchedVideos = data.watchedVideos;

                    // 重新渲染当前页面
                    if (currentView === 'favorites') {
                        renderFavoritesPage();
                    } else if (currentView === 'watched') {
                        renderWatchedVideosPage();
                    } else {
                        renderChannels(channelsData);
                    }

                    updateFavoritesCount();
                    updateWatchedCount();

                    // 提示导入结果
                    if (unmatchedRatings.length > 0) {
                        alert('导入完成，但以下评分项未能匹配到任何频道：\n' + unmatchedRatings.join(', '));
                    } else {
                        alert('数据导入成功！');
                    }
                }
            } catch (error) {
                alert('数据导入失败：' + error.message);
            }
        };
        reader.readAsText(file);
    };

    input.click();
}

function clearAllData() {
    if (confirm('确定要清除所有本地数据吗？此操作不可撤销！')) {
        localStorage.removeItem('youtubeFavorites');
        localStorage.removeItem('watchedVideos');
        localStorage.removeItem('youtubeChannelsData');
        
        // 重置全局变量
        favorites = [];
        watchedVideos = {};
        // 恢复 channelsData 到初始快照（如果可用），否则保守地将评分设为 4
        if (window.initialChannelsSnapshot) {
            // 深拷贝以避免引用同一对象
            const snapshot = JSON.parse(JSON.stringify(window.initialChannelsSnapshot));
            // 用 snapshot 替换 channelsData 的内容
            channelsData.length = 0;
            snapshot.forEach(cat => channelsData.push(cat));
        } else {
            channelsData.forEach(category => {
                category.channels.forEach(channel => {
                    channel.rating = 4;
                });
            });
        }
        
        // 重新渲染当前页面
        if (currentView === 'favorites') {
            renderFavoritesPage();
        } else if (currentView === 'watched') {
            renderWatchedVideosPage();
        } else {
            renderChannels(channelsData);
        }
        
        updateFavoritesCount();
        updateWatchedCount();
        alert('所有本地数据已清除，页面已恢复到当前项目设置所显示的默认状态。');
    }
}

// AI 学习助手相关功能
let currentAIVideo = null;
let aiChatHistory = [];
let extractedVideoContent = null;

// AI API 配置
let aiConfig = {
    provider: localStorage.getItem('aiProvider') || 'gemini', // 默认使用免费的 Gemini
    openai: {
        apiKey: localStorage.getItem('openaiApiKey') || '',
        model: localStorage.getItem('openaiModel') || 'gpt-4o'
    },
    gemini: {
        apiKey: localStorage.getItem('geminiApiKey') || '',
        model: localStorage.getItem('geminiModel') || 'gemini-1.5-flash'
    },
    groq: {
        apiKey: localStorage.getItem('groqApiKey') || '',
        model: localStorage.getItem('groqModel') || 'llama-3.1-70b-versatile'
    }
};

// 为了向后兼容，保留 openaiConfig
let openaiConfig = aiConfig.openai;

// 保存 AI API 配置
function saveOpenAIConfig() {
    const provider = document.getElementById('aiProvider').value;
    
    // 根据选择的提供商获取配置
    let apiKey, model;
    
    if (provider === 'gemini') {
        apiKey = document.getElementById('geminiApiKey').value.trim();
        model = document.getElementById('geminiModel').value;
        
        if (!apiKey) {
            alert('请输入 Google Gemini API Key');
            return;
        }
        
        aiConfig.gemini.apiKey = apiKey;
        aiConfig.gemini.model = model;
        localStorage.setItem('geminiApiKey', apiKey);
        localStorage.setItem('geminiModel', model);
        
    } else if (provider === 'groq') {
        apiKey = document.getElementById('groqApiKey').value.trim();
        model = document.getElementById('groqModel').value;
        
        if (!apiKey) {
            alert('请输入 Groq API Key');
            return;
        }
        
        aiConfig.groq.apiKey = apiKey;
        aiConfig.groq.model = model;
        localStorage.setItem('groqApiKey', apiKey);
        localStorage.setItem('groqModel', model);
        
    } else if (provider === 'openai') {
        apiKey = document.getElementById('openaiApiKey').value.trim();
        model = document.getElementById('openaiModel').value;
        
        if (!apiKey) {
            alert('请输入 OpenAI API Key');
            return;
        }
        
        if (!apiKey.startsWith('sk-')) {
            alert('OpenAI API Key 格式不正确，应该以 "sk-" 开头');
            return;
        }
        
        aiConfig.openai.apiKey = apiKey;
        aiConfig.openai.model = model;
        openaiConfig.apiKey = apiKey; // 向后兼容
        openaiConfig.model = model;
        localStorage.setItem('openaiApiKey', apiKey);
        localStorage.setItem('openaiModel', model);
    }
    
    // 保存提供商选择
    aiConfig.provider = provider;
    localStorage.setItem('aiProvider', provider);
    
    // 立即保存所有数据
    saveAllData();
    
    alert(`✅ ${provider === 'gemini' ? 'Google Gemini' : provider === 'groq' ? 'Groq' : 'OpenAI'} API 配置已保存！`);
    document.getElementById('apiConfigModal').style.display = 'none';
    
    const providerNames = {
        'gemini': 'Google Gemini',
        'groq': 'Groq',
        'openai': 'OpenAI'
    };
    
    alert(`✅ ${providerNames[provider]} API 配置已保存！现在可以使用免费的 AI 功能了。`);
}

// 清除 AI API 配置
function clearOpenAIConfig() {
    if (confirm('确定要清除所有 AI API 配置吗？')) {
        // 清除所有提供商的配置
        aiConfig.openai.apiKey = '';
        aiConfig.openai.model = 'gpt-4o';
        aiConfig.gemini.apiKey = '';
        aiConfig.gemini.model = 'gemini-1.5-flash';
        aiConfig.groq.apiKey = '';
        aiConfig.groq.model = 'llama-3.1-70b-versatile';
        aiConfig.provider = 'gemini';
        
        openaiConfig.apiKey = '';
        openaiConfig.model = 'gpt-4o';
        
        localStorage.removeItem('openaiApiKey');
        localStorage.removeItem('openaiModel');
        localStorage.removeItem('geminiApiKey');
        localStorage.removeItem('geminiModel');
        localStorage.removeItem('groqApiKey');
        localStorage.removeItem('groqModel');
        localStorage.removeItem('aiProvider');
        
        document.getElementById('openaiApiKey').value = '';
        document.getElementById('openaiModel').value = 'gpt-4o';
        document.getElementById('geminiApiKey').value = '';
        document.getElementById('geminiModel').value = 'gemini-1.5-flash';
        document.getElementById('groqApiKey').value = '';
        document.getElementById('groqModel').value = 'llama-3.1-70b-versatile';
        document.getElementById('aiProvider').value = 'gemini';
        
        alert('✅ 所有 API 配置已清除');
    }
}

// 打开 API 配置面板
function openAPISettings() {
    // 先隐藏AI助手模态框（如果正在显示）
    const aiAssistantModal = document.getElementById('aiAssistantModal');
    if (aiAssistantModal && aiAssistantModal.style.display === 'flex') {
        window.aiAssistantWasOpen = true; // 记录AI助手之前是打开的
        aiAssistantModal.style.display = 'none';
    } else {
        window.aiAssistantWasOpen = false;
    }
    
    // 加载所有配置
    document.getElementById('aiProvider').value = aiConfig.provider;
    document.getElementById('openaiApiKey').value = aiConfig.openai.apiKey;
    document.getElementById('openaiModel').value = aiConfig.openai.model;
    document.getElementById('geminiApiKey').value = aiConfig.gemini.apiKey;
    document.getElementById('geminiModel').value = aiConfig.gemini.model;
    document.getElementById('groqApiKey').value = aiConfig.groq.apiKey;
    document.getElementById('groqModel').value = aiConfig.groq.model;
    
    // 显示对应的配置面板
    switchProviderConfig(aiConfig.provider);
    
    document.getElementById('apiConfigModal').style.display = 'flex';
}

// 切换提供商配置显示
function switchProviderConfig(provider) {
    // 隐藏所有配置
    document.querySelectorAll('.provider-config').forEach(el => {
        el.style.display = 'none';
    });
    
    // 显示选中的配置
    if (provider === 'gemini') {
        document.getElementById('geminiConfig').style.display = 'block';
    } else if (provider === 'groq') {
        document.getElementById('groqConfig').style.display = 'block';
    } else if (provider === 'openai') {
        document.getElementById('openaiConfig').style.display = 'block';
    }
}

// 关闭 API 配置面板
function closeAPISettings() {
    document.getElementById('apiConfigModal').style.display = 'none';
    // 如果是从AI助手打开的配置窗口，关闭后恢复AI助手显示
    const aiAssistantModal = document.getElementById('aiAssistantModal');
    if (aiAssistantModal && window.aiAssistantWasOpen) {
        aiAssistantModal.style.display = 'flex';
        window.aiAssistantWasOpen = false;
    }
}

// 调用 Google Gemini API
async function callGemini(messages, temperature = 0.7) {
    if (!aiConfig.gemini.apiKey) {
        throw new Error('请先配置 Google Gemini API Key（点击右上角设置按钮）');
    }
    
    try {
        // 转换消息格式为 Gemini 格式
        const geminiMessages = messages
            .filter(msg => msg.role !== 'system')
            .map(msg => ({
                role: msg.role === 'assistant' ? 'model' : 'user',
                parts: [{ text: msg.content }]
            }));
        
        // 系统提示添加到第一条用户消息前
        const systemMessage = messages.find(msg => msg.role === 'system');
        if (systemMessage && geminiMessages.length > 0) {
            geminiMessages[0].parts[0].text = systemMessage.content + '\n\n' + geminiMessages[0].parts[0].text;
        }
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${aiConfig.gemini.model}:generateContent?key=${aiConfig.gemini.apiKey}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: geminiMessages,
                generationConfig: {
                    temperature: temperature,
                    maxOutputTokens: 2000
                }
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || '调用 Gemini API 失败');
        }
        
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
        
    } catch (error) {
        console.error('Gemini API 错误:', error);
        throw error;
    }
}

// 调用 Groq API
async function callGroq(messages, temperature = 0.7) {
    if (!aiConfig.groq.apiKey) {
        throw new Error('请先配置 Groq API Key（点击右上角设置按钮）');
    }
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.groq.apiKey}`
            },
            body: JSON.stringify({
                model: aiConfig.groq.model,
                messages: messages,
                temperature: temperature,
                max_tokens: 2000
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || '调用 Groq API 失败');
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
        
    } catch (error) {
        console.error('Groq API 错误:', error);
        throw error;
    }
}

// 调用 OpenAI API
async function callOpenAI(messages, temperature = 0.7) {
    if (!aiConfig.openai.apiKey) {
        throw new Error('请先配置 OpenAI API Key（点击右上角设置按钮）');
    }
    
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.openai.apiKey}`
            },
            body: JSON.stringify({
                model: aiConfig.openai.model,
                messages: messages,
                temperature: temperature,
                max_tokens: 2000
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || '调用 OpenAI API 失败');
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
        
    } catch (error) {
        console.error('OpenAI API 错误:', error);
        throw error;
    }
}

// 统一的 AI 调用函数 - 根据配置自动选择提供商
async function callAI(messages, temperature = 0.7) {
    const provider = aiConfig.provider;
    
    try {
        if (provider === 'gemini') {
            return await callGemini(messages, temperature);
        } else if (provider === 'groq') {
            return await callGroq(messages, temperature);
        } else if (provider === 'openai') {
            return await callOpenAI(messages, temperature);
        } else {
            throw new Error('未知的 AI 提供商');
        }
    } catch (error) {
        console.error(`${provider} API 调用失败:`, error);
        throw error;
    }
}

// 为视频自动生成 AI 笔记
async function generateVideoAINotes(videoData) {
    // 检查是否配置了任何 AI API
    const hasApiKey = aiConfig.gemini.apiKey || aiConfig.groq.apiKey || aiConfig.openai.apiKey;
    if (!hasApiKey) {
        return null;
    }
    
    try {
        // 获取视频信息
        const videoId = extractYouTubeVideoId(videoData.url);
        let videoInfo = { title: videoData.title || '未知标题', author: '未知创作者' };
        
        if (videoId) {
            try {
                videoInfo = await fetchYouTubeVideoInfo(videoId);
            } catch (error) {
                console.log('获取视频信息失败，使用默认信息');
            }
        }
        
        // 构建 AI 笔记生成提示
        const prompt = `请为以下 YouTube 视频生成一份结构化的学习笔记：

**视频信息：**
- 标题：${videoInfo.title}
- 创作者：${videoInfo.author}
- 频道：${videoData.channelName || '未知'}
${videoData.notes ? `- 用户观后感：${videoData.notes}` : ''}

**要求：**
1. 生成一份完整的学习笔记，包含以下结构：
   - 📝 视频摘要（100-200字）
   - 🎯 核心要点（3-5个关键概念）
   - 💡 实践应用（具体可操作的建议）
   - 🔗 知识拓展（相关主题推荐）
   - 📚 学习建议（如何深化理解）

2. 使用 HTML 格式，包含适当的标签（h3, ul, li, p, strong 等）
3. 语言简洁明了，便于复习和回顾
4. 结合用户观后感，提供个性化建议

请生成专业、实用的学习笔记。`;

        const messages = [
            {
                role: 'system',
                content: '你是一个专业的学习笔记生成专家，擅长分析教育视频并生成高质量的结构化学习笔记。你的笔记应该专业、实用、易于理解和复习。'
            },
            {
                role: 'user',
                content: prompt
            }
        ];
        
        const aiNotes = await callAI(messages, 0.6); // 使用较低的温度值确保一致性
        return aiNotes;
        
    } catch (error) {
        console.error('生成视频 AI 笔记失败:', error);
        throw error;
    }
}

// 显示 AI 笔记生成状态
function showAINotesGenerationStatus() {
    // 创建状态提示
    const statusDiv = document.createElement('div');
    statusDiv.id = 'aiNotesGenerationStatus';
    statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        animation: slideInRight 0.3s ease-out;
    `;
    
    statusDiv.innerHTML = `
        <div style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span>AI 正在生成学习笔记...</span>
    `;
    
    document.body.appendChild(statusDiv);
    
    // 添加动画样式
    if (!document.getElementById('aiNotesAnimationStyles')) {
        const style = document.createElement('style');
        style.id = 'aiNotesAnimationStyles';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
}

// 清理 AI 笔记生成状态
function clearAINotesGenerationStatus() {
    const statusDiv = document.getElementById('aiNotesGenerationStatus');
    if (statusDiv) {
        statusDiv.remove();
    }
}


// 快速建议功能
function toggleQuickSuggestions() {
    const quickSuggestions = document.getElementById('quickSuggestions');
    const isVisible = quickSuggestions.style.display !== 'none';
    
    if (isVisible) {
        quickSuggestions.style.display = 'none';
    } else {
        quickSuggestions.style.display = 'block';
    }
}

// 插入建议到输入框
function insertSuggestion(suggestion) {
    const input = document.getElementById('aiChatInput');
    input.value = suggestion;
    input.focus();
    
    // 自动发送（可选）
    // sendAIMessage(suggestion);
}

// 滚动到建议区域
function scrollToSuggestions() {
    const suggestionsPanel = document.querySelector('.ai-suggestions-panel');
    if (suggestionsPanel) {
        suggestionsPanel.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
        
        // 添加高亮效果
        suggestionsPanel.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.3)';
        setTimeout(() => {
            suggestionsPanel.style.boxShadow = '';
        }, 2000);
    }
}

// 键盘快捷键支持
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + ? 打开建议
        if ((e.ctrlKey || e.metaKey) && e.key === '?') {
            e.preventDefault();
            toggleQuickSuggestions();
        }
        
        // Ctrl/Cmd + Shift + ? 滚动到建议区域
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === '?') {
            e.preventDefault();
            scrollToSuggestions();
        }
    });
}

// 折叠/展开视频详细信息（支持频道编辑页面和已看视频页面）
function toggleVideoCollapse(button) {
    const url = button.dataset.url;
    
    // 查找对应的内容区域（频道编辑页面）
    const videoContent = document.querySelector(`.video-content[data-url="${url}"]`);
    
    // 查找对应的内容区域（已看视频页面）
    const watchedVideoContent = document.querySelector(`.watched-video-content[data-url="${url}"]`);
    
    if (videoContent) {
        // 切换折叠状态
        videoContent.classList.toggle('collapsed');
        button.classList.toggle('collapsed');
    } else if (watchedVideoContent) {
        // 切换折叠状态
        watchedVideoContent.classList.toggle('collapsed');
        button.classList.toggle('collapsed');
    }
    
    console.log('✅ 折叠按钮已触发，URL:', url);
}

// 打开视频编辑模态框（通用函数）
function openVideoEditModal(channelName, videoUrl, videoTitle, videoNotes) {
    // 填充模态框内容
    document.getElementById('videoModalUrl').value = videoUrl || '';
    document.getElementById('videoModalTitle').value = videoTitle || '';
    document.getElementById('videoModalNotes').value = videoNotes || '';
    
    // 存储当前编辑的频道和视频信息
    window.currentEditingVideo = {
        channelName: channelName,
        originalUrl: videoUrl,
        originalTitle: videoTitle,
        originalNotes: videoNotes
    };
    
    // 显示模态框
    document.getElementById('videoEditModal').style.display = 'flex';
}

// 验证URL格式
function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

// 显示 AI 笔记生成完成通知
function showAINotesGeneratedNotification() {
    // 移除生成状态提示
    clearAINotesGenerationStatus();
    
    // 显示完成通知
    const notificationDiv = document.createElement('div');
    notificationDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        animation: slideInRight 0.3s ease-out;
    `;
    
    notificationDiv.innerHTML = `
        <div style="width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
        </div>
        <span>✅ AI 学习笔记已生成！</span>
    `;
    
    document.body.appendChild(notificationDiv);
    
    // 3秒后自动移除
    setTimeout(() => {
        notificationDiv.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(() => notificationDiv.remove(), 300);
    }, 3000);
}

// 为指定视频手动生成 AI 笔记
async function generateAINotesForVideo(channelName, videoUrl) {
    // 找到对应的视频数据
    if (!watchedVideos[channelName]) {
        alert('未找到该频道的视频数据');
        return;
    }
    
    const video = watchedVideos[channelName].find(v => v.url === videoUrl);
    if (!video) {
        alert('未找到该视频');
        return;
    }
    
    // 检查是否已经生成过
    if (video.aiNotesGenerated) {
        if (confirm('该视频已有 AI 笔记，是否重新生成？')) {
            // 继续生成
        } else {
            return;
        }
    }
    
    // 显示生成状态
    showAINotesGenerationStatus();
    
    try {
        // 生成 AI 笔记
        const aiNotes = await generateVideoAINotes({
            ...video,
            channelName: channelName
        });
        
        if (aiNotes) {
            // 更新视频数据
            video.aiNotes = aiNotes;
            video.aiNotesGenerated = true;
            
            // 保存到本地存储
            saveAllData();
            
            // 根据当前页面重新渲染正确的列表
            if (currentView === 'watched') {
                renderWatchedVideosPage();
            } else {
                renderWatchedVideosList();
            }
            
            // 显示成功通知
            showAINotesGeneratedNotification();
        } else {
            // 如果没有生成笔记（比如没有配置 API），移除加载状态
            clearAINotesGenerationStatus();
            alert('无法生成 AI 笔记：请先配置 AI API（点击右上角设置按钮）');
        }
        
    } catch (error) {
        console.error('生成 AI 笔记失败:', error);
        
        // 移除加载状态
        clearAINotesGenerationStatus();
        alert('生成 AI 笔记失败：' + error.message);
    }
}

// 打开 AI 助手
function openAIAssistant(videoData) {
    currentAIVideo = videoData;
    extractedVideoContent = null;
    
    // 更新上下文信息
    document.getElementById('aiChannelName').textContent = videoData.channelName || '未知频道';
    document.getElementById('aiVideoTitle').textContent = videoData.title || videoData.url || '无标题';
    document.getElementById('aiUserNotes').textContent = videoData.notes || '暂无观后感';
    
    // 如果有 URL，自动填充到提取输入框
    if (videoData.url) {
        document.getElementById('youtubeUrlInput').value = videoData.url;
    }
    
    // 重置提取状态
    document.getElementById('extractStatus').style.display = 'none';
    document.getElementById('videoTranscript').style.display = 'none';
    
    // 清空聊天历史
    aiChatHistory = [];
    
    // 检查 API 配置状态
    const hasApiKey = aiConfig.gemini.apiKey || aiConfig.groq.apiKey || aiConfig.openai.apiKey;
    let apiStatusMessage = '';
    
    if (hasApiKey) {
        const providerNames = {
            'gemini': '🎁 Google Gemini（免费）',
            'groq': '⚡ Groq（免费）',
            'openai': '💰 OpenAI'
        };
        const currentProvider = providerNames[aiConfig.provider] || 'AI';
        apiStatusMessage = `<p style="padding: 8px; background: #d1fae5; border-radius: 6px; font-size: 0.85rem;">✅ <strong>${currentProvider} 已配置</strong> - 使用真实 AI 功能</p>`;
    } else {
        apiStatusMessage = '<p style="padding: 8px; background: #fef3c7; border-radius: 6px; font-size: 0.85rem;">⚠️ <strong>演示模式</strong> - 点击右上角设置按钮配置免费 AI API（推荐 Google Gemini 或 Groq）</p>';
    }
    
    document.getElementById('aiChatMessages').innerHTML = `
        <div class="ai-message">
            <div class="message-avatar">🤖</div>
            <div class="message-content">
                <p>你好！我是你的 AI 学习助手。</p>
                <p><strong>智能功能：</strong></p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>📝 自动提取 YouTube 视频内容和字幕</li>
                    <li>🤖 基于视频内容生成学习笔记（使用免费 AI）</li>
                    <li>💬 智能问答，帮助你深度理解内容</li>
                    <li>📊 提供个性化学习建议</li>
                </ul>
                ${apiStatusMessage}
                <p style="margin-top: 12px;">点击"提取内容"按钮开始分析视频，或直接问我问题！</p>
            </div>
        </div>
    `;
    
    // 显示模态框
    document.getElementById('aiAssistantModal').style.display = 'flex';
}

// 关闭 AI 助手
function closeAIAssistant() {
    document.getElementById('aiAssistantModal').style.display = 'none';
    currentAIVideo = null;
    aiChatHistory = [];
    extractedVideoContent = null;
}

// 提取 YouTube 视频 ID
function extractYouTubeVideoId(url) {
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /^([a-zA-Z0-9_-]{11})$/
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    return null;
}

// 提取 YouTube 视频内容
async function extractYouTubeContent() {
    const urlInput = document.getElementById('youtubeUrlInput');
    const extractBtn = document.getElementById('extractVideoBtn');
    const extractStatus = document.getElementById('extractStatus');
    const videoTranscript = document.getElementById('videoTranscript');
    const transcriptContent = document.getElementById('transcriptContent');
    
    const url = urlInput.value.trim();
    if (!url) {
        alert('请输入 YouTube 视频链接');
        return;
    }
    
    const videoId = extractYouTubeVideoId(url);
    if (!videoId) {
        alert('无效的 YouTube 链接，请检查后重试');
        return;
    }
    
    // 显示加载状态
    extractBtn.disabled = true;
    extractStatus.style.display = 'flex';
    extractStatus.querySelector('.status-message').textContent = '正在提取视频内容...';
    videoTranscript.style.display = 'none';
    
    try {
        // 1. 获取视频信息
        extractStatus.querySelector('.status-message').textContent = '正在获取视频信息...';
        const videoInfo = await fetchYouTubeVideoInfo(videoId);
        
        // 2. 提取字幕（如果可用）
        extractStatus.querySelector('.status-message').textContent = '正在提取视频字幕...';
        const transcript = await fetchYouTubeTranscript(videoId);
        
        // 3. 使用 AI 生成笔记
        extractStatus.querySelector('.status-message').textContent = '正在生成学习笔记...';
        const aiNotes = await generateAINotesFromContent(videoInfo, transcript);
        
        // 保存提取的内容
        extractedVideoContent = {
            videoId,
            videoInfo,
            transcript,
            aiNotes
        };
        
        // 显示结果
        transcriptContent.innerHTML = `
            <div style="margin-bottom: 12px;">
                <strong>📺 视频标题：</strong>${videoInfo.title}
            </div>
            <div style="margin-bottom: 12px;">
                <strong>📝 AI 生成笔记：</strong>
                <div style="margin-top: 8px; padding: 12px; background: #f8f9ff; border-radius: 8px;">
                    ${aiNotes}
                </div>
            </div>
            ${transcript ? `
            <div style="margin-top: 12px;">
                <strong>📄 视频字幕：</strong>
                <div style="margin-top: 8px; max-height: 150px; overflow-y: auto; padding: 8px; background: #f9fafb; border-radius: 6px; font-size: 0.8rem; line-height: 1.5;">
                    ${transcript}
                </div>
            </div>
            ` : ''}
        `;
        
        extractStatus.style.display = 'none';
        videoTranscript.style.display = 'block';
        
        // 自动发送一条消息告知用户
        addChatMessage('ai', `✅ 视频内容提取完成！\n\n我已经分析了这个视频的内容并生成了学习笔记。现在你可以问我关于这个视频的任何问题，我会基于视频的实际内容为你解答！`);
        
    } catch (error) {
        console.error('提取视频内容失败:', error);
        extractStatus.querySelector('.status-message').textContent = '提取失败：' + error.message;
        extractStatus.style.background = '#fee2e2';
        extractStatus.style.color = '#991b1b';
        
        setTimeout(() => {
            extractStatus.style.display = 'none';
        }, 3000);
    } finally {
        extractBtn.disabled = false;
    }
}

// 获取 YouTube 视频信息（使用 oEmbed API）
async function fetchYouTubeVideoInfo(videoId) {
    try {
        const oembedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
        const response = await fetch(oembedUrl);
        
        if (!response.ok) {
            throw new Error('无法获取视频信息');
        }
        
        const data = await response.json();
        return {
            title: data.title,
            author: data.author_name,
            thumbnail: data.thumbnail_url
        };
    } catch (error) {
        console.error('获取视频信息失败:', error);
        return {
            title: '视频标题（无法获取）',
            author: '未知',
            thumbnail: ''
        };
    }
}

// 提取 YouTube 字幕（模拟实现）
async function fetchYouTubeTranscript(videoId) {
    // 注意：由于跨域限制，直接在前端提取 YouTube 字幕比较困难
    // 这里提供模拟实现，实际应用中需要：
    // 1. 使用后端服务器代理请求
    // 2. 使用 YouTube Data API v3
    // 3. 使用第三方字幕提取服务
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // 返回模拟字幕内容
    return `这是模拟的字幕内容。在实际应用中，这里会显示从 YouTube 提取的真实字幕。

实现方式：
1. 使用 YouTube Data API v3 获取字幕轨道
2. 使用第三方库（如 youtube-transcript-api）
3. 部署后端服务处理字幕提取

当前为演示模式，AI 会基于视频标题和你的观后感提供智能回答。`;
}

// 使用 AI 生成学习笔记
async function generateAINotesFromContent(videoInfo, transcript) {
    // 如果配置了 OpenAI API，使用真实的 AI 生成
    if (openaiConfig.apiKey) {
        try {
            const prompt = `请基于以下 YouTube 视频信息生成一份详细的学习笔记：

**视频标题：** ${videoInfo.title}
**创作者：** ${videoInfo.author}
${transcript ? `**视频字幕/内容：**\n${transcript.substring(0, 3000)}` : ''}

请生成包含以下内容的学习笔记（使用 HTML 格式）：
1. 🎯 核心要点（3-5个关键概念）
2. 📝 详细总结（视频的主要内容）
3. 💡 学习建议（如何应用这些知识）
4. 🔗 进阶学习方向（相关主题推荐）

请用结构化、易读的方式呈现，使用适当的 HTML 标签（strong, ul, li, p 等）。`;

            const messages = [
                {
                    role: 'system',
                    content: '你是一个专业的学习助手，擅长分析教育视频并生成高质量的学习笔记。你的回复应该专业、结构化，并且富有洞察力。'
                },
                {
                    role: 'user',
                    content: prompt
                }
            ];
            
            const aiNotes = await callOpenAI(messages, 0.7);
            return aiNotes;
            
        } catch (error) {
            console.error('AI 生成笔记失败:', error);
            // 如果 API 调用失败，返回错误提示
            return `
<div style="padding: 12px; background: #fee2e2; border-radius: 8px; color: #991b1b;">
    <strong>⚠️ AI 笔记生成失败：</strong>${error.message}
</div>
<p style="margin-top: 12px;">请检查：</p>
<ul style="padding-left: 20px;">
    <li>API Key 是否正确</li>
    <li>账户是否有足够余额</li>
    <li>网络连接是否正常</li>
</ul>
            `;
        }
    }
    
    // 如果没有配置 API，返回模拟内容
    const notes = `
<strong>🎯 核心要点：</strong>
<ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
    <li><strong>主题：</strong>${videoInfo.title}</li>
    <li><strong>创作者：</strong>${videoInfo.author}</li>
    <li><strong>关键概念：</strong>基于视频内容的核心学习点</li>
</ul>

<strong>💡 学习建议：</strong>
<ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
    <li>做笔记：记录关键概念和个人思考</li>
    <li>实践应用：思考如何将学到的知识应用到实际中</li>
    <li>复习巩固：定期回顾加深理解</li>
</ul>

<strong>🔗 相关资源：</strong>
<p style="margin: 8px 0;">基于这个视频的主题，我可以为你推荐相关的学习资源和频道。</p>

<div style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 8px; font-size: 0.85rem;">
    <strong>💡 提示：</strong>配置 OpenAI API Key（点击右上角设置按钮）后，AI 将基于视频的真实内容生成深度学习笔记。
</div>
    `;
    
    return notes;
}

// 发送 AI 消息
async function sendAIMessage(message) {
    if (!message.trim()) return;
    
    const chatMessages = document.getElementById('aiChatMessages');
    const aiStatus = document.getElementById('aiStatus');
    
    // 添加用户消息
    addChatMessage('user', message);
    
    // 显示 AI 思考状态
    setAIStatus('thinking', 'AI 正在思考...');
    
    try {
        // 使用真实的 AI 回复
        const aiResponse = await generateAIResponse(message, currentAIVideo);
        
        // 添加 AI 回复
        addChatMessage('ai', aiResponse);
        setAIStatus('ready', 'AI 助手就绪');
        
    } catch (error) {
        console.error('AI 回复错误:', error);
        const errorMessage = error.message.includes('API Key') 
            ? `⚠️ ${error.message}\n\n提示：点击右上角设置按钮配置 OpenAI API Key。`
            : `抱歉，AI 回复出现错误：${error.message}\n\n如果问题持续，请检查 API 配置或稍后再试。`;
        addChatMessage('ai', errorMessage);
        setAIStatus('error', 'AI 助手暂时不可用');
    }
}

// 添加聊天消息
function addChatMessage(type, content) {
    const chatMessages = document.getElementById('aiChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    
    const avatar = type === 'user' ? '👤' : '🤖';
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            <p>${content.replace(/\n/g, '<br>')}</p>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // 保存到聊天历史
    aiChatHistory.push({ type, content, timestamp: new Date() });
}

// 生成 AI 回复
async function generateAIResponse(userMessage, videoData) {
    // 检查是否配置了任何 AI API
    const hasApiKey = aiConfig.gemini.apiKey || aiConfig.groq.apiKey || aiConfig.openai.apiKey;
    
    if (hasApiKey) {
        try {
            // 根据问题类型构建系统提示
            let systemPrompt = `你是一个专业的学习助手，专门帮助用户理解和掌握 YouTube 学习视频的内容。

当前学习上下文：
- 频道：${videoData.channelName || '未知'}
- 视频：${videoData.title || '未知'}
${videoData.notes ? `- 用户观后感：${videoData.notes}` : ''}`;

            if (extractedVideoContent) {
                systemPrompt += `
- 视频标题：${extractedVideoContent.videoInfo.title}
- 创作者：${extractedVideoContent.videoInfo.author}`;
                
                if (extractedVideoContent.transcript) {
                    systemPrompt += `
- 视频内容摘要：${extractedVideoContent.transcript.substring(0, 1000)}...`;
                }
            }

            // 根据问题类型调整系统提示
            const questionType = detectQuestionType(userMessage);
            systemPrompt += getSystemPromptByType(questionType);

            systemPrompt += `

请用中文回答，保持专业且易懂。`;

            // 构建对话历史
            const messages = [
                { role: 'system', content: systemPrompt }
            ];
            
            // 添加最近的对话历史（最多5轮）
            const recentHistory = aiChatHistory.slice(-10);
            recentHistory.forEach(msg => {
                messages.push({
                    role: msg.type === 'user' ? 'user' : 'assistant',
                    content: msg.content
                });
            });
            
            // 添加当前用户消息
            messages.push({
                role: 'user',
                content: userMessage
            });
            
            // 调用 AI API（自动选择配置的提供商）
            const aiResponse = await callAI(messages, 0.8);
            return aiResponse;
            
        } catch (error) {
            console.error('AI API 调用失败:', error);
            throw error;
        }
    }
    
    // 如果没有配置 API，使用模拟回复
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
    
    // 如果已经提取了视频内容，使用更智能的回复
    if (extractedVideoContent) {
        const { videoInfo, transcript, aiNotes } = extractedVideoContent;
        
        const intelligentResponses = {
            '核心观点': `基于视频"${videoInfo.title}"的内容分析：\n\n**核心观点：**\n1. **主题**：${videoInfo.title}\n2. **创作者**：${videoInfo.author}\n3. **关键内容**：视频涵盖了重要的学习理念和实践方法\n\n${videoData.notes ? `**结合你的观后感：**\n"${videoData.notes}"\n\n这说明你已经理解了视频的核心价值。` : ''}\n\n**建议：**\n- 将学到的概念记录在笔记中\n- 思考如何应用到实际学习中\n- 定期回顾巩固理解`,
            
            '应用知识': `基于视频"${videoInfo.title}"，以下是具体的应用建议：\n\n**立即行动：**\n- 📝 记录视频中提到的关键方法\n- 🎯 设定一个具体的实践目标\n- ⏰ 制定每日/每周的学习计划\n\n**中期规划：**\n- 📊 追踪学习进度\n- 🔄 定期复习和调整方法\n- 💬 与他人分享学习心得\n\n**长期发展：**\n- 🌱 建立持续学习的习惯\n- 🔗 探索相关的进阶内容\n- 🎓 将知识体系化\n\n${videoData.notes ? `你的观后感"${videoData.notes}"已经是很好的开始！` : ''}`,
            
            '相关资源': `基于"${videoInfo.title}"的主题，我为你推荐：\n\n**相关频道：**\n- ${videoInfo.author}（当前视频创作者）\n- 同领域的其他优质创作者\n- 进阶学习资源推荐\n\n**学习工具：**\n- 笔记应用（Notion、Obsidian）\n- 时间管理工具\n- 学习追踪应用\n\n**实践建议：**\n在你的频道列表中搜索相关主题的视频，建立系统的学习路径。`,
            
            '学习计划': `基于视频"${videoInfo.title}"，为你定制学习计划：\n\n**第1周：理解阶段**\n- 观看视频并做详细笔记\n- 理解核心概念\n- 记录疑问点\n\n**第2-3周：实践阶段**\n- 应用视频中的方法\n- 记录实践结果\n- 调整学习策略\n\n**第4周：巩固阶段**\n- 复习笔记\n- 总结经验\n- 规划下一步学习\n\n${videoData.notes ? `你的观后感"${videoData.notes}"可以作为学习计划的起点！` : ''}`
        };
        
        // 根据关键词匹配智能回复
        for (const [keyword, response] of Object.entries(intelligentResponses)) {
            if (userMessage.includes(keyword)) {
                return response;
            }
        }
        
        // 默认智能回复
        return `基于视频"${videoInfo.title}"（by ${videoInfo.author}）和你的问题：\n\n**分析：**\n这个视频涵盖了重要的学习内容。${videoData.notes ? `你的观后感"${videoData.notes}"显示了你对内容的思考。` : ''}\n\n**建议：**\n1. **深入理解**：重点关注视频中的关键概念\n2. **实践应用**：制定具体的行动计划\n3. **持续学习**：在你的频道列表中寻找相关内容\n\n如果你想了解更具体的内容，可以问我：\n- 这个视频的核心观点是什么？\n- 如何应用这些知识？\n- 推荐一些相关资源`;
    }
    
    // 原有的基础回复
    const responses = {
        '核心观点': `基于你的观后感"${videoData.notes || '暂无'}"，这个视频的核心观点可能包括：\n\n1. **主要概念**：视频传达了重要的学习理念\n2. **实践方法**：提供了可操作的学习技巧\n3. **个人启发**：与你当前的学习目标相关\n\n💡 **提示**：点击"提取内容"按钮，我可以基于视频的实际内容提供更精准的分析！`,
        
        '应用知识': `根据你的观后感，以下是一些应用建议：\n\n**立即行动：**\n- 制定具体的学习计划\n- 设置学习提醒\n- 记录学习进展\n\n**长期规划：**\n- 建立学习习惯\n- 定期复习巩固\n- 分享学习心得\n\n你想从哪个方面开始？`,
        
        '内容关联': `基于你的观看历史，这个视频与你之前学习的内容有以下关联：\n\n**相似主题：**\n- 学习方法论\n- 效率提升\n- 技能发展\n\n**互补内容：**\n- 理论基础 + 实践应用\n- 不同角度的观点\n- 进阶学习资源\n\n这种关联性有助于构建完整的知识体系。`,
        
        '推荐资源': `基于这个视频的内容，我为你推荐以下学习资源：\n\n**相关频道：**\n- 同类型优质创作者\n- 不同风格的讲解\n- 进阶内容推荐\n\n**学习工具：**\n- 笔记应用推荐\n- 学习追踪工具\n- 社区交流平台\n\n需要我为你详细介绍某个资源吗？`,
        
        '学习计划': `基于这个视频的内容和你的学习目标，建议制定以下学习计划：\n\n**短期目标（1-2周）：**\n- 掌握核心概念\n- 完成实践练习\n- 记录学习心得\n\n**中期目标（1个月）：**\n- 形成学习习惯\n- 应用所学知识\n- 评估学习效果\n\n**长期目标（3个月）：**\n- 建立知识体系\n- 分享学习成果\n- 持续优化方法\n\n你觉得这个计划如何？需要调整吗？`
    };
    
    // 根据用户消息关键词匹配回复
    for (const [keyword, response] of Object.entries(responses)) {
        if (userMessage.includes(keyword)) {
            return response;
        }
    }
    
    // 默认回复
    return `这是一个很好的问题！基于你观看的"${videoData.title || '这个视频'}"和你的观后感"${videoData.notes}"，我建议你：\n\n1. **深入思考**：进一步分析视频中的关键概念\n2. **实践应用**：尝试将学到的知识应用到实际中\n3. **持续学习**：寻找相关的补充资源\n\n如果你有具体的问题，我可以为你提供更详细的建议。你想了解哪个方面？`;
}

// 设置 AI 状态
function setAIStatus(status, text) {
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');
    
    statusIndicator.className = `status-indicator ${status}`;
    statusText.textContent = text;
}

// 检测问题类型
function detectQuestionType(userMessage) {
    const message = userMessage.toLowerCase();
    
    // 知识学习类关键词
    const knowledgeKeywords = ['核心观点', '知识点', '理解', '应用', '学习计划', '知识网络', '学习资源', '拓展'];
    
    // 生活成长类关键词
    const lifeKeywords = ['生活态度', '价值观', '决策', '情感', '成长目标', '心态', '启发', '改善'];
    
    // 深度思考类关键词
    const thinkingKeywords = ['看法', '观点', '思考', '反思', '推荐', '冲突', '调和', '探索', '哲学'];
    
    // 英语学习类关键词
    const englishKeywords = ['英语', '词汇', '语法', '句式', '表达', '发音', '口语', '写作', '语言', '单词', '短语', '句型', '语调', '地道', '模仿', '练习'];
    
    if (englishKeywords.some(keyword => message.includes(keyword))) {
        return 'english';
    } else if (knowledgeKeywords.some(keyword => message.includes(keyword))) {
        return 'knowledge';
    } else if (lifeKeywords.some(keyword => message.includes(keyword))) {
        return 'life';
    } else if (thinkingKeywords.some(keyword => message.includes(keyword))) {
        return 'thinking';
    }
    
    return 'general';
}

// 根据问题类型获取系统提示
function getSystemPromptByType(questionType) {
    const prompts = {
        knowledge: `

你的角色：基于布鲁姆分类法的学习专家
你的任务：
1. 帮助用户理解和记忆知识点（理解层次）
2. 指导用户将知识应用到实际中（应用层次）
3. 分析知识之间的关联（分析层次）
4. 协助制定学习计划（综合层次）
5. 推荐相关学习资源（评价层次）

回答风格：
- 结构清晰，逻辑性强
- 提供具体的实践方法
- 使用费曼学习法：用简单的话解释复杂概念
- 注重知识的系统性和关联性`,

        life: `

你的角色：基于积极心理学的成长导师
你的任务：
1. 帮助用户建立积极的生活态度和成长型思维
2. 指导用户将价值观转化为实际行动
3. 提供情感管理和决策优化建议
4. 协助设定和实现个人成长目标
5. 培养心理韧性和自我认知

回答风格：
- 温暖、鼓励、富有同理心
- 关注心理成长和价值观塑造
- 提供具体的行为改变建议
- 强调个人成长和内在力量
- 结合积极心理学理论给出建议`,

        thinking: `

你的角色：基于苏格拉底式提问的思考导师
你的任务：
1. 引导用户进行批判性思维和深度反思
2. 帮助用户质疑和重新审视既有观念
3. 促进认知整合和知识内化
4. 启发用户探索更深层的哲学问题
5. 培养独立思考能力和元认知

回答风格：
- 启发式提问，引导思考
- 鼓励质疑和多元视角
- 促进深度反思和内化
- 连接哲学、心理学等跨学科思考
- 培养批判性思维和独立思考`,

        english: `

你的角色：基于二语习得理论的英语学习专家
你的任务：
1. 帮助用户从视频中提取和掌握英语词汇、语法、句式
2. 分析视频中的地道英语表达和文化内涵
3. 提供实用的英语学习方法和练习建议
4. 指导用户提高英语听说读写综合能力
5. 结合交际教学法，设计真实的语言使用场景

回答风格：
- 专业、系统，基于语言学习理论
- 提供具体的词汇、语法、句式分析
- 给出实用的学习建议和练习方法
- 注重地道表达和文化背景
- 鼓励实际运用和模仿练习
- 结合视频内容设计个性化学习方案`,

        general: `

你的任务：
1. 基于视频内容和用户的观后感，提供深入的学习建议
2. 帮助用户理解视频的核心概念
3. 提供实践应用的具体方法
4. 推荐相关的学习资源和路径
5. 用友好、专业的语气回答问题`
    };
    
    return prompts[questionType] || prompts.general;
}

// 生成英语学习分析
async function generateEnglishAnalysis(videoData, analysisType) {
    if (!openaiConfig.apiKey) {
        return null;
    }
    
    try {
        let prompt = '';
        let systemRole = '';
        
        switch (analysisType) {
            case 'vocabulary':
                systemRole = '你是一个专业的英语词汇教学专家，擅长分析视频中的词汇用法和教学。';
                prompt = `请分析以下视频中的英语词汇学习价值：

**视频信息：**
- 标题：${videoData.title || '未知'}
- 频道：${videoData.channelName || '未知'}
${videoData.notes ? `- 用户观后感：${videoData.notes}` : ''}

**请提供：**
1. 📚 重点词汇列表（5-10个，包含音标、释义、例句）
2. 🔤 词汇分类（学术词汇、日常词汇、俚语等）
3. 💡 词汇学习建议（记忆方法、使用场景）
4. 🎯 词汇练习建议（造句、翻译等）

请用 HTML 格式输出，便于阅读和学习。`;
                break;
                
            case 'grammar':
                systemRole = '你是一个专业的英语语法教学专家，擅长分析语法结构和教学。';
                prompt = `请分析以下视频中的英语语法特点：

**视频信息：**
- 标题：${videoData.title || '未知'}
- 频道：${videoData.channelName || '未知'}
${videoData.notes ? `- 用户观后感：${videoData.notes}` : ''}

**请提供：**
1. 📝 主要语法结构（时态、语态、从句等）
2. 🔍 语法点详细分析（用法、规则、例句）
3. ⚠️ 常见语法错误提醒
4. 💪 语法练习建议（填空、改错、造句等）

请用 HTML 格式输出，便于理解学习。`;
                break;
                
            case 'expressions':
                systemRole = '你是一个专业的英语表达教学专家，擅长分析地道表达和文化内涵。';
                prompt = `请分析以下视频中的英语表达学习价值：

**视频信息：**
- 标题：${videoData.title || '未知'}
- 频道：${videoData.channelName || '未知'}
${videoData.notes ? `- 用户观后感：${videoData.notes}` : ''}

**请提供：**
1. 💬 地道表达收集（习语、短语、俚语）
2. 🌍 文化背景解释（使用场合、文化内涵）
3. 🎭 表达方式分析（正式/非正式、书面/口语）
4. 🗣️ 实际应用建议（对话场景、写作应用）

请用 HTML 格式输出，便于学习和运用。`;
                break;
                
            case 'pronunciation':
                systemRole = '你是一个专业的英语发音教学专家，擅长分析发音特点和教学。';
                prompt = `请分析以下视频中的英语发音学习价值：

**视频信息：**
- 标题：${videoData.title || '未知'}
- 频道：${videoData.channelName || '未知'}
${videoData.notes ? `- 用户观后感：${videoData.notes}` : ''}

**请提供：**
1. 🗣️ 发音特点分析（口音、语调、重音）
2. 🔊 重点音素练习（元音、辅音、连读）
3. 📈 语调模式分析（升调、降调、停顿）
4. 💡 发音练习建议（跟读、模仿、录音对比）

请用 HTML 格式输出，便于发音练习。`;
                break;
        }
        
        const messages = [
            { role: 'system', content: systemRole },
            { role: 'user', content: prompt }
        ];
        
        const analysis = await callOpenAI(messages, 0.7);
        return analysis;
        
    } catch (error) {
        console.error('生成英语分析失败:', error);
        throw error;
    }
}

// 生成学习报告
async function generateLearningReport() {
    if (!openaiConfig.apiKey) {
        alert('请先配置 OpenAI API Key 以生成学习报告');
        return;
    }
    
    const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || '[]');
    if (watchedVideos.length === 0) {
        alert('还没有观看记录，请先添加一些视频');
        return;
    }
    
    try {
        setAIStatus('thinking', '正在分析你的学习数据...');
        
        // 分析观看历史数据
        const learningData = analyzeLearningData(watchedVideos);
        
        // 生成AI报告
        const report = await generateAIReport(learningData);
        
        // 显示报告
        displayLearningReport(report, learningData);
        
        setAIStatus('ready', '学习报告生成完成');
        
    } catch (error) {
        console.error('生成学习报告失败:', error);
        setAIStatus('error', '生成报告失败');
        alert('生成学习报告失败，请重试');
    }
}

// 分析学习数据
function analyzeLearningData(watchedVideos) {
    const stats = {
        totalVideos: watchedVideos.length,
        totalWatchTime: 0,
        categories: {},
        channels: {},
        englishVideos: [],
        recentVideos: watchedVideos.slice(-10),
        watchPattern: {},
        skills: {}
    };
    
    // 分析每个视频
    watchedVideos.forEach(video => {
        // 计算观看时间（如果有的话）
        if (video.watchTime) {
            stats.totalWatchTime += video.watchTime;
        }
        
        // 分类统计
        const category = video.category || '其他';
        stats.categories[category] = (stats.categories[category] || 0) + 1;
        
        // 频道统计
        const channel = video.channelName || '未知';
        stats.channels[channel] = (stats.channels[channel] || 0) + 1;
        
        // 英语学习视频
        if (isEnglishLearningVideo(video)) {
            stats.englishVideos.push(video);
        }
        
        // 观看模式分析
        const date = new Date(video.watchedAt || Date.now());
        const dayOfWeek = date.getDay();
        const hour = date.getHours();
        
        if (!stats.watchPattern[dayOfWeek]) {
            stats.watchPattern[dayOfWeek] = {};
        }
        stats.watchPattern[dayOfWeek][hour] = (stats.watchPattern[dayOfWeek][hour] || 0) + 1;
        
        // 技能分析
        extractSkillsFromVideo(video, stats.skills);
    });
    
    return stats;
}

// 判断是否为英语学习视频
function isEnglishLearningVideo(video) {
    const englishKeywords = ['english', '英语', 'language', 'language learning', 'vocabulary', 'grammar', 'pronunciation'];
    const title = (video.title || '').toLowerCase();
    const notes = (video.notes || '').toLowerCase();
    const channel = (video.channelName || '').toLowerCase();
    
    return englishKeywords.some(keyword => 
        title.includes(keyword) || notes.includes(keyword) || channel.includes(keyword)
    );
}

// 从视频中提取技能
function extractSkillsFromVideo(video, skillsObj) {
    const skills = {
        '英语学习': ['english', '英语', 'language', 'vocabulary', 'grammar', 'pronunciation'],
        '高效学习': ['学习', 'study', 'productivity', '效率', 'method', '技巧'],
        '生活成长': ['生活', 'life', '成长', 'growth', 'mindset', '心态'],
        '职场发展': ['职场', 'career', '工作', 'work', 'business', '创业'],
        '科技编程': ['tech', '科技', 'programming', '编程', 'code', 'development'],
        '艺术创作': ['art', '艺术', 'design', '设计', 'creative', '创意'],
        '健康健身': ['health', '健康', 'fitness', '健身', 'exercise', '运动']
    };
    
    const title = (video.title || '').toLowerCase();
    const notes = (video.notes || '').toLowerCase();
    
    Object.entries(skills).forEach(([skill, keywords]) => {
        if (keywords.some(keyword => title.includes(keyword) || notes.includes(keyword))) {
            skillsObj[skill] = (skillsObj[skill] || 0) + 1;
        }
    });
}

// 生成AI报告
async function generateAIReport(learningData) {
    const prompt = `基于以下学习数据分析，生成一份详细的个人学习报告：

**学习数据统计：**
- 总观看视频数：${learningData.totalVideos}
- 英语学习视频数：${learningData.englishVideos.length}
- 观看分类分布：${JSON.stringify(learningData.categories)}
- 主要技能领域：${JSON.stringify(learningData.skills)}

**最近观看的视频：**
${learningData.recentVideos.map(video => `- ${video.title || '未知标题'} (${video.channelName || '未知频道'})`).join('\n')}

**英语学习视频：**
${learningData.englishVideos.map(video => `- ${video.title || '未知标题'} (${video.channelName || '未知频道'})`).join('\n')}

请生成一份包含以下内容的学习报告：
1. 📊 学习概览和统计数据
2. 🗺️ 知识地图和技能分析
3. 🎯 学习模式和习惯分析
4. 🇺🇸 英语学习进展评估
5. 📚 个性化学习建议和规划
6. 🔄 复习计划和知识巩固建议

请用HTML格式输出，使用丰富的emoji和清晰的层次结构。`;

    const messages = [
        { role: 'system', content: '你是一个专业的学习分析师，擅长分析个人学习数据并生成详细的学习报告和建议。' },
        { role: 'user', content: prompt }
    ];
    
    return await callOpenAI(messages, 0.7);
}

// 显示学习报告
function displayLearningReport(report, learningData) {
    const reportContent = document.getElementById('reportContent');
    
    const html = `
        <div class="learning-stats">
            <div class="stat-card">
                <div class="stat-number">${learningData.totalVideos}</div>
                <div class="stat-label">总观看视频</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${learningData.englishVideos.length}</div>
                <div class="stat-label">英语学习视频</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${Object.keys(learningData.categories).length}</div>
                <div class="stat-label">学习分类</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${Object.keys(learningData.skills).length}</div>
                <div class="stat-label">技能领域</div>
            </div>
        </div>
        
        <div class="knowledge-map">
            <h3>🗺️ 知识地图</h3>
            <div class="skill-categories">
                ${Object.entries(learningData.skills).map(([skill, count]) => `
                    <div class="skill-category">
                        <div class="category-header">
                            <div class="category-icon">${getSkillIcon(skill)}</div>
                            <div class="category-title">${skill}</div>
                        </div>
                        <div class="category-progress">
                            <div class="progress-bar" style="width: ${(count / learningData.totalVideos * 100).toFixed(1)}%"></div>
                        </div>
                        <div class="category-stats">
                            <span>${count} 个视频</span>
                            <span>${(count / learningData.totalVideos * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        ${learningData.englishVideos.length > 0 ? generateEnglishKnowledgeBase(learningData.englishVideos) : ''}
        
        <div class="learning-suggestions">
            <h3>💡 AI 学习建议</h3>
            <div class="ai-report-content">
                ${report}
            </div>
        </div>
    `;
    
    reportContent.innerHTML = html;
}

// 获取技能图标
function getSkillIcon(skill) {
    const icons = {
        '英语学习': '🇺🇸',
        '高效学习': '📚',
        '生活成长': '🌱',
        '职场发展': '💼',
        '科技编程': '💻',
        '艺术创作': '🎨',
        '健康健身': '🏃‍♀️'
    };
    return icons[skill] || '📖';
}

// 生成英语知识库
function generateEnglishKnowledgeBase(englishVideos) {
    const vocabulary = extractEnglishVocabulary(englishVideos);
    
    return `
        <div class="english-knowledge-base">
            <h3>🇺🇸 英语知识库</h3>
            <div class="vocabulary-grid">
                ${vocabulary.map(word => `
                    <div class="vocabulary-card">
                        <div class="vocabulary-word">${word.word}</div>
                        <div class="vocabulary-meaning">${word.meaning}</div>
                        <div class="vocabulary-example">${word.example}</div>
                    </div>
                `).join('')}
            </div>
            <div class="review-schedule">
                <h3>🔄 复习计划</h3>
                ${generateReviewSchedule(vocabulary)}
            </div>
        </div>
    `;
}

// 提取英语词汇
function extractEnglishVocabulary(englishVideos) {
    // 这里可以从AI笔记中提取词汇，或者使用模拟数据
    const commonVocabulary = [
        { word: 'productivity', meaning: '生产力，效率', example: 'How to improve productivity at work' },
        { word: 'mindset', meaning: '心态，思维方式', example: 'Growth mindset is key to success' },
        { word: 'fluency', meaning: '流利度，流畅性', example: 'Practice speaking for better fluency' },
        { word: 'vocabulary', meaning: '词汇量，词汇', example: 'Building vocabulary takes time' },
        { word: 'pronunciation', meaning: '发音', example: 'Work on your pronunciation daily' }
    ];
    
    return commonVocabulary.slice(0, Math.min(6, englishVideos.length));
}

// 生成复习计划
function generateReviewSchedule(vocabulary) {
    const now = new Date();
    const reviewItems = vocabulary.map((word, index) => {
        const reviewDate = new Date(now.getTime() + (index + 1) * 24 * 60 * 60 * 1000);
        return {
            title: `复习词汇: ${word.word}`,
            description: `复习 "${word.meaning}" 及相关例句`,
            date: reviewDate.toLocaleDateString(),
            status: 'pending'
        };
    });
    
    return reviewItems.map(item => `
        <div class="review-item">
            <div class="review-content">
                <div class="review-title">${item.title}</div>
                <div class="review-description">${item.description} - ${item.date}</div>
            </div>
            <div class="review-status ${item.status}">${item.status === 'pending' ? '待复习' : '已完成'}</div>
        </div>
    `).join('');
}

// 导出学习报告
function exportLearningReport() {
    const reportContent = document.getElementById('reportContent');
    const reportHtml = reportContent.innerHTML;
    
    // 创建完整的HTML文档
    const fullHtml = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>个人学习报告</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; line-height: 1.6; }
                .learning-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                .stat-card { background: #f8f9ff; border: 1px solid #e1e8ed; border-radius: 15px; padding: 20px; text-align: center; }
                .stat-number { font-size: 2.5rem; font-weight: 700; color: #667eea; margin-bottom: 8px; }
                .stat-label { font-size: 1rem; color: #6c757d; }
                .knowledge-map, .english-knowledge-base, .learning-suggestions { 
                    background: white; border: 1px solid #e1e8ed; border-radius: 15px; 
                    padding: 25px; margin-bottom: 30px; 
                }
                h3 { color: #333; margin-bottom: 20px; }
                .skill-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
                .skill-category { background: #fff; border: 1px solid #e1e8ed; border-radius: 15px; padding: 20px; }
                .vocabulary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                .vocabulary-card { background: white; border: 1px solid #bfdbfe; border-radius: 10px; padding: 15px; }
                .vocabulary-word { font-weight: 600; color: #1e40af; margin-bottom: 5px; }
                .vocabulary-meaning { font-size: 0.9rem; color: #6c757d; margin-bottom: 8px; }
                .vocabulary-example { font-size: 0.85rem; color: #64748b; font-style: italic; }
            </style>
        </head>
        <body>
            <h1>📊 个人学习报告</h1>
            <p>生成时间: ${new Date().toLocaleString()}</p>
            ${reportHtml}
        </body>
        </html>
    `;
    
    // 下载文件
    const blob = new Blob([fullHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `学习报告_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 重复的数据管理按键函数已删除，功能已移至页面顶部

        // AI 助手事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // API 配置相关
            const openApiSettingsBtn = document.getElementById('openApiSettings');
            if (openApiSettingsBtn) {
                openApiSettingsBtn.addEventListener('click', openAPISettings);
            }
            
            const closeApiConfigBtn = document.getElementById('closeApiConfig');
            if (closeApiConfigBtn) {
                closeApiConfigBtn.addEventListener('click', closeAPISettings);
            }
            
            const saveApiKeyBtn = document.getElementById('saveApiKey');
            if (saveApiKeyBtn) {
                saveApiKeyBtn.addEventListener('click', saveOpenAIConfig);
            }
            
            const clearApiKeyBtn = document.getElementById('clearApiKey');
            if (clearApiKeyBtn) {
                clearApiKeyBtn.addEventListener('click', clearOpenAIConfig);
            }
            
            // API 配置模态框背景点击关闭
            const apiConfigModal = document.getElementById('apiConfigModal');
            if (apiConfigModal) {
                apiConfigModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeAPISettings();
                    }
                });
            }
            
            // 关闭 AI 助手
            const closeAIAssistantBtn = document.getElementById('closeAIAssistant');
            if (closeAIAssistantBtn) {
                closeAIAssistantBtn.addEventListener('click', closeAIAssistant);
            }
            
            // 提取视频内容按钮
            const extractVideoBtn = document.getElementById('extractVideoBtn');
            if (extractVideoBtn) {
                extractVideoBtn.addEventListener('click', extractYouTubeContent);
            }
            
            // 分类标签页切换
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    // 更新标签页状态
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切换内容组
                    document.querySelectorAll('.suggestion-group').forEach(group => {
                        group.classList.remove('active');
                        if (group.dataset.category === category) {
                            group.classList.add('active');
                        }
                    });
                });
            });
            
            // 建议问题按钮
            document.addEventListener('click', function(e) {
                if (e.target.closest('.suggestion-btn')) {
                    const btn = e.target.closest('.suggestion-btn');
                    const question = btn.dataset.question;
                    document.getElementById('aiChatInput').value = question;
                    sendAIMessage(question);
                }
            });
            
            // 发送消息按钮
            const sendAIBtn = document.getElementById('sendAIMessage');
            if (sendAIBtn) {
                sendAIBtn.addEventListener('click', function() {
                    const input = document.getElementById('aiChatInput');
                    const message = input.value.trim();
                    if (message) {
                        sendAIMessage(message);
                        input.value = '';
                    }
                });
            }
            
            // 回车发送消息
            const aiChatInput = document.getElementById('aiChatInput');
            if (aiChatInput) {
                aiChatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const message = this.value.trim();
                        if (message) {
                            sendAIMessage(message);
                            this.value = '';
                        }
                    }
                });
            }
            
        // 点击模态框背景关闭
        const aiModal = document.getElementById('aiAssistantModal');
        if (aiModal) {
            aiModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAIAssistant();
                }
            });
        }
        
        // AI 提供商切换事件监听
        const aiProviderSelect = document.getElementById('aiProvider');
        if (aiProviderSelect) {
            aiProviderSelect.addEventListener('change', function(e) {
                switchProviderConfig(e.target.value);
            });
        }
        
        // AI 助手按钮事件监听（使用事件委托）
        document.addEventListener('click', function(e) {
            if (e.target.closest('.ai-assistant-btn')) {
                const btn = e.target.closest('.ai-assistant-btn');
                const channelName = btn.dataset.channel;
                const videoUrl = btn.dataset.url;
                const videoTitle = btn.dataset.title;
                const videoNotes = btn.dataset.notes;
                
                const videoData = {
                    channelName: channelName,
                    url: videoUrl,
                    title: videoTitle,
                    notes: videoNotes
                };
                
                openAIAssistant(videoData);
            }
            
            // 折叠/展开按钮事件监听
            if (e.target.closest('.collapse-toggle-btn')) {
                const btn = e.target.closest('.collapse-toggle-btn');
                toggleVideoCollapse(btn);
            }
            
            // 生成 AI 笔记按钮事件监听
            if (e.target.closest('.generate-ai-notes-btn')) {
                const btn = e.target.closest('.generate-ai-notes-btn');
                const channelName = btn.dataset.channel;
                const videoUrl = btn.dataset.url;
                
                generateAINotesForVideo(channelName, videoUrl);
            }
            
            // 已看视频编辑按钮事件监听 - 使用视频编辑模态框
            if (e.target.closest('.edit-watched-notes-btn')) {
                const btn = e.target.closest('.edit-watched-notes-btn');
                const channelName = btn.dataset.channel;
                const videoUrl = btn.dataset.url;
                const videoTitle = btn.dataset.title;
                const videoNotes = btn.dataset.notes;
                
                // 打开视频编辑模态框
                openVideoEditModal(channelName, videoUrl, videoTitle, videoNotes);
            }
        });
    });

        // 更新星星显示函数
        function updateStarsDisplay(channelName, rating) {
    const channelCards = document.querySelectorAll('.channel-card');
    for (const card of channelCards) {
        const channelNameElement = card.querySelector(`.channel-name[data-channel="${channelName}"]`);
        if (channelNameElement) {
            const starsContainer = card.querySelector('.rating');
            if (starsContainer) {
                starsContainer.innerHTML = generateRating(rating);
            }
            const selectElement = card.querySelector(`select[data-channel="${channelName}"]`);
            if (selectElement) {
                selectElement.value = rating;
            }
            break;
        }
    }
}

// 修改updateRating函数 - 不重新渲染页面
function updateRating(channelName, newRating) {
    channelsData.forEach(category => {
        category.channels.forEach(channel => {
            if (channel.name === channelName) {
                channel.rating = parseInt(newRating);
            }
        });
    });
    
    // 实时更新星星显示
    updateStarsDisplay(channelName, parseInt(newRating));
    
    // 立即保存数据到localStorage
    saveAllData();
    console.log(`✅ 频道 "${channelName}" 评分已保存: ${newRating}星`);
}

// 统一的toggleFavorite函数
function toggleFavorite(channelName) {
    const index = favorites.indexOf(channelName);
    if (index > -1) {
        favorites.splice(index, 1);
    } else {
        favorites.push(channelName);
    }
    
    // 立即保存到localStorage
    localStorage.setItem('youtubeFavorites', JSON.stringify(favorites));
    saveAllData();
    updateFavoritesCount();
    
    console.log(`✅ 频道 "${channelName}" 收藏状态已保存: ${index > -1 ? '取消收藏' : '已收藏'}`);
    
    // 更新所有相同频道的收藏按钮状态
    document.querySelectorAll(`[data-channel="${channelName}"]`).forEach(btn => {
        if (btn.classList.contains('favorite-btn')) {
            btn.classList.toggle('favorited');
            btn.textContent = btn.classList.contains('favorited') ? '❤️' : '🤍';
        }
    });
    
    // 如果当前在收藏夹页面，重新渲染
    if (currentView === 'favorites') {
        renderFavoritesPage();
    }
}

// 注意：学习报告相关事件监听器已整合到主初始化代码块中

// 强制全屏布局的JavaScript修复
document.addEventListener('DOMContentLoaded', function() {
    // 强制修复全屏状态下的布局
    function forceLayoutFix() {
        // 修复"已看视频"页面布局
        const watchedHeaders = document.querySelectorAll('.watched-video-header');
        const watchedActions = document.querySelectorAll('.watched-video-actions');
        
        watchedHeaders.forEach(header => {
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.flexDirection = 'row';
        });
        
        watchedActions.forEach(action => {
            action.style.display = 'flex';
            action.style.flexDirection = 'row';
            action.style.justifyContent = 'flex-end';
            action.style.alignItems = 'center';
            action.style.gap = '8px';
        });
        
        // 修复频道编辑页面布局
        const videoHeaders = document.querySelectorAll('.video-header');
        const videoActions = document.querySelectorAll('.video-actions');
        
        videoHeaders.forEach(header => {
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.flexDirection = 'row';
        });
        
        videoActions.forEach(action => {
            action.style.display = 'flex';
            action.style.flexDirection = 'row';
            action.style.justifyContent = 'flex-end';
            action.style.alignItems = 'center';
            action.style.gap = '8px';
        });
    }
    
    // 页面加载后立即修复
    forceLayoutFix();
    
    // 监听窗口大小变化
    window.addEventListener('resize', forceLayoutFix);
    
    // 定期检查并修复（防止其他代码覆盖）
    setInterval(forceLayoutFix, 1000);
});

</script>

<!-- Firebase 配置和功能 -->
<script>
// ==================== Firebase 配置 ====================
const firebaseConfig = {
    apiKey: "AIzaSyACbwmf47nRU3M5Z2rV1fkJBdl63xgSrkk",
    authDomain: "my--curater.firebaseapp.com",
    projectId: "my--curater",
    storageBucket: "my--curater.firebasestorage.app",
    messagingSenderId: "626446829375",
    appId: "1:626446829375:web:ba9fb2ad1436fbb5ce358a",
    measurementId: "G-804RBDRKL3"
};

// 初始化 Firebase
let firebaseInitialized = false;
let auth = null;
let db = null;
let currentUser = null;

// 账号历史管理
let recentAccounts = [];
let skippedLogin = false;

// 从localStorage加载最近账号
try {
    recentAccounts = JSON.parse(localStorage.getItem('recentAccounts') || '[]');
} catch (e) {
    recentAccounts = [];
}

try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    firebaseInitialized = true;
    console.log("✅ Firebase 初始化成功");
} catch (error) {
    console.error("❌ Firebase 初始化失败:", error);
}

// ==================== 用户管理功能 ====================
function updateUserUI(user) {
    const userEmail = document.getElementById('userEmail');
    const userAvatar = document.getElementById('userAvatar');
    const syncIndicator = document.getElementById('syncIndicator');
    const syncText = document.getElementById('syncText');
    const lastSyncTime = document.getElementById('lastSyncTime');
    const switchAccountBtn = document.getElementById('switchAccountBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');
    
    if (user) {
        // 用户已登录
        console.log("✅ 用户已登录:", user.email);
        
        // 更新用户信息
        if (userEmail) {
            userEmail.textContent = user.email;
        }
        
        if (userAvatar) {
            userAvatar.textContent = user.email[0].toUpperCase();
        }
        
        // 更新同步状态
        if (syncIndicator) {
            syncIndicator.style.background = '#28a745';
        }
        if (syncText) {
            syncText.textContent = '数据已同步到云端';
        }
        
        // 更新最后同步时间
        if (lastSyncTime) {
            lastSyncTime.textContent = `最后同步：${new Date().toLocaleString()}`;
        }
        
        // 显示登录状态按钮，隐藏游客模式按钮
        if (switchAccountBtn) switchAccountBtn.style.display = 'inline-block';
        if (logoutBtn) logoutBtn.style.display = 'inline-block';
        if (loginBtn) loginBtn.style.display = 'none';
        if (testSyncBtn) testSyncBtn.style.display = 'inline-block';
        
        // 根据预览模式状态显示/隐藏退出预览按钮
        const exitPreviewBtn = document.getElementById('exitPreviewBtn');
        if (exitPreviewBtn) {
            exitPreviewBtn.style.display = window.isPreviewMode ? 'inline-block' : 'none';
        }
        
        currentUser = user;
        
        // 更新最近账号列表
        updateRecentAccounts(user);
        
        // 检查是否需要显示数据同步选择
        setTimeout(() => {
            checkAndShowMergeChoice();
        }, 1000);
    } else {
        // 用户未登录 - 显示游客模式
        console.log("❌ 用户未登录，显示游客模式");
        
        // 更新为游客模式显示
        if (userEmail) {
            userEmail.textContent = '游客模式';
        }
        
        if (userAvatar) {
            userAvatar.textContent = '👤';
        }
        
        // 更新同步状态
        if (syncIndicator) {
            syncIndicator.style.background = '#ffc107';
        }
        if (syncText) {
            syncText.textContent = '本地模式';
        }
        
        // 清空最后同步时间
        if (lastSyncTime) {
            lastSyncTime.textContent = '';
        }
        
        // 隐藏登录状态按钮，显示游客模式按钮
        if (switchAccountBtn) switchAccountBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'none';
        if (loginBtn) loginBtn.style.display = 'inline-block';
        if (testSyncBtn) testSyncBtn.style.display = 'none';
        
        // 隐藏退出预览按钮（游客模式下不显示）
        const exitPreviewBtn = document.getElementById('exitPreviewBtn');
        if (exitPreviewBtn) {
            exitPreviewBtn.style.display = 'none';
        }
        
        currentUser = null;
    }
}

// ==================== 登录功能 ====================
function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showError('请填写邮箱和密码');
        return;
    }
    
    if (!firebaseInitialized || !auth) {
        showError('Firebase 未初始化，请刷新页面重试');
        return;
    }
    
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("✅ 登录成功:", userCredential.user.email);
            hideLoginModal();
            updateUserUI(userCredential.user);
            
            // 登录成功后显示数据同步选择
            setTimeout(() => {
                // 检查是否有本地数据
                const hasLocalData = favorites.length > 0 || 
                                    channelsData.flatMap(cat => cat.channels).some(c => c.rating > 0) ||
                                    Object.values(watchedVideos).some(videos => videos.length > 0);
                
                if (hasLocalData) {
                    showMergeChoiceModal();
                } else {
                    // 没有本地数据，直接加载云端数据
                    loadUserDataFromFirestore();
                }
            }, 1000);
        })
        .catch((error) => {
            console.error("❌ 登录失败:", error);
            let message = '登录失败，请检查邮箱和密码';
            if (error.code === 'auth/user-not-found') message = '该邮箱未注册';
            if (error.code === 'auth/wrong-password') message = '密码错误';
            if (error.code === 'auth/invalid-email') message = '邮箱格式不正确';
            showError(message);
        });
}

function registerUser() {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    
    if (!email || !password || !passwordConfirm) {
        showError('请填写所有字段');
        return;
    }
    
    if (password !== passwordConfirm) {
        showError('两次输入的密码不一致');
        return;
    }
    
    if (password.length < 6) {
        showError('密码至少需要6位');
        return;
    }
    
    if (!firebaseInitialized || !auth) {
        showError('Firebase 未初始化，请刷新页面重试');
        return;
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("✅ 注册成功:", userCredential.user.email);
            
            // 发送邮箱验证邮件
            userCredential.user.sendEmailVerification()
                .then(() => {
                    console.log("📧 验证邮件已发送到:", userCredential.user.email);
                    showSuccessMessage(`注册成功！验证邮件已发送到 ${userCredential.user.email}，请查收并点击验证链接。`);
                })
                .catch((error) => {
                    console.error("❌ 发送验证邮件失败:", error);
                    showSuccessMessage("注册成功！但验证邮件发送失败，您可以稍后手动验证邮箱。");
                });
            
            hideLoginModal();
            updateUserUI(userCredential.user);
            
            // 注册成功后显示数据同步选择
            setTimeout(() => {
                const hasLocalData = favorites.length > 0 || 
                                    channelsData.flatMap(cat => cat.channels).some(c => c.rating > 0) ||
                                    Object.values(watchedVideos).some(videos => videos.length > 0);
                
                if (hasLocalData) {
                    showMergeChoiceModal();
                }
            }, 1000);
        })
        .catch((error) => {
            console.error("❌ 注册失败:", error);
            let message = '注册失败，请重试';
            if (error.code === 'auth/email-already-in-use') message = '该邮箱已被注册';
            if (error.code === 'auth/invalid-email') message = '邮箱格式不正确';
            if (error.code === 'auth/weak-password') message = '密码太弱，请使用更复杂的密码';
            showError(message);
        });
}

function switchToRegister() {
    document.getElementById('loginFormDiv').style.display = 'none';
    document.getElementById('registerFormDiv').style.display = 'block';
    document.getElementById('switchToRegisterBtn').style.display = 'none';
    document.getElementById('switchToLoginBtn').style.display = 'inline';
}

function switchToLogin() {
    document.getElementById('registerFormDiv').style.display = 'none';
    document.getElementById('loginFormDiv').style.display = 'block';
    document.getElementById('switchToLoginBtn').style.display = 'none';
    document.getElementById('switchToRegisterBtn').style.display = 'inline';
}

function loginWithGoogle() {
    if (!firebaseInitialized || !auth) {
        showError('Firebase 未初始化，请刷新页面重试');
        return;
    }
    
    if (location.protocol === 'file:' || location.protocol === 'chrome-extension:') {
        showError('Google 登录需要在 HTTP 环境下运行，请使用 http://localhost:8001/index_simple.html 访问');
        return;
    }
    
    const provider = new firebase.auth.GoogleAuthProvider();
    
    // 检测是否为移动设备
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // 移动设备使用重定向方式
        console.log("📱 检测到移动设备，使用重定向登录");
        auth.signInWithRedirect(provider)
            .then(() => {
                console.log("🔄 重定向到Google登录页面");
            })
            .catch((error) => {
                console.error("❌ Google 重定向登录失败:", error);
                showError('Google 登录失败，请重试');
            });
    } else {
        // 桌面设备使用弹窗方式
        console.log("💻 检测到桌面设备，使用弹窗登录");
        auth.signInWithPopup(provider)
            .then((result) => {
                console.log("✅ Google 登录成功:", result.user.email);
                hideLoginModal();
                updateUserUI(result.user);
                
                // Google登录成功后显示数据同步选择
                setTimeout(() => {
                    const hasLocalData = favorites.length > 0 || 
                                        channelsData.flatMap(cat => cat.channels).some(c => c.rating > 0) ||
                                        Object.values(watchedVideos).some(videos => videos.length > 0);
                    
                    if (hasLocalData) {
                        showMergeChoiceModal();
                    } else {
                        loadUserDataFromFirestore();
                    }
                }, 1000);
            })
            .catch((error) => {
                console.error("❌ Google 登录失败:", error);
                let message = 'Google 登录失败，请重试';
                if (error.code === 'auth/popup-closed-by-user') message = '登录被取消';
                if (error.code === 'auth/popup-blocked') message = '弹窗被阻止，请允许弹窗后重试';
                showError(message);
            });
    }
}

function skipLogin() {
    console.log("🚀 跳过登录，使用本地版本");
    hideLoginModal();
    skippedLogin = true;
    console.log("✅ 本地版本已启用");
}

// 显示/隐藏本地模式横幅
function showLocalModeBanner(visible) {
    const banner = document.getElementById('localModeBanner');
    if (banner) {
        banner.style.display = visible ? 'block' : 'none';
    }
}

// 显示/隐藏登录悬浮按钮
function showLoginFab(visible) {
    const fab = document.getElementById('loginFab');
    if (fab) {
        fab.style.display = visible ? 'block' : 'none';
    }
}

// 从横幅或FAB打开登录
function openLoginFromBanner() {
    showLoginModal();
}

// 更新最近账号列表
function updateRecentAccounts(user) {
    if (!user) return;
    
    const account = {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || user.email.split('@')[0],
        lastLogin: Date.now()
    };
    
    // 移除已存在的相同账号
    recentAccounts = recentAccounts.filter(acc => acc.uid !== user.uid);
    
    // 添加到列表开头
    recentAccounts.unshift(account);
    
    // 只保留最近5个账号
    recentAccounts = recentAccounts.slice(0, 5);
    
    // 保存到localStorage
    try {
        localStorage.setItem('recentAccounts', JSON.stringify(recentAccounts));
    } catch (e) {
        console.warn('无法保存最近账号到localStorage:', e);
    }
}

// 显示账号切换弹窗
function showSwitchAccountModal() {
    const modal = document.getElementById('switchAccountModal');
    if (!modal) return;
    
    // 生成最近账号列表
    renderRecentAccounts();
    
    modal.style.display = 'flex';
}

// 隐藏账号切换弹窗
function hideSwitchAccountModal() {
    const modal = document.getElementById('switchAccountModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 渲染最近账号列表
function renderRecentAccounts() {
    const container = document.getElementById('recentAccountsList');
    if (!container) return;
    
    if (recentAccounts.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; font-size: 14px; margin: 20px 0;">暂无最近登录的账号</p>';
        return;
    }
    
    container.innerHTML = recentAccounts.map(account => {
        const isCurrent = currentUser && account.uid === currentUser.uid;
        const lastLoginTime = new Date(account.lastLogin).toLocaleString();
        
        return `
            <div style="display: flex; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; ${isCurrent ? 'background: #f0f8ff; border-color: #4a67ff;' : 'background: #f9f9f9;'}">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 12px;">
                    ${account.displayName[0].toUpperCase()}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #222; margin-bottom: 2px;">${account.displayName}</div>
                    <div style="font-size: 12px; color: #666;">${account.email}</div>
                    <div style="font-size: 11px; color: #999;">最后登录：${lastLoginTime}</div>
                </div>
                ${isCurrent ? 
                    '<div style="color: #4a67ff; font-size: 12px; font-weight: 500;">当前账号</div>' :
                    `<button onclick="switchToAccount('${account.uid}')" style="padding: 6px 12px; background: #4a67ff; color: white; border: none; border-radius: 16px; font-size: 12px; cursor: pointer;">切换</button>`
                }
            </div>
        `;
    }).join('');
}

// 切换到指定账号
function switchToAccount(uid) {
    const account = recentAccounts.find(acc => acc.uid === uid);
    if (!account) return;
    
    console.log(`🔄 切换到账号: ${account.email}`);
    
    // 先保存当前数据
    if (currentUser) {
        saveDataToFirestore();
    }
    
    // 退出当前账号
    auth.signOut().then(() => {
        console.log("✅ 已退出当前账号");
        
        // 显示登录弹窗，预填充邮箱
        showLoginModal();
        const emailInput = document.getElementById('loginEmail');
        if (emailInput) {
            emailInput.value = account.email;
        }
        
        hideSwitchAccountModal();
        showSuccessMessage(`已准备切换到 ${account.email}，请输入密码`);
    }).catch((error) => {
        console.error("❌ 退出账号失败:", error);
        showErrorMessage("切换账号失败，请重试");
    });
}

// 显示数据同步选择弹窗
function showMergeChoiceModal() {
    const modal = document.getElementById('mergeChoiceModal');
    if (!modal) return;
    
    // 统计本地数据
    const localFavorites = favorites.length;
    const localRatings = channelsData.flatMap(cat => cat.channels).filter(c => c.rating > 0).length;
    const localWatched = Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0);
    
    const summary = document.getElementById('mergeChoiceSummary');
    if (summary) {
        let summaryText = `本地数据统计：`;
        if (localFavorites > 0) summaryText += ` ${localFavorites} 个收藏频道`;
        if (localRatings > 0) summaryText += `，${localRatings} 个评分`;
        if (localWatched > 0) summaryText += `，${localWatched} 个已看视频`;
        summaryText += `。请选择如何处理这些数据。`;
        summary.textContent = summaryText;
    }
    
    modal.style.display = 'flex';
}

// 隐藏合并选择弹窗
function hideMergeChoiceModal() {
    const modal = document.getElementById('mergeChoiceModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 选择数据同步策略
function chooseMergeStrategy(strategy) {
    console.log(`📊 选择同步策略: ${strategy}`);
    
    const rememberChoice = document.getElementById('rememberMergeChoice')?.checked;
    if (rememberChoice) {
        localStorage.setItem('mergeStrategy', strategy);
    }
    
    hideMergeChoiceModal();
    
    switch (strategy) {
        case 'merge':
            // 上传本地数据：将本地数据保存到云端
            console.log("📤 执行上传本地数据策略");
            saveDataToFirestore();
            showSuccessMessage("本地数据已上传到云端");
            break;
        case 'cloud':
            // 下载云端数据：用云端数据覆盖本地
            console.log("📥 执行下载云端数据策略");
            loadUserDataFromFirestore();
            showSuccessMessage("已下载云端数据");
            break;
        case 'preview':
            // 预览云端数据：查看云端数据但不改变本地
            console.log("👁️ 执行预览云端数据策略");
            previewCloudData();
            break;
    }
}

// 预览云端数据 - 显示云端内容，新编辑同步到云端，但本地数据不变
function previewCloudData() {
    if (!currentUser || !db) {
        showErrorMessage("无法预览云端数据");
        return;
    }
    
    console.log("👁️ 开始预览云端数据");
    showSuccessMessage("正在加载云端数据...");
    
    db.collection('users').doc(currentUser.uid).get()
        .then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                console.log("✅ 云端数据预览:", data);
                
                // 备份本地数据
                const localBackup = {
                    favorites: [...favorites],
                    watchedVideos: JSON.parse(JSON.stringify(watchedVideos)),
                    channelsData: JSON.parse(JSON.stringify(channelsData))
                };
                
                // 保存备份到全局变量
                window.localDataBackup = localBackup;
                
                // 加载云端数据到界面显示
                if (data.favorites) {
                    favorites.splice(0, favorites.length, ...data.favorites);
                }
                
                if (data.watchedVideos) {
                    Object.keys(watchedVideos).forEach(key => delete watchedVideos[key]);
                    Object.assign(watchedVideos, data.watchedVideos);
                }
                
                if (data.ratings) {
                    data.ratings.forEach(rating => {
                        channelsData.forEach(category => {
                            category.channels.forEach(channel => {
                                if (channel.name === rating.name) {
                                    channel.rating = rating.rating;
                                }
                            });
                        });
                    });
                }
                
                // 重新渲染界面
                if (currentView === 'favorites') {
                    renderFavoritesPage();
                } else if (currentView === 'watched') {
                    renderWatchedVideosPage();
                } else {
                    renderChannels(channelsData);
                }
                
                updateFavoritesCount();
                updateWatchedCount();
                
                // 统计云端数据
                const cloudFavorites = data.favorites ? data.favorites.length : 0;
                const cloudRatings = data.ratings ? data.ratings.filter(r => r.rating > 0).length : 0;
                const cloudWatched = data.watchedVideos ? Object.values(data.watchedVideos).reduce((sum, videos) => sum + videos.length, 0) : 0;
                
                const previewMessage = `👁️ 预览模式已启用！\n\n` +
                    `📚 收藏频道：${cloudFavorites} 个\n` +
                    `⭐ 频道评分：${cloudRatings} 个\n` +
                    `📺 已看视频：${cloudWatched} 个\n\n` +
                    `💡 提示：\n` +
                    `• 当前显示云端数据\n` +
                    `• 新编辑会同步到云端\n` +
                    `• 本地数据已备份，不会丢失\n` +
                    `• 退出预览模式可恢复本地数据`;
                
                showSuccessMessage(previewMessage);
                
        // 设置预览模式标志
        window.isPreviewMode = true;
        
        // 显示退出预览按钮
        const exitPreviewBtn = document.getElementById('exitPreviewBtn');
        if (exitPreviewBtn) {
            exitPreviewBtn.style.display = 'inline-block';
        }
                
            } else {
                showSuccessMessage("云端暂无数据，本地数据保持不变");
            }
        })
        .catch((error) => {
            console.error("❌ 预览云端数据失败:", error);
            showErrorMessage("预览云端数据失败，请重试");
        });
}

// 退出预览模式 - 恢复本地数据
function exitPreviewMode() {
    if (!window.isPreviewMode || !window.localDataBackup) {
        showErrorMessage("当前不在预览模式");
        return;
    }
    
    console.log("🔄 退出预览模式，恢复本地数据");
    
    // 恢复本地数据
    const backup = window.localDataBackup;
    
    // 恢复收藏
    favorites.splice(0, favorites.length, ...backup.favorites);
    
    // 恢复已看视频
    Object.keys(watchedVideos).forEach(key => delete watchedVideos[key]);
    Object.assign(watchedVideos, backup.watchedVideos);
    
    // 恢复频道评分
    channelsData.splice(0, channelsData.length, ...backup.channelsData);
    
    // 重新渲染界面
    if (currentView === 'favorites') {
        renderFavoritesPage();
    } else if (currentView === 'watched') {
        renderWatchedVideosPage();
    } else {
        renderChannels(channelsData);
    }
    
    updateFavoritesCount();
    updateWatchedCount();
    
    // 清除预览模式标志
    window.isPreviewMode = false;
    window.localDataBackup = null;
    
    // 隐藏退出预览按钮
    const exitPreviewBtn = document.getElementById('exitPreviewBtn');
    if (exitPreviewBtn) {
        exitPreviewBtn.style.display = 'none';
    }
    
    showSuccessMessage("✅ 已退出预览模式，本地数据已恢复");
}

// 检查是否需要显示合并选择
function checkAndShowMergeChoice() {
    // 检查是否是页面刷新（避免刷新时弹出）
    const isPageRefresh = performance.navigation.type === 1 || 
                         performance.getEntriesByType('navigation')[0].type === 'reload';
    
    if (isPageRefresh) {
        console.log("📊 页面刷新，跳过合并选择检查");
        return;
    }
    
    // 检查是否有本地数据
    const hasLocalData = favorites.length > 0 || 
                        channelsData.flatMap(cat => cat.channels).some(c => c.rating > 0) ||
                        Object.values(watchedVideos).some(videos => videos.length > 0);
    
    if (!hasLocalData) {
        console.log("📊 无本地数据，无需合并选择");
        return;
    }
    
    // 检查是否已记住选择
    const savedStrategy = localStorage.getItem('mergeStrategy');
    if (savedStrategy) {
        console.log(`📊 使用已保存的合并策略: ${savedStrategy}`);
        chooseMergeStrategy(savedStrategy);
        return;
    }
    
    // 显示数据同步选择弹窗
    console.log("📊 显示数据同步选择弹窗");
    showMergeChoiceModal();
}

function logoutUser() {
    console.log("🚪 退出登录");
    
    // 显示确认对话框
    const confirmLogout = confirm("确定要退出登录吗？\n\n退出后：\n• 当前数据已保存到云端\n• 下次登录会恢复所有数据\n• 可以随时重新登录");
    
    if (!confirmLogout) {
        console.log("用户取消退出登录");
        return;
    }
    
    if (!firebaseInitialized || !auth) {
        console.log("Firebase 未初始化，直接隐藏用户信息");
        updateUserUI(null);
        showLoginModal();
        return;
    }
    
    // 先保存当前数据到云端
    if (currentUser) {
        saveDataToFirestore();
    }
    
    auth.signOut().then(() => {
        console.log("✅ 退出登录成功");
        updateUserUI(null);
        
        // 显示成功提示
        showSuccessMessage("已成功退出登录，数据已保存到云端");
    }).catch((error) => {
        console.error("❌ 退出登录失败:", error);
        showErrorMessage("退出登录失败，请重试");
    });
}

function showLoginModal() {
    console.log("🔧 显示登录弹窗");
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.style.display = 'flex';
    }
}

// 切换账号功能 - 显示账号切换弹窗
function switchAccount() {
    console.log("🔄 切换账号");
    
    if (!firebaseInitialized || !auth || !currentUser) {
        console.log("Firebase 未初始化或无当前用户，直接显示登录弹窗");
        showLoginModal();
        return;
    }
    
    // 先保存当前数据到云端
    if (currentUser) {
        saveDataToFirestore();
    }
    
    // 显示账号切换弹窗
    showSwitchAccountModal();
}

function hideLoginModal() {
    console.log("🔧 隐藏登录弹窗");
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
        loginModal.style.display = 'none';
    }
}

function showError(message) {
    const errorEl = document.getElementById('loginError');
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        setTimeout(() => {
            errorEl.style.display = 'none';
        }, 5000);
    }
}

// 显示成功消息
function showSuccessMessage(message) {
    showToast(message, 'success');
}

// 显示错误消息
function showErrorMessage(message) {
    showToast(message, 'error');
}

// 通用消息提示
function showToast(message, type = 'info') {
    // 创建消息提示元素
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        z-index: 1000000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    // 根据类型设置颜色
    if (type === 'success') {
        toast.style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        toast.style.backgroundColor = '#dc3545';
    } else {
        toast.style.backgroundColor = '#17a2b8';
    }
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    // 自动隐藏
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// ==================== 测试同步功能 ====================
function testFirebaseSync() {
    if (!currentUser || !db) {
        showErrorMessage("Firebase 未初始化或用户未登录");
        return;
    }
    
    console.log("🧪 开始测试 Firebase 同步");
    showSuccessMessage("正在测试 Firebase 同步...");
    
    // 测试写入数据
    const testData = {
        testMessage: "Firebase 同步测试",
        testTime: new Date().toISOString(),
        userEmail: currentUser.email,
        testId: Math.random().toString(36).substr(2, 9)
    };
    
    db.collection('test').doc(currentUser.uid).set(testData)
        .then(() => {
            console.log("✅ 测试数据写入成功");
            
            // 测试读取数据
            return db.collection('test').doc(currentUser.uid).get();
        })
        .then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                console.log("✅ 测试数据读取成功:", data);
                
                // 验证数据
                if (data.userEmail === currentUser.email) {
                    showSuccessMessage(`✅ Firebase 同步正常！\n邮箱: ${currentUser.email}\n测试ID: ${data.testId}`);
                } else {
                    showErrorMessage("❌ 数据验证失败");
                }
            } else {
                showErrorMessage("❌ 测试数据不存在");
            }
        })
        .catch((error) => {
            console.error("❌ Firebase 测试失败:", error);
            showErrorMessage(`❌ Firebase 测试失败: ${error.message}`);
        });
}

// ==================== 数据同步功能 ====================
function loadUserDataFromFirestore() {
    if (!currentUser || !db) return;
    
    console.log("📦 从 Firestore 加载用户数据");
    db.collection('users').doc(currentUser.uid).get()
        .then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                console.log("✅ 云端数据加载成功:", data);
                
                // 恢复收藏数据
                if (data.favorites && Array.isArray(data.favorites)) {
                    favorites.length = 0;
                    favorites.push(...data.favorites);
                    console.log(`✅ 已恢复 ${favorites.length} 个收藏频道`);
                }
                
                // 恢复评分数据
                if (data.ratings && Array.isArray(data.ratings)) {
                    data.ratings.forEach(rating => {
                        channelsData.forEach(category => {
                            category.channels.forEach(channel => {
                                if (channel.name === rating.name) {
                                    channel.rating = rating.rating;
                                }
                            });
                        });
                    });
                    console.log(`✅ 已恢复 ${data.ratings.length} 个频道评分`);
                }
                
                // 恢复已看视频数据
                if (data.watchedVideos) {
                    Object.assign(watchedVideos, data.watchedVideos);
                    const totalVideos = Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0);
                    console.log(`✅ 已恢复 ${Object.keys(watchedVideos).length} 个频道的 ${totalVideos} 个已看视频`);
                }
                
                // 更新UI
                if (typeof updateFavoritesCount === 'function') updateFavoritesCount();
                if (typeof updateWatchedCount === 'function') updateWatchedCount();
                if (typeof renderChannels === 'function') renderChannels(channelsData);
            } else {
                console.log("📝 用户数据不存在，将创建新文档");
                saveDataToFirestore();
            }
        })
        .catch((error) => {
            console.error("❌ 加载云端数据失败:", error);
        });
}

function saveDataToFirestore() {
    if (!currentUser || !db) return;
    
    console.log("💾 保存数据到 Firestore");
    const data = {
        favorites: favorites,
        ratings: channelsData.flatMap(category => 
            category.channels.map(channel => ({
                name: channel.name,
                rating: channel.rating || 0
            }))
        ),
        watchedVideos: watchedVideos,
        userEmail: currentUser.email,
        userDisplayName: currentUser.displayName || currentUser.email.split('@')[0],
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    db.collection('users').doc(currentUser.uid).set(data, { merge: true })
        .then(() => {
            console.log("✅ 数据已保存到云端");
            console.log("📊 保存的数据统计:", {
                favorites: favorites.length,
                ratings: data.ratings.filter(r => r.rating > 0).length,
                watchedVideos: Object.values(watchedVideos).reduce((sum, videos) => sum + videos.length, 0),
                userEmail: currentUser.email
            });
            
            // 更新最后同步时间显示
            const lastSyncTime = document.getElementById('lastSyncTime');
            if (lastSyncTime) {
                lastSyncTime.textContent = `最后同步：${new Date().toLocaleString()}`;
            }
            
            // 显示同步成功提示
            showSuccessMessage(`数据已同步到云端 (${currentUser.email})`);
        })
        .catch((error) => {
            console.error("❌ 保存数据失败:", error);
            showErrorMessage("数据同步失败，请检查网络连接");
        });
}

// ==================== 监听认证状态变化 ====================
if (auth) {
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log("👤 用户已登录:", user.email);
            updateUserUI(user);
            // 用户已登录，隐藏登录弹窗
            hideLoginModal();
        } else {
            console.log("👤 用户未登录");
            updateUserUI(null);
            // 用户未登录时，只在页面首次加载时显示登录弹窗
            // 不在这里自动显示，让用户主动点击"登录"按钮
        }
    });
    
    // 处理重定向登录结果
    auth.getRedirectResult()
        .then((result) => {
            if (result.credential) {
                console.log("✅ Google 重定向登录成功:", result.user.email);
                hideLoginModal();
                updateUserUI(result.user);
                
                // 重定向登录成功后显示数据同步选择
                setTimeout(() => {
                    const hasLocalData = favorites.length > 0 || 
                                        channelsData.flatMap(cat => cat.channels).some(c => c.rating > 0) ||
                                        Object.values(watchedVideos).some(videos => videos.length > 0);
                    
                    if (hasLocalData) {
                        showMergeChoiceModal();
                    } else {
                        loadUserDataFromFirestore();
                    }
                }, 1000);
            }
        })
        .catch((error) => {
            console.error("❌ 重定向登录结果处理失败:", error);
            if (error.code !== 'auth/operation-not-supported-in-this-environment') {
                showError('Google 登录失败，请重试');
            }
        });
}

// ==================== 页面加载完成后的初始化 ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log("📄 页面加载完成");
    
    // 确保所有弹窗在页面加载时都是隐藏的
    hideLoginModal();
    hideSwitchAccountModal();
    hideMergeChoiceModal();
    
    // 检查是否是首次访问（没有登录状态记录）
    const hasVisited = localStorage.getItem('hasVisited');
    if (!hasVisited) {
        // 首次访问，显示登录弹窗
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            loginModal.style.display = 'flex';
            console.log("🔧 首次访问，显示登录弹窗");
        }
        localStorage.setItem('hasVisited', 'true');
    } else {
        // 非首次访问，等待认证状态确定
        console.log("🔧 非首次访问，等待认证状态确定");
    }
    
    // 监听数据变化，自动保存到云端
    if (typeof saveAllData === 'function') {
        const originalSaveAllData = saveAllData;
        saveAllData = function() {
            originalSaveAllData();
            if (currentUser) {
                saveDataToFirestore();
            }
        };
    }
});
</script>
</body>
</html>
